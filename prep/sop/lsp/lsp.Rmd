---
title: 'OHI-Northeast: Lasting Special Places'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---

# Summary
This script creates two layers used for the Lasting Special Places subgoal:

1. Marine protected areas within state waters
2. Terrestrial protected areas within 1km of the coastline

The output layers are saved to `ne-scores/region/layers` for use in the Toolbox.

``` {r setup, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/', message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R')  ### an OHINE specific version of common.R

library(tidyverse)
library(sf)
library(mapview)
```


***

# Data Source 

We use the United States Geological Survey Protected Areas Database for the US. Version 2.0.

**Reference**: 
U.S. Geological Survey (USGS) Gap Analysis Project (GAP), 2018, Protected Areas Database of the United States (PAD-US): U.S. Geological Survey data release, https://doi.org/10.5066/P955KPLE.

**Downloaded**: June 5th, 2019

**Description**:  

**Time range**: Protected areas list established date back to early 1900's where available

**Format**:  Spatial Geodatabase


***
  
#Methods

## Load Data

Load our inland and offshore buffers.
```{r buffers}
#load buffers
inland_buffer <- read_sf("~/github/ne-prep/spatial/shapefiles/ohine_inland_1km.shp")
offshore_buffer <- rgns %>% filter(rgn_id > 4)
```

Let's look at the available layers in the USGS PADUS database

```{r look_at_gdb_layers}
st_layers(file.path(dir_anx, "_raw_data/USGS/PADUS2_0_GDB_Arc10x/PADUS2_0.gdb"))
```

After exploring the data descriptions we know we want all ecept the Proclamation layer. When I load these, I'm also cropping to our region to reduce object size.

```{r load_three_land_layers}
desig <- read_sf(dsn = file.path(dir_anx, "_raw_data/USGS/PADUS2_0_Shapefiles/PADUS2_0Designation.shp")) %>%
  st_transform(us_alb) %>%
  st_crop(rgns) %>%
  st_intersection(inland_buffer)

ease <- read_sf(dsn = file.path(dir_anx, "_raw_data/USGS/PADUS2_0_Shapefiles/PADUS2_0Easement.shp")) %>%
  st_transform(us_alb) %>%
  st_crop(rgns)  %>%
  st_intersection(inland_buffer)

#fee is causing geometry errors. so i filter just for our states first and the error goes away. The error must exist outside or region of interest
fee <- read_sf(dsn = file.path(dir_anx, "_raw_data/USGS/PADUS2_0_Shapefiles/PADUS2_0Fee.shp")) %>%
  filter(State_Nm %in% c("NY", "RI", "CT", "MA", "NH", "ME")) %>%
  st_transform(us_alb) %>%
  st_crop(rgns)  %>%
  st_intersection(inland_buffer)
```

For the marine layer, we are going to remove all areas that are designated as fishery/shellfish management areas as well as the Special Area Management Plans. 

```{r load_and_clean_marine_layer}
marine <- read_sf(dsn = file.path(dir_anx, "_raw_data/USGS/PADUS2_0_Shapefiles/PADUS2_0Marine.shp")) %>%
  st_transform(us_alb) %>%
  st_crop(rgns)  %>%
  st_intersection(offshore_buffer) %>%
  filter(!Loc_Ds %in% c("Fishery Management Area", "Closure Area", "Fishery Management Areas", "Shellfish Management Area", "Essential Fish Habitat Conservation Area", "Conservation Area", "Gear Restricted Area", "Special Area Management Plan"), #the Conservation Areas are for Mussel Seed
         !is.na(Loc_Ds),
         Constancy == "Year-round") #we only want to include places that are protected year round
```

Create and save an interactive .html map to show the different layers.
```{r interactive_map, eval = F}
usgs_data <- mapview(proc, col.regions = "red") + mapview(desig, col.regions = "yellow") + mapview(ease, col.regions = "green") + mapview(marine, col.regions = "blue") +mapview(fee, col.regions = "orange")

## save interactive map
mapshot(usgs_data, url = "usgs_map.html")
```


## Calculate total area protected

We want to know the proportion of area protected within each region. After visual inspection it looks like very little overlap between the marine and terrestrial shapefiles so rather than combining them using `st_union()` (takes a long time and makes a very large file) I will calculate the area of each separately then combine.


### Marine areas

First let's combine polygons so we don't double count areas. For example, multiple shipwrecks are included within the larger MA North Shore Sanctuary. 

All areas included in the Marine layer were established before our time period (or have NA for Date_Est) so we don't need to do this by year. 
```{r}
marine_protected_by_rgn <- marine %>%
  select(rgn_id, Date_Est, Loc_Ds, Loc_Nm) %>%
  mutate(rgn_id = ifelse(c(rgn_id == 11 & Loc_Nm == "Cape and Islands Ocean Sanctuary"), 8, rgn_id)) %>% #one sliver of Cape and Islands Ocean Sanctuary was being assigned to Rhode Island but is definitely MA
  group_by(rgn_id) %>%
  summarise() %>%
  ungroup() %>%
  mutate(area = st_area(geometry)/1000000) %>% #calculate total protected area
  left_join(rgn_data) %>%
  mutate(prop_area = as.numeric(area)/area_km2, #calculate proportion of state waters protected
         type = "marine",
         year = 2005) %>%
    st_set_geometry(NULL) %>% 
  uncount(13, .id = "n", .remove = F) %>%
  mutate(year = ifelse(n == 1, 2005, n + 2004)) %>%
  select(-n)
```

### Land

```{r}
#select the same columns from each of the three land layers
ease_clean <- ease %>%
  select(Loc_Ds, Loc_Nm, Date_Est, rgn_name, rgn_id)

fee_clean <- fee %>%
  select(Loc_Ds, Loc_Nm, Date_Est, rgn_name, rgn_id)

desig_clean <- desig %>%
  select(Loc_Ds, Loc_Nm, Date_Est, rgn_name, rgn_id)

#combine them into `land`

land <- ease_clean %>%
  rbind(fee_clean) %>%
  rbind(desig_clean) %>%
  unique() %>% #remove duplicates
  lwgeom::st_make_valid()
```

We do have years added so we need to take that into account, unlike with the Marine layer.
Importantly - a lot of areas have NA for date est. So we assume they have been established the entire time...

```{r calculate_land_protection}

land_protected_by_rgn <- data.frame()

for(i in 2005:2017){
  
  print(i)
  
  s_yr <- filter(land, Date_Est <= i | is.na(Date_Est)) %>% #all NA included as well
    group_by(rgn_id) %>%
    summarise() %>%
    ungroup() %>%
    mutate(prot_area_m = st_area(geometry)) %>% #calculate total protected area
    left_join(inland_buffer %>% st_set_geometry(NULL)) %>% #join to inland buffer 
    mutate(prop_area = prot_area_m/area, #calculate proportion of land in 1km region protected
           type = "land",
           year = i) %>%
    st_set_geometry(NULL)
  
  land_protected_by_rgn <- bind_rows(s_yr, land_protected_by_rgn)
}
```


# Results

```{r marine_protected_prop_by_rgn}
ggplot(marine_protected_by_rgn, aes(x = year, y = prop_area, color = rgn_name)) +
  geom_line() +
  theme_bw() +
  labs(y = "Proportion of State waters protected")
```

```{r land_protected_prop_by_rgn}
ggplot(land_protected_by_rgn, aes(x = year, y = prop_area, color = rgn_name)) +
  geom_line() +
  theme_bw() +
  labs(y = "Proportion of inland 1km protected")
```


# Save Layers

```{r save_to_layers}
#save land
write.csv(land_protected_by_rgn %>% select(rgn_id, year, prop_area), file = "~/github/ne-scores/region/layers/lsp_protected_land.csv")

#save marine
write.csv(marine_protected_by_rgn %>% select(rgn_id, year, prop_area), file = "~/github/ne-scores/region/layers/lsp_protected_marine.csv")
```






