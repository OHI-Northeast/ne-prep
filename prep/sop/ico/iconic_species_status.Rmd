---
title: 'OHI-Northeast: Iconic Species'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/', message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R')  ### an OHINE specific version of common.R
```

# Summary

This script creates the Iconic Species status data layer for use in the Sense of Place: Iconic Species subgoal. A list of 33 iconic species was created following input from multiple folks in the region. The Iconic Species status layer calculates the conservation status score (0 = extinct, 1 = least concern) for each of the iconic species. 

***

# Data Source

We use NatureServe and IUCN conservation status (aka extinction risk) information.

***
  

# Load Data

Load the list of our iconic species. This list was created manually through consultation with folks in the region about iconic Northeast species.

```{r load_list_of_species}
iconic_list <- read_csv("data/iconic_species_list.csv") %>%
  mutate(common = tolower(common),
         scientific = tolower(scientific))
```

Species range (i.e. where the species is found) and conservation status information comes from a layer in the Biodiversity - Species subgoal. The `spp_status_scores.csv` contains information about each species in our region, their conservation status and the associated score between 0 and 1 (where 0 is low extinction risk and 1 is extinct). `spp_rgns.csv` contains info on where each species is found within the Northeast. Both of these files are created in the `prep/bio/spp` folder and these two .csv's live in the `ne-scores` repository.

```{r get_spp_range_and_status}
species_status <- read_csv("~/github/ne-scores/region/layers/spp_status_scores.csv") %>% 
  select(-X1) %>%
  mutate(sciname = tolower(sciname))

species_rgns <- read_csv("~/github/ne-scores/region/layers/spp_rgns.csv") %>% select(-year)
```

Combine status and regions

```{r}
spp_status_rgns <- species_rgns %>%
    left_join(species_status, by = c("common", "sciname", "rgn_id")) %>%
    select(rgn_id, common, sciname, score, year)
```

Filter dataset just for iconic species

```{r}
#filter species status just for our iconic species
iconic_species_status1 <- spp_status_rgns %>%
  filter(common %in% iconic_list$common)

#filter based on scientific name
iconic_species_status2 <- spp_status_rgns %>%
  filter(tolower(sciname) %in% iconic_list$scientific)

#change "white shark" to "great white shark"
iconic_species_status <- iconic_species_status1 %>%
  bind_rows(iconic_species_status2) %>%
  distinct() %>%
  mutate(common = ifelse(common == "white shark", "great white shark", common),
    score = 1-score) %>% #the original scores from the SPP status are 0 (good) to 1 (bad/extinct). Here I reverse this so closer to 1 = better
  filter(!is.na(score)) 
``` 

Did we get all 33 species?
```{r}
unique(iconic_species_status$common)
```

We only have `r length(unique(iconic_species_status$common))` species in the `spp_status_scores` data. What are we missing?

```{r missing_spp}
missing <- setdiff(iconic_list$common, iconic_species_status$common)
missing
```

Most of the species we are missing are a harvested (commercially fished) species, except for Piping plover. We will use our stock scores for these species where available. The `nmfs_stock_scores.csv` dataset was created in the Seafood Provision - Wild-Caught Fisheries subgoal data prep.

```{r get_stock_scores_for_harvested_spp}
stock_scores <- read_csv("~/github/ne-prep/prep/fis/data/nmfs_stock_scores.csv") %>%
  select(year, stock, b_bmsy) %>%
  mutate(score = ifelse(b_bmsy >=1, 1, b_bmsy)) %>%
  separate(stock, into = c("common", "area"), sep = " - ") %>%
  filter(tolower(common) %in% missing) %>%
  select(common, score, year)

unique(stock_scores$common)
```

Only three of the species have stock assessments from NMFS that we can use as scores. So looks like we are missing american oyster, blue crab, bay scallop, soft shell clam, and quahog.

## Find where these species exist

We don't care about how big or small the species range map is, if a species exists within an OHI region we will count it there.

```{r}
fish_rgns <- species_rgns %>%
  filter(common %in% tolower(stock_scores$common))

fish_rgns
```

We only have sea scallop identified to regions within the Northeast. That means we are missing salmon and surfclam. For now let's assume they are everywhere. Combine `rgn_areas` with the scores

```{r}
salm_surf <- stock_scores %>%
  filter(common != "Sea scallop") %>%
  mutate(rgn_id = 1,
         common = tolower(common)) %>%
  group_by(common, score) %>%
  complete(rgn_id = 1:11, year) %>%
  mutate(sciname = case_when(
    common == "atlantic salmon" ~ "Salmo salar",
    common == "atlantic surfclam" ~ "Spissula solidissima"
  ))

#join the salmon and surfclam dataset with sea scallops
salm_surf_scallop <- stock_scores %>%
  mutate(common = tolower(common)) %>%
  filter(common == "sea scallop") %>%
  left_join(fish_rgns) %>%
  bind_rows(salm_surf)
```

## join them all
```{r}
spp_rgns_scores <- iconic_species_status %>%
  bind_rows(salm_surf_scallop)
```

# Results

We need to add all years even though we dont have any information that tells us status changes. So these scores will all be the same over the entire time period.

```{r iconic_spp_status_by_rgn, fig.width = 8, fig.height = 5}
ico_layer <- spp_rgns_scores %>%
  group_by(common, sciname, rgn_id, score) %>%
  complete(year = 2005:2017) %>%
  left_join(rgn_data)

ggplot(ico_layer, aes(x = year, y = score, color = common)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~rgn_name) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

plotly::ggplotly()
```

## Table 

Since we see no changes over time let's just look at 2017 in table form

```{r}
table_df <- ico_layer %>%
  filter(year == 2017) %>%
  select(common, sciname, rgn_name, score)

DT::datatable(table_df)

#save
write.csv(table_df, "data/table_ico_sp_status_by_rgn.csv")
```

Need to create a df for background of heat map so that missing values are not blank. DF below has every iconic species in every region

##MAYBE DELETE
```{r}

possible_sp <- table_df %>% 
  ungroup() %>% 
  select(common, sciname) %>% 
  distinct() %>% 
  uncount(11, .id = "n", .remove = F) %>% 
  mutate(as.numeric(n))

regions <- table_df %>% 
  ungroup() %>% 
  select(rgn_id, rgn_name) %>% 
  distinct() %>% 
  mutate( n = rgn_id)
  
heatmap_background <- left_join(possible_sp, regions, by = c("n")) %>% 
  select(common, sciname, rgn_id, rgn_name) 

```



##Heatmap
```{r}
#install.packages("viridis")
library(viridis)
#install.packages("plotly")
#library(plotly)


table_df2 <- table_df %>% 
  mutate(present = TRUE) %>% 
  right_join(heatmap_background, by = c("rgn_id", "rgn_name", "common", "sciname")) %>% 
  mutate(present = ifelse(is.na(present), FALSE, present)) %>% 
  group_by(common) %>% 
  mutate(av_score = mean(score, na.rm=TRUE)) %>% 
  ungroup() %>% 
  arrange( desc(av_score), common) %>% 
  mutate(rgn_name = as.factor(rgn_name)) %>% 
  transform(common = reorder(common, desc(av_score))) %>% 
  transform(id=as.numeric(factor(common))) %>% 
  transform(common = reorder(common, desc(id))) 


```



```{r}

ico_heatmap <- ggplot(data = table_df2, aes(x = rgn_name, y = common)) +
# geom_tile(fill ='grey90')  +
  geom_tile(aes(fill = score, alpha = present)) + 
  scale_fill_viridis(direction = -1, ) +
  scale_alpha_discrete(guide = 'none') +
  theme_dark()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_blank(),
        panel.grid =element_blank() )+
  coord_cartesian(expand=FALSE)
  
ico_heatmap

ggplotly(ico_heatmap)

#ggsave("figs/ico_heatmap.jpg", width=7, height=5, dpi=300)


```

```{r}

ico_heatmap_status <- ggplot(data = heatmap_data, aes(x = rgn_name, y = common)) +
# geom_tile(fill ='grey90')  +
  geom_tile(aes(fill = status, alpha = present)) + 
  scale_fill_viridis_d(direction = -1, ) +
  scale_alpha_discrete(guide = 'none') +
  theme_dark()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_blank(),
        panel.grid =element_blank() )+
  coord_cartesian(expand=FALSE)
  
ico_heatmap_status

ggplotly(ico_heatmap_status)

```




# Save layer to toolbox

```{r save}
write.csv(ico_layer, file = "~/github/ne-scores/region/layers/ico_scores.csv")
```



