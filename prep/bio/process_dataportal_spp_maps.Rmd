---
title: "Process NE Data Portal Species Rasters"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---

This script

```{r setup, include=FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R')
```


```{r}
spp_files <- list.files(file.path(dir_anx, "_raw_data/DUKE_NE_Data_Portal/OHI_PA_Data"), recursive = T, full.names = T) 

#we only want the .tifs
tifs <- spp_files[str_detect(spp_files, ".tif$")]
```

We have `r nrow(tifs)` maps provided by Duke for species maps on the Northeast Ocean Data Portal. Some of these are seasonal, so we need to combine them to create one map. For example *Witch flounder*:

```{r}

witch_flounder <- tifs[str_detect(tifs, "Witch_flounder")] %>%
  stack()

plot(witch_flounder)

```

These don't look that different but just to be safe we need to combine them

```{r}
#pull out all species maps that have either "FALL" or "SPRING"
seasonal_maps <- data.frame(file = tifs[str_detect(tifs, "FALL|SPRING")]) 

#these are all fish so we can use the same file path patterns to grab individual species names
species <- seasonal_maps %>% 
  mutate(species = str_split(file, pattern = '_' ),
         species1 = map(species, c(11)),
         species2 = map(species, c(12)),
         species3 = map(species, c(13))) %>%
  select(-file, -species) %>%
  mutate(full_name = ifelse(species2 %in% c("FALL.tif", "SPRING.tif"), species1,
                            ifelse(species3 %in% c("FALL.tif", "SPRING.tif"), paste(species1, species2, sep = "_"), 
                                   paste(species1, species2, species3, sep = "_")))) %>%
  select(full_name) %>%
  unique()
```

This function takes each species raster file, combines the two seasonal ones to create a single range map, then rasterizes to the CRS and cell resolution for the OHI Northeast analysis.

```{r}

f <- function(sp){
  
  sp_files <- tifs[str_detect(tifs, sp)]
  
  if(length(sp_files) == 1){
    
     s <- raster(sp_files[1])
     
  }else{
    
    #combine the two rasters
    s <- raster(sp_files[1]) + raster(sp_files[2])
  
  }
  
  #now we rasterize to 1km2 and our projection
  sp_rast <- s %>%
    projectRaster(crs = crs(ocean_ne)) %>%
    resample(ocean_ne, method = "ngb")
  
  #assign all cells that aren't 0 a value of 1
  sp_rast[sp_rast!=0]   <- 1
  sp_rast[sp_rast == 0] <- NA
  
  #save raster
  writeRaster(sp_rast, filename = paste0(dir_anx, "/bio/portal_spp_rasters/", sp, ".tif"), overwrite = TRUE)
  
}

map(species$full_name, f)

```


Now we need to adjust the raster CRS and resolution for the remaining species maps

```{r}

# get the other maps (non fish)
other_maps <- data.frame(file = tifs[!str_detect(tifs, "FALL|SPRING")])

non_fish_spp <- other_maps %>% 
  mutate(a = str_split(file, pattern = '/' ),
         b = map(a, c(11))) %>%
  select(-file, -a) %>%
  mutate(name = substr(b, 13, nchar(b)-4)) %>%
  select(name)

f <- function(sp){
  
  sp_files <- tifs[str_detect(tifs, sp)]

  s <- raster(sp_files[1])
     
  #now we rasterize to 1km2 and our projection
  sp_rast <- s %>%
    projectRaster(crs = crs(ocean_ne), method = "ngb") 
  extent(sp_rast) <- extent(ocean_ne)
  sp_rast <- raster:: resample(sp_rast, ocean_ne, method = "ngb")
  
  #assign all cells that have a 0 and NA
  sp_rast[sp_rast == 0] <- NA
  
  #save raster
  writeRaster(sp_rast, filename = paste0(dir_anx, "/bio/portal_spp_rasters/", sp, ".tif"), overwrite = TRUE)
  
}

map(non_fish_spp$name, f)

```


Link each species to cellIDs

```{r}

cellid_rast <- raster("~/github/ne-prep/spatial/ocean_rasters/ne_cellids.tif")

#dataframe that links cellIDs with the OHI region they are in
rgn_cells <- read.csv("~/github/ne-prep/spatial/rgn_cellids.csv") %>%
  select(-X)

files <- list.files(file.path(dir_anx, "bio/portal_spp_rasters"), full.names = T)

## this function maps each species presence/absence raster and overlays the cellIDs to return a dataframe of cellIDs where the species is found, and a column with SID (species ID)
cellid_extract <- function(file){
  # update the progress bar (tick()) and print progress (print())
  pb$tick()$print()
  #get SID (species ID)
  sp <- substr(file, 58, nchar(file)-4)
  df <- data.frame(pres = 1, sp = sp)
  
  #read in raster
  r <- raster(file)
  
  #use the raster::zonal() function to get a dataframe that contains cellids and SID as two columns
  z <- zonal(r, cellid_rast, na.rm=T) %>%
    as.data.frame() %>%
    filter(!is.na(mean)) %>%
    rename(cellID = zone) %>%
    mutate(species = sp) %>%
    inner_join(rgn_cells) %>%
    select(-mean)
}

pb <- progress_estimated(length(files)) #progress bar

sid_cells <- purrr::map_df(files, cellid_extract)
```


We need to link these species up with the associated SID from IUCN. In the `ne_spp` data we list what species have NE portal maps. 

```{r}
#list of IUCN species with rangemaps that are found in the OHI Northeast region
ne_spp <- read_csv("data/iucn_spp_in_ne.csv") %>%
  filter(neportal == 1) 

#lets also pull in the regional status data which gives status information for species in the ne data portal
ne_sp_status<- readxl::read_excel(file.path(dir_anx, "_raw_data/species/KLW_ES_Data_gaps_Northeast_species_list_9.29.16.xlsx"),
                                       sheet = "all species",
                                       skip = 1) %>%
  select(common = `Species - common name`, 
         status = `E, T, SC`) %>%
  filter(!is.na(status))

```

Ok there are `r nrow(ne_sp_status)` species with a local status. We should assign regions and scores to each of these species.

```{r}
ne_dataportal_sp_rgns_scores <- ne_sp_status %>%
  separate(col = status, into = c("states", "status1", "status2"), sep = ";") %>%
  separate(col = states, into = c("state1", "stat"), sep = "[(]") %>%
  separate(col = status1, into = c("state2", "stat2"), sep = "[(]") %>%
  separate(col = status2, into = c("state3", "stat3"), sep = "[(]") 

#create three separate dfs and work within them
df1 <- ne_dataportal_sp_rgns_scores %>%
  select(common, state1, stat) %>%
  mutate(status = str_remove(.$stat, "[)]")) %>%
  separate(state1, into = c("state1", "state2", "state3", "state4", "state5", "state6"), sep = " ") %>%
  select(-stat) %>%
  gather(-common, -status, key = delete, value = state) %>%
  select(-delete) %>%
  mutate(state = str_remove(.$state, ",")) %>%
  filter(!state %in% c("", NA))


df2 <- ne_dataportal_sp_rgns_scores %>%
  select(common, state = state2, stat2) %>%
  mutate(status = str_remove(.$stat2, "[)]")) %>%
  separate(state, into = c("state1", "state2", "state3"), sep = " ") %>%
  select(-stat2) %>%
  gather(-common, -status, key = delete, value = state) %>%
  select(-delete) %>%
  mutate(state = str_remove(.$state, ",")) %>%
  filter(!state %in% c("", NA))


df3 <- ne_dataportal_sp_rgns_scores %>%
  select(common, state = state3, stat3) %>%
  filter(!is.na(state)) %>%
  mutate(status = str_remove(.$stat3, "[)]")) %>%
  select(-stat3) 

full_df <- bind_rows(df1, df2, df3)

```











