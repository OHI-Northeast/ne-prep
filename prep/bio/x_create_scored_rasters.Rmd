---
title: "Create species risk rasters"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---

# Summary

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
source('~/github/ne-prep/src/R/common.R')
```

# Get data

Get list of the species we are using, from both IUCN and the NE Data Portal. Also get the species status

```{r}
#ne dataportal rasters
ne_rasters <- list.files(file.path(dir_anx, "bio/portal_spp_rasters"))

#iucn rasters
iucn_rasters <- list.files(file.path(dir_anx, "bio/spp_presence_rasters"), full.names = T)
```

The names in the iucn_rasters list only have the sid. So we need to figure out what species we have in the IUCN list that is also in the data portal list by linking sids.

```{r}
#list of iucn species in northeast. This containts the iucn_sid column.
iucn_ne_spp <- read_csv("data/1_iucn_spp_in_ne.csv") %>%
  select(iucn_sid, common, sciname) %>%
  mutate(common = tolower(common))
```

```{r}
#get data portal species
ne_spp <- data.frame(filepath = ne_rasters) %>%
  mutate(name = sub(".tif", "", filepath),
         common = gsub("_", " ", name),
         common_name = tolower(gsub("normalized", "", common))) %>%
  select(common_name) %>%
  mutate(source = "dataportal")
```

These are just common names. Let's add scientific names where possible
```{r}
library(taxize)

sci_names <- c()
for(i in 9:nrow(ne_spp)){ #i <- 1
  sp <- ne_spp[i,1]
  sci <- comm2sci(sp, db = "worms")
  
sci_names <- c(sci_names, sci)
}

#turn list into dataframe
df <- do.call(rbind,lapply(sci_names,data.frame))
df$common <- rownames(df)

df2 <- df %>%
  rename(sciname = X..i..) %>%
  mutate(common = str_extract(common, "[^.]+")) %>% #remove numbers
  distinct() %>%
  group_by(common) %>%
  mutate(n = n()) %>%
  ungroup() %>%
  mutate(sci_fix = case_when( #fixing a couple manually that have multiple scinames
    common == "atlantic sturgeon" ~ "Acipenser oxyrinchus",
    common == "alewife" ~ "Alosa pseudoharengus",
    common == "atlantic cod" ~ "Gadus morhua",
    common == "black sea bass" ~ "Centropristis striata",
    common == "bluefish" ~ "Pomatomus saltatrix",
    common == "bluntnose stingray" ~ "Dasyatis say",
    common == "butterfish" ~ "Peprilus triacanthus",
    common == "fourspot flounder" ~ "Hippoglossina oblonga",
    common == "goosefish" ~ "Lophius americanus",
    common == "horseshoe crab" ~ "Limulus polyphemus",
    common == "ocean pout" ~ "Zoarces americanus",
    common == "pigfish" ~ "Orthopristis chrysoptera",
    common == "silver hake" ~ "Merluccius bilinearis",
    common == "striped bass" ~ "Morone saxatilis",
    TRUE ~ as.character(sciname)
  )) %>%
  select(common, sciname = sci_fix) %>%
  distinct() %>% #This only gives us scientific names for 88 of the portal species. so we can do a full join to get the rest back
  full_join(ne_spp, by = c("common" = "common_name"))
```


Join the IUCN and NE to better identify which species are in both so we can prioritize the NE data portal maps for those.
```{r}
j <- iucn_ne_spp %>%
  left_join(df2, by = "common") %>%
  left_join(df2, by = c("sciname.x" = "sciname")) %>%
  mutate(common = ifelse(is.na(common.y), common.x, common.y),
         sciname = ifelse(is.na(sciname.y), sciname.x, sciname.y),
         source = ifelse(is.na(source.y), "IUCN", "dataportal")) %>%
  select(common, sciname, source)
```

There are `r nrow(j%>%filter(source == "dataportal"))` data portal species that are also in the IUCN dataset. But we are missing the portal maps that are not also in IUCN (`r nrow(df2) -nrow(j%>%filter(source == "dataportal"))` species).

```{r}
species_df <- df2 %>%
  bind_rows(j) %>%
  distinct()
```


Next step is to create a large dataframe that lists each species, what map source we will use for the species, the status and the geographic location of that status (e.g. some states have different statuses for the same species)

```{r}

large_df <- j %>%
  mutate(source = ifelse(is.na(source), "IUCN", "dataportal"))

```







