---
title: 'OHI-Northeast: Mariculture Production Layer'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 5, fig.height = 5, fig.path = 'figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)


source('~/github/ne-prep/src/R/common.R')  ### an OHINE specific version of common.R

dir_git <- '~/github/ne-prep'
dir_anx <- file.path(dir_M, 'git-annex/neprep')

library(tidyverse)
```

# Summary

This script creates the mariculture production (i.e. amount produced) layer.

***

## Data cleaning
```{r production}
#load data
data <- read_csv("data/production.csv", 
                 col_names = FALSE)

#set row 3 as column names
colnames(data) <- data[3,]

#change column names. We have two Pounds columns. I'm differentiating by adding a 2 to the second one, and then fix this a couple rows down
colnames(data) <- c("Year", "Region", "Species", "Tons", "Individuals", "Bags", "Bushels", "Pieces", "Pounds", "Value", "Source ID", NA, "Pounds", "Tons conversion")

#remove first three rows
data <- data[4:nrow(data),1:10]

#some weird characters in the Tons column
data$Tons <- gsub("~","", data$Tons)
data$Tons <- gsub(" \\+", "", data$Tons)

#convert character to numeric. Clean up species names and convert tons to pounds
data_clean <- data %>%
  mutate(Tons = as.numeric(Tons),
         Individuals = as.numeric(gsub(",","", Individuals)),
         Bags = as.numeric(gsub(",","", Bags)),
         Bushels = as.numeric(gsub(",", "", Bushels)),
         Pieces  = as.numeric(gsub(",", "", Pieces)),
         Pounds  = as.numeric(gsub(",", "", Pounds))) %>%
  mutate(species = 
           case_when(
             Species == "American Oyster" ~ "Oysters",
             Species == "Eastern Oyster" ~ "Oysters",
             Species == "bay scallops" ~ "Scallops",
             Species == "soft shell clams" ~ "Soft Shell Clams"
           )) %>%
  mutate(Species_name_to_use = ifelse(is.na(species), Species, species),
         pounds = Tons*2000,
         Pounds = ifelse(is.na(Pounds), pounds, Pounds)) %>%
  filter(!is.na(Year)) #there are two records for CT where there is no year..
```

Let's filter out data that only has value information. Not sure how we will use this yet.

```{r value_only}

value_only <- data_clean %>%
  filter(!is.na(Value) & is.na(Tons) & is.na(Individuals) & is.na(Bags) & is.na(Bushels) & is.na(Pieces) & is.na(Pounds))

#remove these rows from data_clean
data_clean <- setdiff(data_clean, value_only)
```

What species does not have tons or pounds information?

```{r no_tons_or_lbs}
miss_lbs <- data_clean %>%
  filter(is.na(Pounds))

unique(miss_lbs$Species_name_to_use)
```

What if we try to separate by species.

```{r}
#load the weight conversion table
conv <- read.csv("data/weight_conversion_table.csv")

# try to make this a function?
spp <- unique(conv$Species)

convert_to_pounds <- function(sp) {
sp_conv <- filter(conv, Species == sp)
  
  out <- data_clean %>%
  filter(Species_name_to_use == sp) %>%
  mutate(pounds = 
           case_when(
             !is.na(Individuals) ~ Individuals/sp_conv$Individual,
             !is.na(Bags) ~ Bags/sp_conv$Bag,
             !is.na(Bushels) ~ Bushels/sp_conv$Bushel,
             !is.na(Pounds) ~ Pounds,
             !is.na(Pieces) ~ Pieces/sp_conv$Individual
           )) %>%
    select(Year, Region, Species, Species_name_to_use, pounds)
  
  return(out)
}

hclam <- convert_to_pounds("Hard Clam")
oyster <- convert_to_pounds("Oysters")
quahog <- convert_to_pounds("Quahog")
scallop <- convert_to_pounds("Scallops")
ss_clams <- convert_to_pounds("Soft Shell Clams")
clams <- convert_to_pounds("Clams")

combo <- bind_rows(hclam, oyster, quahog, scallop, ss_clams, clams)
```

Due to weird data reporting, we need to fix Maine's finfish. The `maine_finfish.csv` dataset is used to replace all finfish from Maine.

```{r}
#read in the Maine finfish data
maine_ff <- read_csv("data/maine_finfish.csv") %>%
  rename(pounds = `Whole Pounds`)

remaining_sp <- data_clean %>%
    filter(!is.na(pounds)) %>%
    select(Year, Region, Species, Species_name_to_use, pounds) 

production_df <- full_join(combo, remaining_sp) %>%
    mutate(Year = as.numeric(Year)) %>%
    filter(!Species_name_to_use %in% c("Atlantic Salmon and Trout", "Atlantic Salmon", "Shellfish", "Mussels, clams, quahogs, and other shellfish (not including oysters)")) %>%
    select(Year, Region, Species = Species_name_to_use, pounds) %>%
  bind_rows(maine_ff)
```


```{r prod_by_species, fig.width = 8, fig.height = 6}

ggplot(production_df, aes(x = Year, y = pounds, color = Species)) +
  geom_line() +
  theme_bw() +
  ylab("Production (pounds)") +
  facet_wrap(~Region, scales = "free") +
  theme(legend.position = "bottom",
        legend.title=element_blank())
```

## Weight by sustainability scores

```{r prod_weighted_by_sust_scores}
#sustainability scores from Seafood Watch
sust_scores <- read_csv("data/species_sust_scores.csv") 

weighted_prod <- production_df %>%
  left_join(sust_scores, by = c("Species" = "species")) %>%
  mutate(sustainabilityscore = 
           ifelse(Species %in% c("Clams", "Quahog"), 7.01, sustainabilityscore), #assign the same sust score for Hard Clam to Clams and Quahog
         weight_prod = pounds * sustainabilityscore) %>%
  group_by(Year, Region) %>%
  summarize(total_prod = sum(weight_prod))


ggplot(weighted_prod, aes(x = Year, y = total_prod, color = Region)) +
  geom_line() +
  theme_bw()
```

## Calculate annual growth rates

```{r prod_growth_rate, fig.width = 6, fig.height = 4}

gr <- weighted_prod %>%
  group_by(Region) %>%
  mutate(last_years_prod = lag(total_prod, n = 1),
         growth = total_prod/last_years_prod) %>%
  filter(Year > 2004)

ggplot(gr, aes(x = Year, y = growth, color = Region)) +
  geom_line() +
  geom_hline(yintercept = 1, color = "black") +
  theme_bw() +
  facet_wrap(~Region) +
  labs(y = "Growth rate (above 1 indicates increase)")

```

## Score

Compare the growth rate to a target of a 4% annual growth rate

```{r mar_status_by_rgn}

target <- 1.04 #4% growth rate target

score_mar <- gr %>%
  mutate(score = growth/target,
         final_score = 
           case_when(
             score >= 1 ~ 100,
             score < 1 ~ score*100
             ))

ggplot(score_mar, aes(x = Year, y = final_score, color = Region)) +
  geom_line() +
  theme_bw()

```











