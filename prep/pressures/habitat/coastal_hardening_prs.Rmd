---
title: 'OHI-Northeast: Mariculture Production Layer'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R')  ### an OHINE specific version of common.R

dir_git <- '~/github/ne-prep'
dir_anx <- file.path(dir_M, 'git-annex/neprep')

library(tidyverse)
library(mapview)
```

#Data Source 

**Reference**: NOAA [Environmental Sensitivity Index](https://response.restoration.noaa.gov/maps-and-spatial-data/download-esi-maps-and-gis-data.html)

**Downloaded**: August, 2019

**Description**:  Spatial point data identifying biological and human use resources. 

**Native data resolution**: Point data

**Time range**: NA. There are datasets from different time periods between 2001 and 2016 but we combine all datasets as a single representative layer, therefore the time does not play a role in the final coastal access layer.

**Format**:  Geodatabase/shapefile/point file

***


# Load Data

This script uses the same methods for calcualting coastal hardening as https://esajournals.onlinelibrary.wiley.com/doi/full/10.1890/150065

Since we are unsure if the data used in the paper above is the most recent, we will replicate and compare the %hardened for MA

Massachusetts:
```{r ma_shape}
ma_shape <- rgns %>%
  filter(state_name == "Massachusetts") %>%
  select(rgn_name, rgn_id)
```


What are the layer names
```{r layer_names}
st_layers(dsn=file.path(dir_anx, "_raw_data/NOAA_ESI/Mass_RhodeIsland_2016_GDB/MA_RI_ESI_2016.gdb"))
```


Load in the 2016 data
```{r load_esi_ma2016}
ma_2016_nav <- st_read(dsn=file.path(dir_anx, "_raw_data/NOAA_ESI/Mass_RhodeIsland_2016_GDB/MA_RI_ESI_2016.gdb"), layer = "ESIL") %>%
  st_transform(us_alb) %>% 
  st_intersection(ma_shape) %>%  
  mutate(GENERALIZED_ESI_TYPE = as.character(GENERALIZED_ESI_TYPE)) %>% 
  select(GENERALIZED_ESI_TYPE, rgn_name, rgn_id) %>% 
  mutate(year = 2016)

ma_2016 <- ma_2016_nav

mapview(ma_2016)
```

Load in the 2001 data
```{r load_esi_ma2001}
ma_2001 <- st_read(dsn=file.path(dir_anx, "_raw_data/NOAA_ESI/Mass_2001_Shapefiles/SHAPE/ESIL.SHP")) %>% 
  st_set_crs("+init=epsg:4269") %>%
  st_transform(us_alb) %>%
  st_intersection(ma_shape) 
```

This file was copied from the paper supplement. It is the table for ESI code descriptions
```{r load_esi_codes}
esi_codes <- read_csv(file.path(dir_git, "prep/pressures/habitat/data/esi_shoreline_classification.csv")) %>% 
  rename(code = esi_code)
```

Create df with the codes. We will need to remember to merge lines that over lap when we do total coastline km. This is because some stretch of coastline had multiple codes associated with it. This is fine because we simply want to know if some type of armoring is there or not 
```{r}
ma_2001_codes <- ma_2001 %>% 
  select(ESI, rgn_name, rgn_id) %>%
  mutate(year = 2001) %>% 
  separate(ESI, c("code_1", "code_2", "code_3"), sep = "/") %>% 
  gather(key = "code_num", code, c("code_1", "code_2", "code_3"), na.rm= TRUE) %>% 
  left_join(esi_codes, by = c("code"))
```

Calculate total armored coastline and total coastline

These code are realted to coastal hardening
8C = sheltered riprap
6B = riprap, boulder rubble
6D = riprap, boulder rubble
1B = exposed, solid, man-made structures
8B = sheltered, solid, man-made structures


```{r}
ma_armored <- ma_2001_codes %>% 
  filter(code %in% c("8C", "6B", "6D", "1B", "8B")) %>% 
  mutate(length = st_length(geometry)) ## how to remove overlapping lines?

mapview(ma_armored)
```







