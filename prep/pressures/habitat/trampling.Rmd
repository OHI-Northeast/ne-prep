---
title: 'OHI-Northeast: Trampling Pressure Data Prep'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
toc: true
---

# Summary
 
This code calculates the effects of beach trampling using the average population density along the coast as a proxy.

# Data

GeoTiff files were downloaded from https://sedac.ciesin.columbia.edu/data/set/usgrid-summary-file1-2010/metadata
Octover 15th 2019

The data is at 1km2 resolution. Since we are only looking at total population that means #people/km2

citation:
Center for International Earth Science Information Network - CIESIN - Columbia University. 2017. U.S. Census Grids (Summary File 1), 2010. Palisades, NY: NASA Socioeconomic Data and Applications Center (SEDAC). https://doi.org/10.7927/H40Z716C. Accessed DAY MONTH YEAR. 

# Methods

## Setup

``` {r setup, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 10, fig.height = 8, fig.path = 'figs/', message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R')  ### an OHI-NE specific version of common.R

library(tidyverse)
library(ggplot2)
library(raster)
library(rgdal)
library(gdalUtils)
library(fasterize)

dir_git <- '~/github/ne-prep'
dir_anx <- file.path(dir_M, 'git-annex/neprep')
```


Read in the population tif files for each state, and then create one NE raster
```{r tif_files}
## read in all states rasters
northeast_rasters <- c(file.path(dir_anx, "_raw_data/USGS/usgrid_data_2010/geotiff/nypop10.tif"),
                    file.path(dir_anx, "_raw_data/USGS/usgrid_data_2010/geotiff/mepop10.tif"),
                    file.path(dir_anx, "_raw_data/USGS/usgrid_data_2010/geotiff/nhpop10.tif"),
                    file.path(dir_anx, "_raw_data/USGS/usgrid_data_2010/geotiff/ctpop10.tif"),
                    file.path(dir_anx, "_raw_data/USGS/usgrid_data_2010/geotiff/ripop10.tif"),
                    file.path(dir_anx, "_raw_data/USGS/usgrid_data_2010/geotiff/mapop10.tif"))

## combine all tif files into one 
mosaic_rasters(gdalfile = northeast_rasters, dst_dataset = file.path(dir_anx, "prs_hab/northeast.tif"), of = "GTiff")

## create one ne raster
northeast_rast <- raster::raster(file.path(dir_anx, "prs_hab/northeast.tif")) %>%
  projectRaster(crs = us_alb, progress="text") 

## check it out!
plot(northeast_rast)

ne_vals <-northeast_rast%>% 
  getValues() %>%
  na.omit() 

hist(ne_vals)
```


We are creating a coastal buffer that includes our coastline and 25 miles inland. 
```{r create_buffer}
## create a buffer 1 km along all state waters to get the beaches
buffer_1km_coastal <-  read_sf("~/github/ne-prep/spatial/shapefiles/state_waters.shp")  %>% 
  st_transform(us_alb) %>% 
  st_buffer(40233.6) %>%  ## data in meters; using a 25 miles buffer
  st_union() %>% 
  st_as_sf() 

plot(buffer_1km_coastal)

## create blank raster for rasterizing
r <- raster(crs = us_alb, ne_ext, res = 1000)
r[r] <- 1

## convert to a raster
buffer_rast <- fasterize(buffer_1km_coastal, r) %>% 
  raster::resample(northeast_rast, method = "ngb") ## match the resolution and extent
# the extent cuts off the top part of the buffer because that's out of Maine

plot(buffer_rast)
```

Now we want to keep only the population density data that falls into our 25 miles within the coastline raster
```{r crop_area}
## keep only the areas 1km along the shorelines
ne_pop_coast <- northeast_rast %>% 
 raster::mask(buffer_rast) %>% 
 calc(fun = function(x){ifelse(x < 0, 0, x)})  ## there are 3 negative numbers in this data for some reason (-77.9399, -0.2386,	-0.0178)

plot(ne_pop_coast)
summary(ne_pop_coast) # The max value is very large, this is because of NYC
```

Need to figure out how to create a shapefile/raster with the states where N/S MA is divided.
```{r zones_raster}
## we want a raster with the region names so that we can ID the regions. This is the only file I found wiht the state land, and not just water, and it doesn't have have N/S MA. ask Jamie
ne_states_zone <- ne_states %>% 
  filter(NAME %in% c("Maine", "New York", "Rhode Island", "Connecticut", "New Hampshire", "Massachusetts")) %>%
  rename(state = NAME) %>% 
  mutate(zone = case_when(
    state == "Maine" ~ "6" , 
    state == "New Hampshire" ~ "9", 
    state == "Massachusetts" ~ "7",
    state == "Rhode Island" ~ "11",
    state == "Connecticut" ~ "5",
    state == "New York" ~ "10"),
    zone = as.numeric(zone)) %>% 
  select(zone, state)
      
      
ne_states_rast <- fasterize(ne_states_zone, r, field = "zone") %>% 
  raster::resample(northeast_rast, method = "ngb") %>% ## match the resolution
  mask(buffer_rast)

plot(ne_states_rast)
```

Extract data for each region
```{r extract_data}
# extract data for each region:
pop_stats <- zonal(ne_pop_coast, ne_states_rast, fun="mean", na.rm=TRUE, progress="text")

pop_stats_2 <- data.frame(pop_stats) %>% 
  rename(rgn_id = zone,
         avg_ppl_km2 = mean)
```

Calculate reference point
We are using the reference point of 99.99% quantile. While this number is still high (because of NYC), it is an actually population density where people have survived
```{r calc_ref_point}
vals <- ne_pop_coast %>% 
  getValues() %>%
  na.omit() 

hist(vals) ## very skewed

max <- max(vals) #38719
ref_1 <- quantile(vals, 0.9999) #26188
ref_2 <- quantile(vals, 0.999) # 16199
ref_3 <- quantile(vals, 0.99) # 3582
ref_4 <- quantile(vals, 0.5) #28.3  
```

Calculate presssure scores
```{r calc_scores}
prs_trampling <-pop_stats_2 %>% 
  mutate(ref = ref_1,
         score_av = avg_ppl_km2/ref)
prs_trampling
```









