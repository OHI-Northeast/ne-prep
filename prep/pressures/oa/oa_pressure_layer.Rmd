---
title: 'OHI-Northeast: Ocean Acidification Pressure Layer'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: yes
    fig_caption: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohi-northeast/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---

# Summary

This script calculates the ocean acidification pressure score.

# Data:

1. East Coast Ocean Acidification Product Suite https://www.coral.noaa.gov/accrete/east-coast-oaps.html

We have downloaded aragonite data from the site. 

Time frame: 2014-2017

The data is downloaded as seperate NetCDF files for each year. Each file has one variable (OmegaAr) with three dimensions (lat, long, and time). The unit for time is months since Janurary 2014 (0-11), but when we convert this data into an array later the month dimesions "turns in" the normal 1-12 because it counting the number of data sets for that dimension.

Since we do not have historic data, I used the global 1980-1989 aragonite mean file as a base/reference. This is likely not accurate if the data is different, so we would need to figure out a new baseline/ reference point. 

Equation for calculating aragonite satuation change:
$$\Delta \Omega_{year} = \frac{(\Omega_{base} - \Omega_{year})}{(\Omega_{base} - 1)}$$

Note that current is subtracted from the baseline; this way, a reduction in $\Omega$ becomes a positive pressure value. It is then normalized by the current mean state; so a decrease in $\Omega$ while the current state is high indicates less pressure than the same decrease when the current state is near 1. 

$\Delta \Omega_{year}$ is then modified to account for increases in aragonite saturation state (pressure = 0) and arag sat state less than 1 (pressure = 1).

# Methods

## Setup (libraries and loading data)

The main R libraries needed for this analysis are the `raster`, and `ncdf4` packages.
``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 8, fig.height = 6, fig.path = 'figs/', message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R') ### an OHINE specific version of common.R

#libraries

library(raster)
library(ncdf4)
library(maps)
library(RColorBrewer)
library(googleVis)
library(maps)
library(parallel)
library(foreach)
library(doParallel)
library(fasterize)
library(rasterVis)
library(here)
library(raster)
library(gstat)

#define paths for the raw data and OA folder held on git-annex on our NCEAS server, Mazu
raw_dir     = file.path(dir_M,'git-annex/neprep/_raw_data')
glob_dir    = file.path(dir_M,'git-annex/globalprep/prs_oa')
ne_dir  = file.path(dir_M,'git-annex/neprep/prs_oa')

cols      = colorRampPalette(brewer.pal(9, 'Spectral'))(255) # rainbow color scheme
```
  

*Helpful website for using NetCDF files http://geog.uoregon.edu/bartlein/courses/geog607/Rmd/netCDF_01.htm*

We need to extract the arrays individually from each year and then convert into a raster file. If we end up using this data I want to figure out how to make this a loop fo future ease of additional years of data.
```{r creating_arays}
## read in the files for each year
nc_2014 = nc_open(file.path(raw_dir,'NOAA_OA/omega_Ar_East_Coast_2014.nc'))
nc_2015 = nc_open(file.path(raw_dir,'NOAA_OA/omega_Ar_East_Coast_2015.nc'))
nc_2016 = nc_open(file.path(raw_dir,'NOAA_OA/omega_Ar_East_Coast_2016.nc'))
nc_2017 = nc_open(file.path(raw_dir,'NOAA_OA/omega_Ar_East_Coast_2017.nc'))
  
## grab the lat and longs; only need to do this once because the lats and longs are the same for every year
lat <- ncvar_get(nc_2014,varid='lat')
long <- ncvar_get(nc_2014,varid='lon')

## Need to grab the fill value ie: the value used when no data is avaliable so. it is -999 for 2014 and -32767 for 2015-2017
fillvalue_2014 <- ncatt_get(nc_2014, "OmegaAr", "_FillValue")
fillvalue_2015 <- ncatt_get(nc_2015, "OmegaAr", "_FillValue")
fillvalue_2016 <- ncatt_get(nc_2016, "OmegaAr", "_FillValue")
fillvalue_2017 <- ncatt_get(nc_2017, "OmegaAr", "_FillValue")

## create an array from the netcdf file for each year
oa.array_2014 <- ncvar_get(nc_2014, "OmegaAr")
oa.array_2015 <- ncvar_get(nc_2015, "OmegaAr")
oa.array_2016 <- ncvar_get(nc_2016, "OmegaAr")
oa.array_2017 <- ncvar_get(nc_2017, "OmegaAr")

# close each net cdf file
nc_close(nc_2014)
nc_close(nc_2015)
nc_close(nc_2016)
nc_close(nc_2017)

# Replace the fill values in each year with NAs
oa.array_2014[oa.array_2014 == fillvalue_2014$value] <- NA
oa.array_2015[oa.array_2015 == fillvalue_2015$value] <- NA
oa.array_2016[oa.array_2016 == fillvalue_2016$value] <- NA
oa.array_2017[oa.array_2017 == fillvalue_2017$value] <- NA
```

The following code:
1. Rasterizes the monthly data
2. Reprojects, crops, resamples, and interpolates using nearest neighbor
3. Saves as monthly tiff files

Need to do this for each year

2014
```{r rastering_monthly_2014}
registerDoParallel(6)

  foreach(month = c(1:12))  %dopar% {
  
  #month = 12
  
  slice <- oa.array_2014[, , month] 
  
  r <- raster(t(slice), xmn=min(long), xmx=max(long), ymn=min(lat), ymx=max(lat), crs=CRS(p4s_wgs84)) %>% 
  flip(direction = 'y') %>%
  projectRaster(crs = us_alb, over = FALSE, progress="text") %>% 
  raster::crop(ne_ext) %>% 
  raster::resample(zones, method = "ngb") %>% 
    writeRaster(filename = sprintf("%s/int/noaa_monthly/v2014/noaa_2014month_%s.tif", file.path(dir_anx, "prs_oa"), month), 
                overwrite = TRUE)
  }
```


## Results nearest neighbor for 2014 just to look (had also done idw interpolation, but chose this one.)
```{r gif_results}
library(animation)

monthly_2014 <- list.files(file.path(dir_anx, 'prs_oa/int/noaa_monthly/v2014'), full.names = T) %>%stack()
                         
names(monthly_2014) <- paste0("2014_month_", substr(names(monthly_2014),12, 13))

animation::saveGIF({
  for(i in 1:nlayers(monthly_2014)){
     plot(ocean_ne,col='cornsilk2',  main=names(monthly_2014[[i]]),axes=F,legend=F)
      # don't forget to fix the zlimits
    plot(monthly_2014[[i]], zlim=c(0,2.3),axes=F, col=cols, add=T) 
      
  }
}, movie.name = 'oa_monthly_2014_nn.gif')
```

2015
```{r rastering_monthly_2015}
registerDoParallel(6)

  foreach(month = c(1:12))  %dopar% {
  
  #month = 12
  
  slice <- oa.array_2015[, , month] 
  
  r <- raster(t(slice), xmn=min(long), xmx=max(long), ymn=min(lat), ymx=max(lat), crs=CRS(p4s_wgs84)) %>% 
  flip(direction = 'y') %>%
  projectRaster(crs = us_alb, over = FALSE, progress="text") %>% 
  raster::crop(ne_ext) %>% 
  raster::resample(zones, method = "ngb") %>% 
    writeRaster(filename = sprintf("%s/int/noaa_monthly/v2015/noaa_2015month_%s.tif", file.path(dir_anx, "prs_oa"), month), 
                overwrite = TRUE)
  }
```

2016
```{r rastering_monthly_2016}
registerDoParallel(6)

  foreach(month = c(01:12))  %dopar% {
  
  #month = 12
  
  slice <- oa.array_2016[, , month] 
  
  r <- raster(t(slice), xmn=min(long), xmx=max(long), ymn=min(lat), ymx=max(lat), crs=CRS(p4s_wgs84)) %>% 
  flip(direction = 'y') %>%
  projectRaster(crs = us_alb, over = FALSE, progress="text") %>% 
  raster::crop(ne_ext) %>% 
  raster::resample(zones, method = "ngb") %>% 
    writeRaster(filename = sprintf("%s/int/noaa_monthly/v2016/noaa_2016month_%s.tif", file.path(dir_anx, "prs_oa"), month), 
                overwrite = TRUE)
  }
```

2017
```{r rastering_monthly_2017}
registerDoParallel(6)

  foreach(month = c(1:12))  %dopar% {
  
  #month = 12
  
  slice <- oa.array_2017[, , month] 
  
  r <- raster(t(slice), xmn=min(long), xmx=max(long), ymn=min(lat), ymx=max(lat), crs=CRS(p4s_wgs84)) %>% 
  flip(direction = 'y') %>%
  projectRaster(crs = us_alb, over = FALSE, progress="text") %>% 
  raster::crop(ne_ext) %>% 
  raster::resample(zones, method = "ngb") %>% 
    writeRaster(filename = sprintf("%s/int/noaa_monthly/v2017/noaa_2017month_%s.tif", file.path(dir_anx, "prs_oa"), month), 
                overwrite = TRUE)
  }
```

Now that we have all the monthly files as tiff files and in the right projection and extent we can calulate an annual arag saturation.

First we need to load and save all the files
```{r read_in_monthly_files}
monthly_files <- c(list.files(file.path(dir_anx, "prs_oa/int/noaa_monthly/v2014"),
                       full.names = TRUE),
              list.files(file.path(dir_anx, "prs_oa/int/noaa_monthly/v2015"),
                       full.names = TRUE),
              list.files(file.path(dir_anx, "prs_oa/int/noaa_monthly/v2016"),
                       full.names = TRUE),
              list.files(file.path(dir_anx, "prs_oa/int/noaa_monthly/v2017"),
                       full.names = TRUE))
```

## Historical Mean

The historical mean for aragonite saturation state from 1880 - 1889 was calculated for OHI 2015. We are taking this raster, cropping to our region, and reprojecting it. This raster will be used as a reference point.

```{r hist_mean}
hist_global <- raster(file.path(dir_M,'git-annex/globalprep/prs_oa/v2015/working/global_oa_1880_1889_arag_mean_moll.tif'))

plot(hist_global,main='Mean Ωaragonite 1880-1889', col=rev(cols), box=F,axes=F)

hist <- hist_global %>%
  projectRaster(crs = us_alb, over = FALSE, progress="text") %>% 
  raster::crop(ne_ext) %>% 
  raster::resample(zones, method = "ngb")

plot(hist)
```

## Calculate Annual Means

```{r calculate_annual_means}
maxyr <- substr(monthly_files, 60, 63) %>% 
  as.numeric() %>% 
  max()

## stack all rasters for this year, and calc annual mean, then write as raster
registerDoParallel(6)
foreach(yr = c(2014:maxyr)) %dopar% {
  
  files <- monthly_files[str_detect(monthly_files, as.character(yr))]
  
  rast_annual_mean <- stack(files) %>%
    calc(mean, na.rm = TRUE) %>%
    writeRaster(filename = sprintf("%s/int/noaa_annual_mean/oa_annual_%s.tif", file.path(dir_anx, "prs_oa"), yr), 
                overwrite = TRUE)
}
```

Visualzing Actual concentrations of Arg
```{r}
# interpolate
registerDoParallel(24)

files <- list.files(file.path(dir_anx,'prs_oa/int/noaa_annual_mean'), full.names=TRUE)

foreach(file = files) %dopar%{

  #file = files[1]
  r  <- raster(file) #oa raster
  yr <- substr(file, nchar(file)-7, nchar(file)-4)
  xy <- data.frame(xyFromCell(r, 1:ncell(r))) #get xy coords into dataframe
  v  <- getValues(r)                          # get cell values
  tmpdf <- cbind(xy, v)%>%
    filter(!is.na(v))  #create dataframe of x,y, and values. remove NAs (throws error since these are cells we are interpolating over)
  
  mg <- gstat(id = "v", formula = v~1, locations = ~x+y, data=tmpdf,
            nmax=7, set=list(idp = 2)) #define model.
  z <- interpolate(r, mg, progress='text')                            #interpolate across NA cells

  writeRaster(z, filename=paste0(dir_anx, '/prs_oa/int/noaa_annual_int/Aragonite_Concentration_', yr, ".tif"),overwrite=TRUE)
}

files <- list.files(file.path(dir_anx,'prs_oa/int/noaa_annual_int'), full.names=TRUE)

#mask
registerDoParallel(24)

foreach(file = files)%dopar% {

  yr <- substr(file,nchar(file)-7,nchar(file)-4)
  cat(yr)
  x <- raster(file)%>%
  raster::resample(zones, method = 'ngb')%>%
  raster::mask(zones)
       
  writeRaster(x, filename = paste0(dir_anx, '/prs_oa/int/noaa_annual_int/Aragonite_Concentration_', yr, ".tif"), overwrite=TRUE)
}

library(animation)

oa_layers <- list.files(file.path(dir_anx, 'prs_oa/int/noaa_annual_int'), full.names = T) %>%stack()
                         
#names(oa_layers) <- paste0("Aragonite_Concentration_", substr(names(oa_layers),25, 28))

animation::saveGIF({
  for(i in 1:nlayers(oa_layers)){
     plot(ocean_ne,col='cornsilk2',  main=names(oa_layers[[i]]),axes=F,legend=F)
      # don't forget to fix the zlimits, zlim=c(-0.5,3)
    plot(oa_layers[[i]],zlim=c(0,3), axes=F, col=cols, add=T) 
      
  }
}, movie.name = 'Aragonite_Concentration.gif')
```


## Rescale from 0 to 1

The `oaRescale` function rescales each of the annual rasters. If the current value is less than or equal to 1, it is set to 1, otherwise the value is calculated from the above equation.

*Using the function from global to calculate*
```{r rescale,eval=F}
#for each layer, all values <=1 are assigned a 1, otherwise old-new/(old-1)
oaRescale <- function(file){
  
  yr   = substr(file, nchar(file)-7, nchar(file)-4)  #get year of file
  mean = raster(file)                              #get seasonal mean aragonite raster for given year
  diff = (hist-mean)/(hist-1)
  mean[mean<=1] <- 1                                 #all values at or less than 1 are given a value of 1
  mean[mean>1] <- diff[mean>1]                     #all cells with values greater than 1 are swapped out with their amount of change scaled to how close to 1 
  mean[mean<0] <- 0                                  #all values less than 0 (indicating a decrease in acidity) are capped at 0
    writeRaster(mean, filename=paste0(dir_anx, '/prs_oa/int/noaa_rescaled/oa_rescaled_', yr, sep=""), format='GTiff', overwrite=TRUE)
}

files = c(list.files(file.path(dir_anx, "prs_oa/int/noaa_annual_mean"), full.names=TRUE))
mclapply(files, oaRescale, mc.cores = 16)
```

Now we want to interpolate using the nearest neighbor technique. We are using the nearest neighbor technique to interpolate
```{r interpolate_noaa} 
#register parallel cores

registerDoParallel(24)

files <- list.files(file.path(dir_anx,'prs_oa/int/noaa_rescaled'), full.names=TRUE)

foreach(file = files) %dopar%{

  #file = files[1]
  r  <- raster(file) #oa raster
  yr <- substr(file, nchar(file)-7, nchar(file)-4)
  xy <- data.frame(xyFromCell(r, 1:ncell(r))) #get xy coords into dataframe
  v  <- getValues(r)                          # get cell values
  tmpdf <- cbind(xy, v)%>%
    filter(!is.na(v))  #create dataframe of x,y, and values. remove NAs (throws error since these are cells we are interpolating over)
  
  mg <- gstat(id = "v", formula = v~1, locations = ~x+y, data=tmpdf,
            nmax=7, set=list(idp = 2)) #define model.
  z <- interpolate(r, mg, progress='text')                            #interpolate across NA cells

  writeRaster(z, filename=paste0(dir_anx, '/prs_oa/int/noaa_rescaled_int/oa_rescaled_int_', yr, ".tif"),overwrite=TRUE)
}
```

Next we are going to resample and mask the raster
```{r}
files <- list.files(file.path(dir_anx,'prs_oa/int/noaa_rescaled_int'), full.names=TRUE)

registerDoParallel(24)

foreach(file = files)%dopar% {

  yr <- substr(file,nchar(file)-7,nchar(file)-4)
  cat(yr)
  x <- raster(file)%>%
  raster::resample(zones, method = 'ngb')%>%
  raster::mask(zones)
       
  writeRaster(x, filename = paste0(dir_anx, '/prs_oa/output/new/oa_prs_layer_', yr, ".tif"), overwrite=TRUE)
}
```

## Results
Create a gif using the new data 2014-2017
```{r gif_results_newdata}
library(animation)

oa_layers <- list.files(file.path(dir_anx, 'prs_oa/output/new'), full.names = T) %>%stack()
                         
names(oa_layers) <- paste0("OA_Pressure_Score_", substr(names(oa_layers),14, 17))

animation::saveGIF({
  for(i in 1:nlayers(oa_layers)){
     plot(ocean_ne,col='cornsilk2',  main=names(oa_layers[[i]]),axes=F,legend=F)
      # don't forget to fix the zlimits
    plot(oa_layers[[i]], zlim=c(0,1),axes=F, col=cols, add=T) 
      
  }
}, movie.name = 'OA_Pressures_scores.gif')
```



## Rescale from 0 to 1

This pressure layer is rescaled so that all values lie between 0 and 1. This is done by first setting all values at or below 1 to 1. Since all values under 1 represent undersaturated waters, this threshold is set equal to our highest pressure value (1). For cell values that are not yet at the threshold of 1, the values are rescaled by comparing their current value with their historcal values.

The baseline aragonite saturation state $\Omega_{base}$ is represented by the decadal average from 1880-1889.

### Historical Mean

The historical mean &#937 aragonite saturation state from 1880 - 1889 was calculated for OHI 2015. The same raster is used here for comparison.

```{r histMean}

hist <- raster(file.path(dir_M,'git-annex/globalprep/prs_oa/v2015/working/global_oa_1880_1889_arag_mean_moll.tif'))

plot(hist,main='Mean Ωaragonite 1880-1889', col=cols, box=F,axes=F)

```


Deviation from aragonite saturation state is determined for each year in the study period using this equation:

$$\Delta \Omega_{year} = \frac{(\Omega_{base} - \Omega_{year})}{(\Omega_{base} - 1)}$$

Note that the current value is subtracted from the baseline; this way, a reduction in $\Omega$ becomes a positive pressure value.  It is then normalized by the current mean state; so a decrease in $\Omega$ while the current state is high indicates less pressure than the same decrease when the current state is near 1. 

$\Delta \Omega_{year}$ is then modified to account for increases in aragonite saturation state (pressure = 0) and arag sat state less than 1 (pressure = 1).

The `oaRescale` function rescales each of the annual rasters. If the current value is less than or equal to 1, it is set to 1, otherwise the value is calculated from the above equation.

```{r rescale}

#Get 2011-2015 rasters

#calling past years data, need to double check that what I am actually doing is hte right information, the file strucutre changed this past year
#files = c(list.files(file.path(oagit_dir,'v2015/working/annualmean_2005-2014/moll'),full.names = T)[7:10],file.path(oagit_dir,'v2016/int/global_arag_avg_moll_2015.tif'))

files = c(list.files(file.path(dir_M,'git-annex/globalprep/prs_oa/v2017/int/annual_avg_moll'),full.names = T)[7:10])


#for each layer, all values <=1 are assigned a 1, otherwise old-new/(old-1)

oaRescale <- function(file){
  
  yr   = substr(file,nchar(file)-7,nchar(file)-4)  #get year of file
  mean = raster(file)                              #get seasonal mean aragonite raster for given year
  diff = (hist-mean)/(hist-1)
  mean[mean<=1]<-1                                 #all values at or less than 1 are given a value of 1
  mean[mean>1] <- diff[mean>1]                     #all cells with values greater than 1 are swapped out with their amount of change scaled to how close to 1 
  mean[mean<0]<-0                                  #all values less than 0 (indicating a decrease in acidity) are capped at 0

    writeRaster(mean,filename=paste0(oagit_dir,'/v2016/int/annual_oa_rescaled/oa_rescaled_',yr,sep=""),format='GTiff',overwrite=T)

}

#  sapply(files,oaRescale)

  rescaled = list.files(file.path(dir_M,'git-annex/globalprep/prs_oa/v2017/int/annual_avg_moll_rescaled'),full.names=T)
```

```{r plot rescale}
r <- raster(rescaled[59])
plot(r,col=cols,box=F,axes=F, main = 'Rescaled Ωaragonite layer for 2016')
```


## Interpolate

Since there are oceanic cells with no information in the raw data, we need to fill in these gaps. We do this by interpolating across the globe using the data we have. Unfortunately there is not an easy and quick way to do this in R so this was done using arcpy from ArcGIS via a python script you can find [here](https://github.com/OHI-Science/ohiprep/blob/master/globalprep/prs_oa/v2016/OA_interpolation.py).


```{r interpolate}

int_files <- list.files(file.path(dir_M,'git-annex/globalprep/prs_oa/v2017/int/annual_avg_moll_rescaled_int'),full.names=T)

#something weird is happening here, land is not croped out
plot(raster(int_files[5]),col=cols,box=F,axes=F,main='Rescaled and Interpolated Ωaragonite layer for 2016')

```


## Resample

All pressure layers need to be resampled to 1km cell resolution. We have a template ocean raster with cells at this resolution that we use to resample all pressure layers. You won't see any difference between the plot above and this one since we are using the nearest neighbor method when resampling which maintains the original cell value for each of resampled cell.

```{r resample}

#ocean is a raster with all land clipped out - at 1km with value of 1. This is used as a mask
ocean = raster(file.path(dir_M,'git-annex/globalprep/prs_oa/v2016/int/ocean.tif'))

resample = function(file){
  
        yr  = substr(file,91,94)
        r   = raster(file)%>%raster::resample(ocean,method='ngb',progress='text') # resample r to the resolution of 'ocean' (~1km)
    
       writeRaster(r,filename=paste0(dir_M,'git-annex/globalprep/v2016/int/annual_oa_rescaled_int_1km/annual_oa_rescaled_int_1km_',yr,sep=''),format='GTiff',overwrite=T)
}

#sapply(int_files,resample)

resampled = list.files(file.path(dir_M,'git-annex/globalprep/prs_oa/v2016/int/annual_oa_rescaled_int_1km'),full.names=T)

plot(raster(resampled[5]),col=cols,box=F,axes=F,main='Resampled, rescaled and interpolated \nΩaragonite layer for 2015')

```


# Final Pressure Layers 

## Landmask

Now that we have 1km, rescaled and inteprolated raster layers we want to remove the land and extra cell values. We can use the `mask` function from the `raster` package to do this using our ocean raster.

```{r mask}

rm_land <- function(file){
  yr = substr(file,110,113)
  r  = raster(file)%>%
          mask(ocean,filename=paste0(oagit_dir,'/v2016/output/oa_prs_layer_',yr,sep=''),format='GTiff',overwrite=T)
}

#sapply(resampled,rm_land)

r <- raster(file.path(oagit_dir,'v2016/output/oa_prs_layer_2015.tif'))
plot(r,box=F,axes=F,col=cols,main='Final Ocean Acidification \nPressure Layer 2015')

```


# Gap-fill raster layer

We want to create a raster layer that shows all cells that were gap-filled. Since they were the same cells interpolated across all years, we only need to create one raster.

```{r,eval=F}

    #Rescaled data before interpolation 

      r = raster(file.path(oagit_dir,'v2016/int/annual_oa_rescaled/oa_rescaled_2011.tif'))%>%
          resample(ocean)

    #after interpolation,

      r_int = raster(file.path(oagit_dir,'v2016/output/oa_prs_layer_2015.tif'))


    interp_cells = mask(r_int,r,inverse=TRUE,filename = file.path(oagit_dir,'v2016/output/oa_interpolated_cells.tif'))
```

```{r}
    plot(raster(file.path(oagit_dir,'v2016/output/oa_interpolated_cells.tif')),
         col=cols,box=F,axes=F,main='Interpolated cells')

```


#Citation information  

Woods Hole Oceanographic Institution. 2014 update to data originally published in: Feely, R.A., S.C. Doney, and
S.R. Cooley. 2009. Ocean acidification: Present conditions and future changes in a high-CO2 world.
Oceanography 22(4):36–47

