---
title: 'OHI-Northeast: OA Data Comparisons'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: yes
    fig_caption: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohi-northeast/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---

#Summary

This script takes the raw netCDF data and does the following:

   a. Calculates the annual mean for each of the 5 years in 2011-2015 (5 raster layers as output)  
   - change this to 2012-2017; but why 5 years? are these the historic years? look to see if the data starts in 2011, and if so calcualte the mean for 2011-2017?
   - basically figure out if the global method of baseline is what we want to do
   
   b. Rescales each annual raster layer from 0 to 1 based on a biological threshold (&#937; <= 1) and the proportional change compared to a historical mean
   c. Interpolates the data to gap-fill for cells where there is no data
   d. Resamples the rescaled raster layer to 1km cell resolution
   e. Mask the resampled data to select only those cells within the ocean
  

#Updates from previous assessment

Added one more year of data (2015) and rescaled values greater than 1 based on how close the value is to the threshold of 1. This was done by using the following equation:
- were not adding, we are doing the whole thing from stratch. see if the global way of adding includes past files

$$\Delta \Omega_{year} = \frac{(\Omega_{base} - \Omega_{year})}{(\Omega_{base} - 1)}$$

Note that current is subtracted from the baseline; this way, a reduction in $\Omega$ becomes a positive pressure value. It is then normalized by the current mean state; so a decrease in $\Omega$ while the current state is high indicates less pressure than the same decrease when the current state is near 1. 

$\Delta \Omega_{year}$ is then modified to account for increases in aragonite saturation state (pressure = 0) and arag sat state less than 1 (pressure = 1).

***

#Data Source

- I only changed a few of these below

**Reference**: [Feely et al.(2009)](https://darchive.mblwhoilibrary.org/bitstream/handle/1912/3180/22-4_feely.pdf?sequence=1&isAllowed=y)
- we have a new data source : https://www.coral.noaa.gov/accrete/east-coast-oaps.html

**Downloaded**: September 12, 2019

**Description**:  Aragonite Saturation State  $\Omega_{arg}$

**Native data resolution**: 1 degree cells

**Time range**: 1880-1889 and 2005-2015, monthly data provided for each year

**Format**:  NetCDF

  
**Notes about the data**:  


***

# Methods


##Setup  

The main R libraries needed for this analysis are the `raster`, and `ncdf4` packages.
``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 8, fig.height = 6, fig.path = 'figs/', message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R') ### an OHINE specific version of common.R

#libraries

library(raster)
library(ncdf4)
library(maps)
library(RColorBrewer)
library(googleVis)
library(maps)
library(parallel)
library(foreach)
library(doParallel)
library(fasterize)
library(rasterVis)
library(here)
library(raster)

#define paths for the raw data and OA folder held on git-annex on our NCEAS server, Mazu
raw_dir     = file.path(dir_M,'git-annex/neprep/_raw_data')
glob_dir    = file.path(dir_M,'git-annex/globalprep/prs_oa')
ne_dir  = file.path(dir_M,'git-annex/neprep/prs_oa')

cols      = colorRampPalette(brewer.pal(9, 'Spectral'))(255) # rainbow color scheme
```
  
## Load raw data  

New NOAA data
figure out how to write a loop to rasterize all files we have and then reproject and resample and add the coastline? make gif of the years 2014-2017

Here we are assuming that the file is the mean, below I explor other packages to try and pull the monthly data out to make sure this assumption is correct
```{r}
nc_files <- c(list.files(file.path(raw_dir,'NOAA_OA'),
                       full.names = TRUE, pattern = ".nc"))
```

A peak into what the data looks like.
Is this an annual mean? Find the meta data for it
the .nc file says has monthly .nc files in the global attributes history so it makes me think that its annual mean
```{r explore}
plot(raster(nc_files[4]), col = cols, axes = F)
```

Rasterize the annual oa means
Change the projection to us_albers
Resample
(no mask unlike slr, we care about what's happening OA wise offshore)

```{r rasterize_annual}
#three_nm <- raster(file.path(dir_git, "spatial/ocean_rasters/rast_3nm_mask.tif"))

registerDoParallel(10)


foreach(file = nc_files) %dopar% {
  
#  file = nc_files[1]
  
  yr <- substr(file, 73, 76) 
  
  #ocean_ne_repro <- projectRaster(ocean_ne, crs = us_alb, over = FALSE, progress="text") #uns
  
  ## read in month raster
  r <- raster(file) %>%
    projectRaster(crs = us_alb, over = FALSE, progress="text") %>% 
    raster::resample(ocean_ne, method = "ngb", 
             filename = sprintf("%s/prs_oa/int/noaa/oa_annual_noaa_%s.tif", 
                                dir_anx, yr), overwrite = TRUE) %>% 
    raster::crop(ocean_ne) %>% 
    mask(ocean_ne, filename = sprintf("%s/prs_oa/int/noaa_reprojected/oa_annual_noaa_repro_%s.tif", 
                                dir_anx, yr), overwrite = TRUE)


}

plot(raster(file.path(dir_anx, "prs_oa/int/noaa/oa_annual_noaa_2014.tif")))
```



Global Data

```{r,message=FALSE,warning=FALSE,eval=FALSE}

## getting aragonite data from https://catalog.data.gov/dataset/aragonite-saturation-state-calculated-from-ocean-station-data-with-dissolved-inorganic-carbon-d

nc_old = nc_open(file.path(dir_M,'git-annex/globalprep/_raw_data/WHOI/cesm_co2sys_1958-2016.1x1d.nc'))
#the only variables in this file are "PH"   "OARG" "OCAL"

print(nc_old)

nc_05 = nc_open(file.path(dir_M,'git-annex/globalprep/_raw_data/WHOI/annual/cesm_co2sys_2005.nc'))

names(nc_05$var) # names for lat/long are different, so double check
#variables here are "TLAT"         "TLONG"        "PH"           "OARG"         "OCAL"         "ECOSYS_IFRAC"

# longitude values are stored in the variable 'TLONG'

      long <- ncvar_get(nc,varid='Longitude')

# latitude values are stored in the variable 'TLAT'

      lat <- ncvar_get(nc,varid='Latitude')
```


## Reading in each file and parsing out the monthly data

http://geog.uoregon.edu/bartlein/courses/geog607/Rmd/netCDF_01.htm


Creating a list with all the names of the NetCDF files we want to read in later
```{r read_in_NetCDF_files}
nc_files <- c(list.files(file.path(dir_anx,"_raw_data/NOAA_OA")),
                       full.names = TRUE, pattern = ".nc")

nc_files <- nc_files[1:4] 
```


```{r,message=FALSE,warning=FALSE,eval=FALSE}

## getting aragonite data from https://www.coral.noaa.gov/accrete/east-coast-oaps.html

nc = nc_open(file.path(raw_dir,'NOAA_OA/omega_Ar_East_Coast_2014.nc'))
  
names(nc$var) # only variable name here is OmegaAr
print(nc) #lat long are stored in the dimensions: 3 dims (time, lat, lon)

#grab the lat and longs
lat <- ncvar_get(nc,varid='lat')
long <- ncvar_get(nc,varid='lon')

# get the time variable and units
time <- ncvar_get(nc,varid='time')
tunits <- ncatt_get(nc, "time", "units")

# get arg variable
arg <- ncvar_get(nc,varid='OmegaAr')

dname <-  "OmegaAr"
oa.array_2014 <- ncvar_get(nc, dname)
dlname <- ncatt_get(nc, dname, "long_name")
dunits <- ncatt_get(nc, dname, "units")
fillvalue <- ncatt_get(nc, dname, "_FillValue")

history <- ncatt_get(nc, 0, "history")

nc_close(nc_new)

oa.array_2014[oa.array_2014 == fillvalue$value] <- NA
```


```{r}
registerDoParallel(6)

  foreach(month = c(1:12))  %dopar% {
  
  #month = 12
  
  slice <- oa.array[, , month] 
  
  r <- raster(t(slice), xmn=min(long), xmx=max(long), ymn=min(lat), ymx=max(lat), crs=CRS(p4s_wgs84)) %>% 
  flip(direction = 'y') %>%
  projectRaster(crs = us_alb, over = FALSE, progress="text") %>% 
  raster::crop(ne_ext) %>% 
  raster::resample(three_nm, method = "ngb") %>% 
   # mask(three_nm) %>% 
    writeRaster(filename = sprintf("%s/int/noaa_monthly_raw/noaa_month_%s.tif", file.path(dir_anx, "prs_oa"), month), 
                overwrite = TRUE)
  }
  
  plot(r)
```




###Results
```{r gif_results}
library(animation)

monthly_2014 <- list.files(file.path(dir_anx, 'prs_oa/int/noaa_monthly_raw'), full.names = T) %>%stack()
                         
names(monthly_2014) <- paste0("2014_month_", substr(names(monthly_2014),12, 13))

animation::saveGIF({
  for(i in 1:nlayers(monthly_2014)){
     plot(ocean_ne,col='cornsilk2',  main=names(monthly_2014[[i]]),axes=F,legend=F)
      # don't forget to fix the zlimits
    plot(monthly_2014[[i]], zlim=c(0,1), axes=F, col=cols, add=T)
      
  }
}, movie.name = 'oa_monthly_2014.gif')
```



