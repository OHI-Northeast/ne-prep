---
title: 'OHI-Northeast: OA Data Comparisons'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: yes
    fig_caption: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohi-northeast/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---

#Summary

This script takes the raw netCDF data and does the following:

   a. Calculates the annual mean for each of the 5 years in 2011-2015 (5 raster layers as output)  
   - change this to 2012-2017; but why 5 years? are these the historic years? look to see if the data starts in 2011, and if so calcualte the mean for 2011-2017?
   - basically figure out if the global method of baseline is what we want to do
   
   b. Rescales each annual raster layer from 0 to 1 based on a biological threshold (&#937; <= 1) and the proportional change compared to a historical mean
   c. Interpolates the data to gap-fill for cells where there is no data
   d. Resamples the rescaled raster layer to 1km cell resolution
   e. Mask the resampled data to select only those cells within the ocean
  

#Updates from previous assessment

Added one more year of data (2015) and rescaled values greater than 1 based on how close the value is to the threshold of 1. This was done by using the following equation:
- were not adding, we are doing the whole thing from stratch. see if the global way of adding includes past files

$$\Delta \Omega_{year} = \frac{(\Omega_{base} - \Omega_{year})}{(\Omega_{base} - 1)}$$

Note that current is subtracted from the baseline; this way, a reduction in $\Omega$ becomes a positive pressure value. It is then normalized by the current mean state; so a decrease in $\Omega$ while the current state is high indicates less pressure than the same decrease when the current state is near 1. 

$\Delta \Omega_{year}$ is then modified to account for increases in aragonite saturation state (pressure = 0) and arag sat state less than 1 (pressure = 1).

***

#Data Source

- I only changed a few of these below

**Reference**: [Feely et al.(2009)](https://darchive.mblwhoilibrary.org/bitstream/handle/1912/3180/22-4_feely.pdf?sequence=1&isAllowed=y)
- we have a new data source : https://www.coral.noaa.gov/accrete/east-coast-oaps.html

**Downloaded**: September 12, 2019

**Description**:  Aragonite Saturation State  $\Omega_{arg}$

**Native data resolution**: 1 degree cells

**Time range**: 1880-1889 and 2005-2015, monthly data provided for each year

**Format**:  NetCDF

  
**Notes about the data**:  


***

# Methods


##Setup  

The main R libraries needed for this analysis are the `raster`, and `ncdf4` packages.
``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 8, fig.height = 6, fig.path = 'figs/', message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R') ### an OHINE specific version of common.R

#libraries

library(raster)
library(ncdf4)
library(maps)
library(RColorBrewer)
library(googleVis)
library(maps)
library(parallel)
library(foreach)
library(doParallel)
library(fasterize)
library(rasterVis)
library(here)
library(raster)
library(gstat)

#define paths for the raw data and OA folder held on git-annex on our NCEAS server, Mazu
raw_dir     = file.path(dir_M,'git-annex/neprep/_raw_data')
glob_dir    = file.path(dir_M,'git-annex/globalprep/prs_oa')
ne_dir  = file.path(dir_M,'git-annex/neprep/prs_oa')

cols      = colorRampPalette(brewer.pal(9, 'Spectral'))(255) # rainbow color scheme
```
  
## Load raw data  

New NOAA data
figure out how to write a loop to rasterize all files we have and then reproject and resample and add the coastline? make gif of the years 2014-2017

Here we are assuming that the file is the mean, below I explor other packages to try and pull the monthly data out to make sure this assumption is correct
```{r}
nc_files <- c(list.files(file.path(raw_dir,'NOAA_OA'),
                       full.names = TRUE, pattern = ".nc"))
```

A peak into what the data looks like.
Is this an annual mean? Find the meta data for it
the .nc file says has monthly .nc files in the global attributes history so it makes me think that its annual mean
```{r explore}
plot(raster(nc_files[4]), col = cols, axes = F)
```

Rasterize the annual oa means
Change the projection to us_albers
Resample
(no mask unlike slr, we care about what's happening OA wise offshore)

```{r rasterize_annual}
#three_nm <- raster(file.path(dir_git, "spatial/ocean_rasters/rast_3nm_mask.tif"))

registerDoParallel(10)


foreach(file = nc_files) %dopar% {
  
#  file = nc_files[1]
  
  yr <- substr(file, 73, 76) 
  
  #ocean_ne_repro <- projectRaster(ocean_ne, crs = us_alb, over = FALSE, progress="text") #uns
  
  ## read in month raster
  r <- raster(file) %>%
    projectRaster(crs = us_alb, over = FALSE, progress="text") %>% 
    raster::resample(ocean_ne, method = "ngb", 
             filename = sprintf("%s/prs_oa/int/noaa/oa_annual_noaa_%s.tif", 
                                dir_anx, yr), overwrite = TRUE) %>% 
    raster::crop(ocean_ne) %>% 
    mask(ocean_ne, filename = sprintf("%s/prs_oa/int/noaa_reprojected/oa_annual_noaa_repro_%s.tif", 
                                dir_anx, yr), overwrite = TRUE)


}

plot(raster(file.path(dir_anx, "prs_oa/int/noaa/oa_annual_noaa_2014.tif")))
```



Global Data

```{r,message=FALSE,warning=FALSE,eval=FALSE}

## getting aragonite data from https://catalog.data.gov/dataset/aragonite-saturation-state-calculated-from-ocean-station-data-with-dissolved-inorganic-carbon-d

nc_old = nc_open(file.path(dir_M,'git-annex/globalprep/_raw_data/WHOI/cesm_co2sys_1958-2016.1x1d.nc'))
#the only variables in this file are "PH"   "OARG" "OCAL"

print(nc_old)

nc_05 = nc_open(file.path(dir_M,'git-annex/globalprep/_raw_data/WHOI/annual/cesm_co2sys_2005.nc'))

names(nc_05$var) # names for lat/long are different, so double check
#variables here are "TLAT"         "TLONG"        "PH"           "OARG"         "OCAL"         "ECOSYS_IFRAC"

# longitude values are stored in the variable 'TLONG'

      long <- ncvar_get(nc,varid='Longitude')

# latitude values are stored in the variable 'TLAT'

      lat <- ncvar_get(nc,varid='Latitude')
```

####################################################
## Exploring the new data
## Reading in each file and parsing out the monthly data

*Helpful website for using NetCDF files http://geog.uoregon.edu/bartlein/courses/geog607/Rmd/netCDF_01.htm*

Data :
getting aragonite data from https://www.coral.noaa.gov/accrete/east-coast-oaps.html

The data is downloaded as seperate NetCDF files for each year. Each file has one variable (OmegaAr) with three dimensions (lat, long, and time). The unit for time is months since Janurary 2014 (0-11), but when we convert this data into an array later the month dimesions "turns in" the normal 1-12 because it counting the number of data sets for that dimension.

We need to extract the arrays individually
I want to figure out how to make this a loop, but need to spent some time with it first
```{r creating_arays}
## read in the files for each year
nc_2014 = nc_open(file.path(raw_dir,'NOAA_OA/omega_Ar_East_Coast_2014.nc'))
nc_2015 = nc_open(file.path(raw_dir,'NOAA_OA/omega_Ar_East_Coast_2015.nc'))
nc_2016 = nc_open(file.path(raw_dir,'NOAA_OA/omega_Ar_East_Coast_2016.nc'))
nc_2017 = nc_open(file.path(raw_dir,'NOAA_OA/omega_Ar_East_Coast_2017.nc'))
  
## grab the lat and longs; only need to do this once because the lats and longs are the same for every year
lat <- ncvar_get(nc_2014,varid='lat')
long <- ncvar_get(nc_2014,varid='lon')

## Need to grab the fill value ie: the value used when no data is avaliable so. it is -999 for 2014 and -32767 for 2015-2017
fillvalue_2014 <- ncatt_get(nc_2014, "OmegaAr", "_FillValue")
fillvalue_2015 <- ncatt_get(nc_2015, "OmegaAr", "_FillValue")
fillvalue_2016 <- ncatt_get(nc_2016, "OmegaAr", "_FillValue")
fillvalue_2017 <- ncatt_get(nc_2017, "OmegaAr", "_FillValue")

## create an array from the netcdf file for each year
oa.array_2014 <- ncvar_get(nc_2014, "OmegaAr")
oa.array_2015 <- ncvar_get(nc_2015, "OmegaAr")
oa.array_2016 <- ncvar_get(nc_2016, "OmegaAr")
oa.array_2017 <- ncvar_get(nc_2017, "OmegaAr")

# close each net cdf file
nc_close(nc_2014)
nc_close(nc_2015)
nc_close(nc_2016)
nc_close(nc_2017)

# Replace the fill values in each year with NAs
oa.array_2014[oa.array_2014 == fillvalue_2014$value] <- NA
oa.array_2015[oa.array_2015 == fillvalue_2015$value] <- NA
oa.array_2016[oa.array_2016 == fillvalue_2016$value] <- NA
oa.array_2017[oa.array_2017 == fillvalue_2017$value] <- NA
```

The following code:
1. Rasterizes the monthly data
2. Reprojects, crops, resamples, and interpolates using nearest neighbor
3. Saves as monthly tiff files

Need to do this for each year

2014
```{r rastering_monthly_2014}
registerDoParallel(6)

  foreach(month = c(1:12))  %dopar% {
  
  #month = 12
  
  slice <- oa.array_2014[, , month] 
  
  r <- raster(t(slice), xmn=min(long), xmx=max(long), ymn=min(lat), ymx=max(lat), crs=CRS(p4s_wgs84)) %>% 
  flip(direction = 'y') %>%
  projectRaster(crs = us_alb, over = FALSE, progress="text") %>% 
  raster::crop(ne_ext) %>% 
  raster::resample(zones, method = "ngb") %>% 
    writeRaster(filename = sprintf("%s/int/noaa_monthly/v2014/noaa_2014month_%s.tif", file.path(dir_anx, "prs_oa"), month), 
                overwrite = TRUE)
  }
```


###Results nearest neighbor for 2014 just to look
```{r gif_results}
library(animation)

monthly_2014 <- list.files(file.path(dir_anx, 'prs_oa/int/noaa_monthly_raw/v2014'), full.names = T) %>%stack()
                         
names(monthly_2014) <- paste0("2014_month_", substr(names(monthly_2014),12, 13))

animation::saveGIF({
  for(i in 1:nlayers(monthly_2014)){
     plot(ocean_ne,col='cornsilk2',  main=names(monthly_2014[[i]]),axes=F,legend=F)
      # don't forget to fix the zlimits
    plot(monthly_2014[[i]], zlim=c(0,2.3),axes=F, col=cols, add=T) 
      
  }
}, movie.name = 'oa_monthly_2014_nn.gif')
```

2015
```{r rastering_monthly_2014}
registerDoParallel(6)

  foreach(month = c(1:12))  %dopar% {
  
  #month = 12
  
  slice <- oa.array_2015[, , month] 
  
  r <- raster(t(slice), xmn=min(long), xmx=max(long), ymn=min(lat), ymx=max(lat), crs=CRS(p4s_wgs84)) %>% 
  flip(direction = 'y') %>%
  projectRaster(crs = us_alb, over = FALSE, progress="text") %>% 
  raster::crop(ne_ext) %>% 
  raster::resample(zones, method = "ngb") %>% 
    writeRaster(filename = sprintf("%s/int/noaa_monthly/v2015/noaa_2015month_%s.tif", file.path(dir_anx, "prs_oa"), month), 
                overwrite = TRUE)
  }
```

2016
```{r rastering_monthly_2014}
registerDoParallel(6)

  foreach(month = c(01:12))  %dopar% {
  
  #month = 12
  
  slice <- oa.array_2016[, , month] 
  
  r <- raster(t(slice), xmn=min(long), xmx=max(long), ymn=min(lat), ymx=max(lat), crs=CRS(p4s_wgs84)) %>% 
  flip(direction = 'y') %>%
  projectRaster(crs = us_alb, over = FALSE, progress="text") %>% 
  raster::crop(ne_ext) %>% 
  raster::resample(zones, method = "ngb") %>% 
    writeRaster(filename = sprintf("%s/int/noaa_monthly/v2016/noaa_2016month_%s.tif", file.path(dir_anx, "prs_oa"), month), 
                overwrite = TRUE)
  }
```

2017
```{r rastering_monthly_2014}
registerDoParallel(6)

  foreach(month = c(1:12))  %dopar% {
  
  #month = 12
  
  slice <- oa.array_2017[, , month] 
  
  r <- raster(t(slice), xmn=min(long), xmx=max(long), ymn=min(lat), ymx=max(lat), crs=CRS(p4s_wgs84)) %>% 
  flip(direction = 'y') %>%
  projectRaster(crs = us_alb, over = FALSE, progress="text") %>% 
  raster::crop(ne_ext) %>% 
  raster::resample(zones, method = "ngb") %>% 
    writeRaster(filename = sprintf("%s/int/noaa_monthly/v2017/noaa_2017month_%s.tif", file.path(dir_anx, "prs_oa"), month), 
                overwrite = TRUE)
  }
  
  plot(r)
```

Now that we have all the monthly files as tiff files and in the right projection and extent we can calulate an annual arag saturation.

First we need to load and save all the files
```{r read_in_monthly_files}
monthly_files <- c(list.files(file.path(dir_anx, "prs_oa/int/noaa_monthly/v2014"),
                       full.names = TRUE),
              list.files(file.path(dir_anx, "prs_oa/int/noaa_monthly/v2015"),
                       full.names = TRUE),
              list.files(file.path(dir_anx, "prs_oa/int/noaa_monthly/v2016"),
                       full.names = TRUE),
              list.files(file.path(dir_anx, "prs_oa/int/noaa_monthly/v2017"),
                       full.names = TRUE))
```

## Historical Mean

The historical mean for aragonite saturation state from 1880 - 1889 was calculated for OHI 2015. We are taking this raster, cropping to our region, and reprojecting it. This raster will be used as a reference point.

```{r hist_mean}
hist_global <- raster(file.path(dir_M,'git-annex/globalprep/prs_oa/v2015/working/global_oa_1880_1889_arag_mean_moll.tif'))

plot(hist_global,main='Mean Ωaragonite 1880-1889', col=rev(cols), box=F,axes=F)

hist <- hist_global %>%
  projectRaster(crs = us_alb, over = FALSE, progress="text") %>% 
  raster::crop(ne_ext) %>% 
  raster::resample(zones, method = "ngb")

plot(hist)
```

## Annual Means
Calculate annual means
```{r calculate_annual_means}
maxyr <- substr(monthly_files, 60, 63) %>% 
  as.numeric() %>% 
  max()

## stack all rasters for this year, and calc annual mean, then write as raster
registerDoParallel(6)
foreach(yr = c(2014:maxyr)) %dopar% {
  
  files <- monthly_files[str_detect(monthly_files, as.character(yr))]
  
  rast_annual_mean <- stack(files) %>%
    calc(mean, na.rm = TRUE) %>%
    writeRaster(filename = sprintf("%s/int/noaa_annual_mean/oa_annual_%s.tif", file.path(dir_anx, "prs_oa"), yr), 
                overwrite = TRUE)
}
```

Visualzing Actual concentrations of Arg. we wil want to resample and mask here too
```{r}
# interpolate
registerDoParallel(24)

files <- list.files(file.path(dir_anx,'prs_oa/int/noaa_annual_mean'), full.names=TRUE)

foreach(file = files) %dopar%{

  #file = files[1]
  r  <- raster(file) #oa raster
  yr <- substr(file, nchar(file)-7, nchar(file)-4)
  xy <- data.frame(xyFromCell(r, 1:ncell(r))) #get xy coords into dataframe
  v  <- getValues(r)                          # get cell values
  tmpdf <- cbind(xy, v)%>%
    filter(!is.na(v))  #create dataframe of x,y, and values. remove NAs (throws error since these are cells we are interpolating over)
  
  mg <- gstat(id = "v", formula = v~1, locations = ~x+y, data=tmpdf,
            nmax=7, set=list(idp = 2)) #define model. power function = 2, this is default for idw models
  z <- interpolate(r, mg, progress='text')                            #interpolate across NA cells

  writeRaster(z, filename=paste0(dir_anx, '/prs_oa/int/noaa_annual_int/Aragonite_Concentration_', yr, ".tif"),overwrite=TRUE)
}

files <- list.files(file.path(dir_anx,'prs_oa/int/noaa_annual_int'), full.names=TRUE)

#mask
registerDoParallel(24)

foreach(file = files)%dopar% {

  yr <- substr(file,nchar(file)-7,nchar(file)-4)
  cat(yr)
  x <- raster(file)%>%
  raster::resample(zones, method = 'ngb')%>%
  raster::mask(zones)
       
  writeRaster(x, filename = paste0(dir_anx, '/prs_oa/int/noaa_annual_int/Aragonite_Concentration_', yr, ".tif"), overwrite=TRUE)
}

library(animation)

oa_layers <- list.files(file.path(dir_anx, 'prs_oa/int/noaa_annual_int'), full.names = T) %>%stack()
                         
#names(oa_layers) <- paste0("Aragonite_Concentration_", substr(names(oa_layers),25, 28))

animation::saveGIF({
  for(i in 1:nlayers(oa_layers)){
     plot(ocean_ne,col='cornsilk2',  main=names(oa_layers[[i]]),axes=F,legend=F)
      # don't forget to fix the zlimits, zlim=c(-0.5,3)
    plot(oa_layers[[i]],zlim=c(0,3), axes=F, col=cols, add=T) 
      
  }
}, movie.name = 'Aragonite_Concentration.gif')
```


## Rescale from 0 to 1

This pressure layer is rescaled so that all values lie between 0 and 1 using both a historical reference period and a biological reference point. All cells with values less than one, indicating an undersaturated state, are set equal to the highest stressor level, 1. For all other cells, rescaling the aragonite staturation state value to between 0 and 1 relies upon the change in saturation relative to the reference period.

Deviation from aragonite saturation state is determined for each year in the study period using this equation:

$$\Delta \Omega_{year} = \frac{(\Omega_{base} - \Omega_{year})}{(\Omega_{base} - 1)}$$

Note that the current value is subtracted from the baseline; this way, a reduction in $\Omega$ becomes a positive pressure value.  It is then normalized by the current mean state; so a decrease in $\Omega$ while the current state is high indicates less pressure than the same decrease when the current state is near 1. 

$\Delta \Omega_{year}$ is then modified to account for increases in aragonite saturation state (pressure = 0) and arag sat state less than 1 (pressure = 1).

The `oaRescale` function rescales each of the annual rasters. If the current value is less than or equal to 1, it is set to 1, otherwise the value is calculated from the above equation.

*Using the function from global to calculate*
```{r rescale,eval=F}
#for each layer, all values <=1 are assigned a 1, otherwise old-new/(old-1)
oaRescale <- function(file){
  
  yr   = substr(file, nchar(file)-7, nchar(file)-4)  #get year of file
  mean = raster(file)                              #get seasonal mean aragonite raster for given year
  diff = (hist-mean)/(hist-1)
  mean[mean<=1] <- 1                                 #all values at or less than 1 are given a value of 1
  mean[mean>1] <- diff[mean>1]                     #all cells with values greater than 1 are swapped out with their amount of change scaled to how close to 1 
  mean[mean<0] <- 0                                  #all values less than 0 (indicating a decrease in acidity) are capped at 0
    writeRaster(mean, filename=paste0(dir_anx, '/prs_oa/int/noaa_rescaled/oa_rescaled_', yr, sep=""), format='GTiff', overwrite=TRUE)
}

files = c(list.files(file.path(dir_anx, "prs_oa/int/noaa_annual_mean"), full.names=TRUE))
mclapply(files, oaRescale, mc.cores = 16)
```

Now we want to interpolate using the nearest neighbor technique. We are using the nearest neighbor technique to interpolate
```{r calculate_annual_means} 
#register parallel cores

registerDoParallel(24)

files <- list.files(file.path(dir_anx,'prs_oa/int/noaa_rescaled'), full.names=TRUE)

foreach(file = files) %dopar%{

  #file = files[1]
  r  <- raster(file) #oa raster
  yr <- substr(file, nchar(file)-7, nchar(file)-4)
  xy <- data.frame(xyFromCell(r, 1:ncell(r))) #get xy coords into dataframe
  v  <- getValues(r)                          # get cell values
  tmpdf <- cbind(xy, v)%>%
    filter(!is.na(v))  #create dataframe of x,y, and values. remove NAs (throws error since these are cells we are interpolating over)
  
  mg <- gstat(id = "v", formula = v~1, locations = ~x+y, data=tmpdf,
            nmax=7, set=list(idp = 2)) #define model. power function = 2, this is default for idw models
  z <- interpolate(r, mg, progress='text')                            #interpolate across NA cells

  writeRaster(z, filename=paste0(dir_anx, '/prs_oa/int/noaa_rescaled_int/oa_rescaled_int_', yr, ".tif"),overwrite=TRUE)
}
  
```

Next we are going to resample and mask the raster
```{r}
files <- list.files(file.path(dir_anx,'prs_oa/int/noaa_rescaled_int'), full.names=TRUE)

registerDoParallel(24)

foreach(file = files)%dopar% {

  yr <- substr(file,nchar(file)-7,nchar(file)-4)
  cat(yr)
  x <- raster(file)%>%
  raster::resample(zones, method = 'ngb')%>%
  raster::mask(zones)
       
  writeRaster(x, filename = paste0(dir_anx, '/prs_oa/output/oa_prs_layer_', yr, ".tif"), overwrite=TRUE)
}
```


###Results: create a gif using the noaa data 2014-2017
```{r gif_results}
library(animation)

oa_layers <- list.files(file.path(dir_anx, 'prs_oa/output'), full.names = T) %>%stack()
                         
names(oa_layers) <- paste0("OA_Pressure_Score_", substr(names(oa_layers),14, 17))

animation::saveGIF({
  for(i in 1:nlayers(oa_layers)){
     plot(ocean_ne,col='cornsilk2',  main=names(oa_layers[[i]]),axes=F,legend=F)
      # don't forget to fix the zlimits
    plot(oa_layers[[i]], zlim=c(0,1),axes=F, col=cols, add=T) 
      
  }
}, movie.name = 'OA_Pressures_scores.gif')
```












