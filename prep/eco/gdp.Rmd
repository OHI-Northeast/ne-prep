---
title: 'OHI-Northeast: Gross Domestic Product data layer preparation'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---


``` {r setup, echo=F, message = FALSE, warning = FALSE, results = 'hide'}
knitr::opts_chunk$set(fig.width = 8, fig.height = 6, fig.path = 'figs/', message = FALSE, warning = FALSE)

dir_git <- '~/github/ne-prep'
dir_rgn <- file.path(dir_git, 'prep/regions')  ### github: general buffer region shapefiles
source(file.path(dir_git, 'src/R/common.R'))   ### an OHI-Northeast specific version of common.R

library(readxl)
library(DT)
library(dplyr)
library(zoo)

dir_anx <- file.path(dir_M, 'git-annex/neprep')

#round to 2 decimals
options(digits = 3, scipen = 999)
```

#Summary

The Gross Domestic Product (GDP) layer is calculated using coastal GDP data from the [National Ocean Economics Program](http://www.oceaneconomics.org/). The target GDP growth rate is between 2-3% (*need citation*) so we will set a 3% target. The minimum will be set at 30% loss.

***

#Data Sources

##National ocean Economics Program (NOEP)

**Downloaded**: Manually downloaded on July 3, 2018.  
**Description**:  GDP [2012 $USD] per sector for RI, ME, MA, CT, NY and NH counties from 2005 to 2014. The data also include number of establishments, jobs and wages for each sector - state - year.  
**Native data resolution**: County level   
**Time range**: 2005 - 2015  
**Format**:  Tabular  


**NOTES**

The data was cleaned in the `liv/clean_noep_data.R` script.

All GDP values are reported in 2012 US Dollars.

***

# Load data


## Coastal GDP

```{r coastal_data}
noep_data = read_csv("../liv/data/clean_noep_data.csv") %>%
  select(-X1, -rgn_estab, -rgn_employment, -rgn_wages)
```


```{r}
ggplot(noep_data, aes(x = year, y = rgn_gdp)) +
  geom_line() +
  ylab("Gross Domestic Product (2012 USD$)") +
  facet_wrap(~ rgn_name, scales = "free") +
  ggtitle("Gross Domestic Product") +
  xlab("Year") +
  theme_bw()
```

***

#Methods

The economies score, $x_{eco}'$, is calculated for each region using the following equation; 

$$x_{eco}' = \frac{\frac{E_{i}}{E_{r}}}{USGDP_{i}}$$

where $E_{i}$ is the total GDP in year *i*, and $E_{r}$ is the mean annual GDP for the previous year. The growth rate, ${\frac{E_{i}}{E_{r}}}$, is compared to the national average GDP growth rate for year *i*.


## Calculate annual growth rate

The annual GDP growth rate is calculated by comparing every year's GDP total to the previous year.

```{r gdp_ref_point}

gdp <- noep_data %>%
  arrange(year) %>%
  group_by(rgn_id) %>%
  mutate(gdp_avg_3yr = rollapply(rgn_gdp, 3, FUN = mean, align = "right", na.rm = F, partial = T), #calculate the mean for three years
         gdp_prev_3yr = lag(gdp_avg_3yr, n = 1), #create a new column that aligns the avg wages from previous three years with the year with which we're comparing.
         gdp_growth_rate = ifelse(year %in% c(2005:2007), NA, (rgn_gdp/gdp_prev_3yr)-1)) %>% #assign NA to the first three years in the time series because there is not enough data to calculate this rate. 2007 growth rate *should* be compared to average of 2004-2006.
  write_csv("int/coastal_gdp_data.csv") %>%
  select(state, year, rgn_id, rgn_name, gdp_growth_rate)


write.csv(gdp, file.path(dir_calc, "layers/eco_coast_gdp.csv"))
  
ggplot(gdp%>%filter(!is.na(gdp_growth_rate)), aes(x = year, y = gdp_growth_rate, color = rgn_name)) +
    geom_line() +
    ylab("Annual GDP growth rate (%)") +
  geom_hline(yintercept = 0) +
  theme_bw()

```


***

#References

National Ocean Economics Program. Ocean Economic Data by Sector & Industry., ONLINE. 2012.
Available: http://www.OceanEconomics.org/Market/oceanEcon.asp [3 October 2017]

