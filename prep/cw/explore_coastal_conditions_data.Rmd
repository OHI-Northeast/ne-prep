---
title: "Exploring the EPA Coastal Condition Assessment data"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---

## Summary

Four layers are derived from the Environmental Protection Agency Coastal Condition Assessment data: 

1. Biological Benthic Index    
2. Water Quality Index  
    - Phosphorus  
    - Nitrogen  
    - Dissolved Oxygen  
    - Water Clarity  
    - Chlorophyll a  
3. Sediment Quality Index   
    - Sediment Contaminants  
    - Sediment Toxicity  
4. Fish Quality Index  



```{r setup, message = F, warning = F, reslts = 'hide'}
knitr::opts_chunk$set(fig.width = 10, fig.height = 6, fig.path = 'figs/', message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R')

library(tidyverse)
```

## Explore raw data

I want to figure out the difference between the data from the early years and 2010. I'll just look at the benthic data for now.

Read it in
filter for regions in the Northeast

```{r read_data}
benthic_old <- readxl::read_excel(file.path(dir_anx, "_raw_data/EPA/nca_benthicdata_narschallenge.xlsx")) %>% 
  filter(PSTL_CODE %in% c("MA", "ME", "RI", "NY", "NH", "CT"))
  
benthic_new <- read_csv(file.path(dir_anx, "_raw_data/EPA/ncca2010_benthic_indicator_status.csv")) %>%
  filter(PSTL_CODE %in% c("MA", "ME", "RI", "NY", "NH", "CT"),
         NCCA_REG == "Northeast")

DT::datatable(head(benthic_old))
DT::datatable(head(benthic_new))
```

It looks like the older benthic dataset does not have the status information we are looking for (Fair/Good/Poor) for each site. Instead it is sample information. Let's see if it's the same for the Sediment data

```{r}
sed_old <- readxl::read_excel(file.path(dir_anx, "_raw_data/EPA/nca_sedchemdata_narschallenge.xlsx")) %>% 
  filter(PSTL_CODE %in% c("MA", "ME", "RI", "NY", "NH", "CT"))
DT::datatable(head(sed_old))
```

This also looks to be missing the information we want. Last one to look at is the water quality data.

```{r}
water_old <- readxl::read_excel(file.path(dir_anx, "_raw_data/EPA/nca_waterchemdata_narschallenge.xlsx")) %>% 
  filter(PSTL_CODE %in% c("MA", "ME", "RI", "NY", "NH", "CT"))
DT::datatable(head(water_old))
```

## Visualize data

Plot on a map each location as a point and color based on status (green, yellow, red)

```{r fig.width = 8, fig.height = 6}
points = st_as_sf(water_old, coords = c("LON_DD", "LAT_DD"), 
                 crs = 4326)

#mapview::mapview(points) 

cols <- c("MISSING" = "gray", "GOOD" = "darkgreen", "FAIR" = "darkorange", "POOR" = "darkred")

ggplot() +
  geom_sf(data = ne_states, fill = "beige") +
  geom_sf(data = points, aes(color = Cat_WQI), size = 0.8) +
  facet_wrap(~SAMPYEAR) +
  theme_bw() +
  scale_color_manual(values = cols) +
  labs(color = "Status",
       title = "Water Quality Index")

```

Do all of these sites have just one sample during the 2000 - 2006 time period?

```{r}
num_samps <- water_old %>%
  group_by(SITE_ID) %>%
  summarize(n = n())
max(num_samps$n)
```

It seems like all of these sites are sampled just once

Let's look at the new water data

```{r water_new}
water_new <- read_csv(file.path(dir_anx, "_raw_data/EPA/ncca2010_water_quality_indicator_status.csv")) %>%
  filter(PSTL_CODE %in% c("MA", "ME", "RI", "NY", "NH", "CT"),
         NCCA_REG == "Northeast")

wn_points = st_as_sf(water_new, coords = c("LON_DD", "LAT_DD"), 
                 crs = 4326)

#mapview::mapview(wn_points) 

ggplot() +
  geom_sf(data = ne_states, fill = "beige") +
  geom_sf(data = wn_points, aes(color = CAT_WQI), size = 0.8) +
  theme_bw() +
  scale_color_manual(values = cols) +
  labs(color = "Status",
       title = "Water Quality Index 2010")
```

New Benthic data
```{r}
ben_points = st_as_sf(benthic_new, coords = c("LON_DD", "LAT_DD"), 
                 crs = 4326)

cols <- c("MISS" = "gray", "GOOD" = "darkgreen", "FAIR" = "darkorange", "POOR" = "darkred")

#mapview::mapview(ben_points)

ggplot() +
  geom_sf(data = ne_states, fill = "beige") +
  geom_sf(data = ben_points, aes(color = NCCA_BI_STATUS), size = 0.8) +
  theme_bw() +
  scale_color_manual(values = cols) +
  labs(color = "Status",
       title = "Benthic Index 2010")
```

2010 Fish index

```{r}
fish <- read_csv(file.path(dir_anx, "_raw_data/EPA/ncca2010_ecological_fish_tissue_contaminant_status.csv")) %>%
  filter(PSTL_CODE %in% c("MA", "ME", "RI", "NY", "NH", "CT"),
         NCCA_REG == "Northeast")

fish_points = st_as_sf(fish, coords = c("LON_DD", "LAT_DD"), 
                 crs = 4326)

cols <- c("Missing" = "gray", "Good" = "darkgreen", "Fair" = "darkorange", "Poor" = "darkred")

#mapview::mapview(ben_points)

ggplot() +
  geom_sf(data = ne_states, fill = "beige") +
  geom_sf(data = fish_points, aes(color = TISSUE_STATUS), size = 0.8) +
  theme_bw() +
  scale_color_manual(values = cols) +
  labs(color = "Status",
       title = "Fish Tissue Index 2010")
```

Sediment


```{r}
sed <- read_csv(file.path(dir_anx, "_raw_data/EPA/ncca2010_sediment_indicator_status_revised_06212016.csv")) %>%
  filter(PSTL_CODE %in% c("MA", "ME", "RI", "NY", "NH", "CT"),
         NCCA_REG == "Northeast")

sed_points = st_as_sf(sed, coords = c("LON_DD", "LAT_DD"), 
                 crs = 4326)

cols <- c("MISS" = "gray", "GOOD" = "darkgreen", "FAIR" = "darkorange", "POOR" = "darkred", "F_QA" = "blue")

#mapview::mapview(ben_points)

ggplot() +
  geom_sf(data = ne_states, fill = "beige") +
  geom_sf(data = sed_points, aes(color = NCCA_SQI_STATUS), size = 0.8) + 
  theme_bw() +
  scale_color_manual(values = cols) +
  labs(color = "Status",
       title = "Sediment Quality Index 2010")
```


## Reference

Citation: U.S. Environmental Protection Agency. [insert the year the survey report was published]. National Aquatic Resource Surveys. [insert the survey name and survey year] (data and metadata files). Available from U.S. EPA web page: Data from the National Aquatic Resource Surveys. Date accessed: 2018-07-31.









