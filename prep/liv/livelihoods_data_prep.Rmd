---
title: 'OHI-Northeast: Livelihoods'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohi-northeast/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---


``` {r setup, echo=F, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 8, fig.height = 6, fig.path = 'figs/', message = FALSE, warning = FALSE, echo=F)

dir_git <- '~/github/ohi-northeast'
dir_rgn <- file.path(dir_git, 'prep/regions')  ### github: general buffer region shapefiles
source(file.path(dir_git, 'src/R/common.R'))  ### an OHIBC specific version of common.R

library(zoo)
library(rgdal)
library(raster)
library(DT)
library(plotly)
library(RCurl)
library(RJSONIO)
library(dplyr)

dir_anx <- file.path(dir_M, 'git-annex/neprep')

#round to 2 decimals
options(digits=2, scipen = 999)
```

#Summary

The Livelihoods sub-goal is calculated using coastal employment data from the [National Ocean Economics Program](http://www.oceaneconomics.org/), and State-wide employment from the [Bureau of Labor Statistics](http://www.bls.gov/data/).

***

#Data Sources

##National ocean Economics Program (NOEP)

**Downloaded**: Received from Pat Johston on May 17, 2016.  
**Description**:  Total number of jobs per sector for RI, ME, MA, CT and NH counties from 2005 to 2013. The data also include number of establishments, GDP and Wages for each sector - state - year.  
**Native data resolution**: County level   
**Time range**: 1990 - 2013  
**Format**:  Tabular  

***

# Analysis

Filter raw data

```{r coastal_data}

#read in raw data and filter for Sector == All Ocean Sectors
data <- read.csv(file.path(dir_anx,"_raw_data/NOEP/NewEngland_sectors_counties-2.csv"),
                stringsAsFactors=F)%>%
        filter(Sector=='All Ocean Sectors')%>%
        mutate(Employment     = as.numeric(gsub(",","",.$Employment)),
               Establishments = as.numeric(gsub(",","",.$Establishments)),
               Wages          = as.numeric(gsub(",","",.$Wages)),
               Wages_2009     = as.numeric(gsub(",","",.$Wages_2009)),
               GDP            = as.numeric(gsub(",","",.$GDP)),
               GDP_2009       = as.numeric(gsub(",","",.$GDP_2009)))

DT::datatable(data, rownames=F, caption = 'Employment in the Tourism & Recreation sector of Coastal Jobs in New England provided by NOEP')

```


##US Bureau of Labor Statistics

**Downloaded**: May 17, 2016  
**Description**: Total Annual Employment (in thousands) per State from 1990 to 2015  
**Native data resolution**: State level  
**Time Range:** 2005 to 2015  
**Format:** Tabular  


```{r state data}
#read in state-wide employment. This data was made by hand from a manual query on the BLS.gov site: http://data.bls.gov/pdq/SurveyOutputServlet. 
# this should be replaced with code using the blsAPI R package. Currently waiting on a response from the maintainer: https://github.com/mikeasilva/blsAPI/issues/7

#employment is in thousands so we need to multiply
st_emp <- read.csv('../tr/state_employment.csv')%>%
          mutate(Employment = 1000*Employment)

DT::datatable(st_emp, caption = 'Total Employment by State, provided by the Bureau of Labor Statistics',rownames=FALSE)


```



***

#Methods

##Jobs

The livelihoods jobs score, $j '$, is calculated using the following equation; 

$$j ' = \frac{\frac{C_{i}}{C_{r}}}{\frac{T_{i}}{T_{r}}}$$

where $C_{i}$ is the number of coastal jobs in year *i*, $C_{r}$ is the number of coastal jobs in 2005, ${T_{i}}$ is the total number of jobs statewide for year *i* and ${T_{r}}$ is the number of jobs statewide in 2005.


```{r jobs}

jobs<- data%>%
          filter(!grepl("All",County))%>%
          group_by(State, County, Year)%>%
          summarise(coast_jobs = sum(Employment,na.rm=T))%>%
          mutate(hist_jobs = coast_jobs[which.min(Year)])%>%
          left_join(st_emp,by=c('State','Year'))%>%
          mutate(cst_chg = coast_jobs/hist_jobs, #use historical reference point from 2005
                 hist_st_jobs = Employment[which.min(Year)],
                 st_chg = Employment/hist_st_jobs,
                 score = ifelse((cst_chg/st_chg)>1,1,cst_chg/st_chg))%>%as.data.frame()

```

## Wages

The livelihoods wages score, $g'$ is calculated using the following equation;

$$g ' = \frac{\frac{C_{i}}{C_{r}}}{\frac{T_{i}}{T_{r}}}$$


```{r wages}

#wage statistics came from bureau of labor - had to manually query their online database and copy and paste the data for each county into an excel sheet (bls_wages.csv). Not ideal but their public api is awful and only gets data for years 2013-2015

bls_wages <- read.csv('bls_wages.csv',stringsAsFactors=FALSE)


wages <- data%>%
          mutate(County = ifelse(grepl("All",County),"Statewide",County),
                 coast_wages = as.numeric(gsub(",","",Wages_2009)),
                 hist_wages = coast_wages[which.min(Year)])%>%
          dplyr::select(-Employment, -Wages, -Wages_2009, GDP, GDP_2009)%>%
          left_join(bls_wages,by=c('State','County','Year'))%>%
          mutate(w_cst_chg = coast_wages/hist_wages, #use historical reference point from 2005
                 hist_st_wages = Annual[which.min(Year)],
                 w_st_chg = Annual/hist_st_wages,
                 wages_score = ifelse((w_cst_chg/w_st_chg)>1,1,w_cst_chg/w_st_chg))%>%as.data.frame()%>%
          dplyr::select(-Sector,-Establishments,-GDP,-GDP_2009,-Annual)


```

## Wages Score


```{r plot_wages}

#by state

s <- wages%>%
      filter(County == 'Statewide')
  
s_plot <- ggplot(s,aes(x = Year,y = wages_score, group=State))+
  ggtheme_plot+
  geom_point(aes(color = State)) +
            geom_line(aes(color = State))+
            scale_y_continuous(limits = c(0,1))+
            ggtitle("Wages Scores for the Northeast Regions")+
  labs(y = 'Score')
            ggplotly()
            
#by county
            
c    <- wages%>%
      filter(County != 'Statewide') 

c_plot <- ggplot(c,aes(x = Year,y = wages_score, group=County))+
  ggtheme_plot+
  geom_point(aes(color = County)) +
            geom_line(aes(color = County))+
            scale_y_continuous(limits = c(0,1))+
            ggtitle("Wages Scores for the Northeast Regions")+
  labs(y = 'Score')
            ggplotly()
           
```



***

#Results

Now to calculate the livelihoods sub goal we need to bring jobs and wages together

```{r liv_score}

# Combine wages and jobs data

liv <- jobs%>%
        left_join(wages)%>%
       mutate(liv_score = (score + wages_score)/2)

liv_plot <- ggplot(liv,aes(x = Year,y = liv_score, group=County))+
  ggtheme_plot+
  geom_point(aes(color = County)) +
            geom_line(aes(color = County))+
            scale_y_continuous(limits = c(0,1))+
            ggtitle("Livelihood Scores for the Northeast Regions")+
  labs(y = 'Score')
            ggplotly()
            
            
#aggregate by state (take the mean)
            
liv_st <- liv%>%
            group_by(State, Year)%>%
            summarise(st_score = mean(liv_score,na.rm=T))

liv_st_plot <- ggplot(liv_st,aes(x = Year,y = st_score, group=State))+
  ggtheme_plot+
  geom_point(aes(color = State)) +
            geom_line(aes(color = State))+
            scale_y_continuous(limits = c(0,1))+
            ggtitle("Livelihood Scores for the Northeast Regions")+
  labs(y = 'Score')
            ggplotly()

```



