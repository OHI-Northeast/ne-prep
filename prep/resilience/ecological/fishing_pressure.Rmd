---
title: "OHIEC: Resilience - Fishing Pressure prep"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
toc: true
---

# Summary

This script calculates fishing pressure resilience values by OHINE region. 

# Data

**Reference**: 


**Downloaded**: July, 2019 insert jamie month/year here

**Description**:  


**Time range**: 

**Format**:  Excel spreadsheet


``` {r setup,  message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R')  ### an OHINE specific version of common.R

dir_git <- '~/github/ne-prep'
dir_anx <- file.path(dir_M, 'git-annex/neprep')

library(csv)
library(tidyverse)
library(dplyr)
library(Hmisc)
library(stringi)

```


Data
```{r}

#figure out how to pick out data from another folder that's not in this RMD workspace
all_species_caught_assessment_summary <- read_csv("~/github/ne-prep/prep/fis/data/all_species_caught_assessment_summary.csv")
assessed_species_lookup_table <- read_csv("~/github/ne-prep/prep/fis/data/assessed_species_lookup_table.csv")
nmfs_spatial_catch_by_ohi_rgn <- read_csv("~/github/ne-prep/prep/fis/data/nmfs_spatial_catch_by_ohi_rgn.csv")

catch <- nmfs_spatial_catch_by_ohi_rgn %>% 
  select(species, rgn_id, rgn_name) %>% 
  distinct() %>% 
  rename(nmfs_original_species = species)

```

##Percent of species landed that have stock assessments, by NEOHI Region
```{r}

#test <- left_join(all_species_caught_assessment_summary, assessed_species_lookup_table, by = c("nmfs_original_species"))

assessments <- left_join(catch, all_species_caught_assessment_summary, by = c("nmfs_original_species")) %>% 
  select(nmfs_original_species, rgn_id, rgn_name, assessed) %>% 
  filter(nmfs_original_species !="CRAB, SPECIES NOT SPECIFIED", 
         nmfs_original_species !="DOGFISH, SPECIES NOT SPECIFIED",
         nmfs_original_species != "EEL, SPECIES NOT SPECIFIED",
         nmfs_original_species != "HAKE, SPECIES NOT SPECIFIED",
         nmfs_original_species != "SEATROUT, SPECIES NOT SPECIFIED",
         nmfs_original_species != "OTHER FOR BAIT",
         nmfs_original_species != "MONK LIVERS",
         nmfs_original_species != "SHRIMP, SPECIES NOT SPECIFIED",
         nmfs_original_species !="SEATROUT, SPECIES NOT SPECIFIED",
         nmfs_original_species !="SHARK, MAKO, SPECIES NOT SPECIFIED",
         nmfs_original_species != "SKATE WINGS",
         nmfs_original_species != "SKATE WINGS, BARNDOOR",
         nmfs_original_species != "SKATE WINGS, LITTLE (SUMMER)",
         nmfs_original_species != "SKATE WINGS, LITTLE/WINTER MIXED",
         nmfs_original_species != "SKATE WINGS, SMOOTH",
         nmfs_original_species != "SKATE WINGS, THORNY",
         nmfs_original_species != "SKATE WINGS, LITTLE/WINTER MIXED",
         nmfs_original_species != "SKATE WINGS, SMOOTH",
         nmfs_original_species != "SKATE WINGS, THORNY",
         nmfs_original_species != "SKATE WINGS, WINTER (BIG)",
         nmfs_original_species != "TUNA, SPECIES NOT SPECIFIED",
         nmfs_original_species !="AMBERJACK, SPECIES NOT SPECIFIED",
         nmfs_original_species !="CLAM, SPECIES NOT SPECIFIED",
         nmfs_original_species != "CONFIDENTIAL SPECIES",
         nmfs_original_species != "FLOUNDER,NOT SPECIFIED"  ,
         nmfs_original_species != "OTHER INVERTEBRATES",
         nmfs_original_species != "MONK HEADS" ,
         nmfs_original_species != "MONK TAILS",
         nmfs_original_species != "OTHER FINFISH",
         nmfs_original_species != "SHARK, NOT SPECIFIED",
         nmfs_original_species != "SKATE WINGS, BARNDOOR" ,
         nmfs_original_species != "SKATE WINGS, LITTLE/WINTER MIXED",
         nmfs_original_species != "SKATE WINGS, THORNY",
         nmfs_original_species != "SKATE, UNCLASSIFIED",
         nmfs_original_species != "SQUID, SPECIES NOT SPECIFIED",
         nmfs_original_species != "WHELK / CONCH, SPECIES NOT SPECIFIED") %>% 
  mutate(binary_ass = case_when(
    assessed == "no" ~ 0,
    assessed == "yes" ~ 1))
  
total_species_caught <- assessments %>% 
  group_by(rgn_id, rgn_name) %>% 
  count() %>% 
  rename(caught = n)
total_species_caught 
  
total_species_assessed <- assessments %>% 
  filter(binary_ass == 1) %>% 
  group_by(rgn_id, rgn_name) %>% 
  count() %>% 
  rename(assessed = n)
total_species_assessed

percent_assessed_by_region <-left_join(total_species_caught, total_species_assessed, by = c("rgn_id", "rgn_name")) %>% 
  mutate(percent = assessed/caught)
percent_assessed_by_region

```

Visualization
```{r}

percent_assesses_graph <- ggplot(percent_assessed_by_region)+
  geom_point(aes(x=rgn_name, y= percent), size=2)+
    ggtitle("Percentage of Fish Landed in Northeast with Stock Assessments") +
  ylab("Percent") +
  xlab("Region") +
  theme_light()+
  theme(axis.text.x = element_text(angle=60, hjust=1))

percent_assesses_graph  
  
```

Stock Assessment Score
```{r}

assessment_score <- percent_assessed_by_region %>% 
  mutate(target = 1) %>% 
  mutate(score = percent/target,
         score = if_else(score > 1, 1, score)) %>% 
  uncount(13, .id = "n", .remove = F) %>%
  mutate(year = ifelse(n == 1, 2005, n + 2004)) %>%
  select(-n)

assessment_score

#write.csv(assessment_score, file = "data/assessment_score")

```

Visualization

```{r}

assessment_graph <- ggplot(assessment_score)+
  geom_line(aes(x=year, y= score, color= rgn_name))+
    ggtitle("Percentage of Fish Landed in Northeast with Stock Assessments") +
  ylab("Score") +
  xlab("Year") +
  theme_light()

assessment_graph  

#ggsave("figs/assessment_graph.jpg", width=7, height=5, dpi=300)

```




##MPA Coverage in EEZ

Used a lot of the code from the lsp.Rmd
``` {r setup, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/', message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R')  ### an OHINE specific version of common.R

library(tidyverse)
library(sf)
library(mapview)
```

```{r}
inshore_buffer <- rgns %>% filter(rgn_id <= 4)
```


Let's look at the available layers in the USGS PADUS database

```{r look_at_gdb_layers}
st_layers(file.path(dir_anx, "_raw_data/USGS/PADUS2_0_GDB_Arc10x/PADUS2_0.gdb"))
```


For the marine layer, we are going to remove all areas that are designated as fishery/shellfish management areas as well as the Special Area Management Plans. 

```{r load_and_clean_marine_layer}
marine <- read_sf(dsn = file.path(dir_anx, "_raw_data/USGS/PADUS2_0_Shapefiles/PADUS2_0Marine.shp")) %>%
  st_transform(us_alb) %>%
  st_crop(rgns)  %>%
  st_intersection(inshore_buffer) %>%
  filter(!Loc_Ds %in% c("Fishery Management Area", "Closure Area", "Fishery Management Areas", "Shellfish Management Area", "Essential Fish Habitat Conservation Area", "Conservation Area", "Gear Restricted Area", "Special Area Management Plan"), #the Conservation Areas are for Mussel Seed
         !is.na(Loc_Ds)) %>% 
  select(Loc_Ds, Loc_Nm, Date_Est, rgn_name, rgn_id)
```

Create and save an interactive .html map to show the different layers.
Not working, try and figure it out later
```{r interactive_map, eval = F}
 #mapview(proc, col.regions = "red") + 
usgs_data <-mapview(marine, col.regions = "blue") 

## save interactive map
mapshot(usgs_data_off, url = "usgs_map.html")
```


### Marine areas

First let's combine polygons so we don't double count areas. For example, multiple shipwrecks are included within the larger MA North Shore Sanctuary. 

We are also accounting for the year established
```{r}

marineEEZ_protected_by_rgn <- data.frame()

for(i in 2005:2017){
  
  print(i)
  
  s_yr <- filter(marine, Date_Est <= i | is.na(Date_Est)) %>% #all NA included as well
    group_by(rgn_id) %>%
    summarise() %>%
    ungroup() %>%
    mutate(prot_area_m = st_area(geometry)) %>% #calculate total protected area
    mutate(prot_area_km2 = as.numeric(prot_area_m)/1000000) %>% 
    left_join(inshore_buffer %>% st_set_geometry(NULL)) %>% #join to inland buffer 
    mutate(area_km2 = as.character(area_km2)) %>% 
    mutate(area_km2 = as.numeric(area_km2)) %>% 
    mutate(prop_area = prot_area_km2/area_km2 , #calculate proportion of land in 1km region protected
           type = "marine",
           year = i) %>%
    st_set_geometry(NULL)
  
  marineEEZ_protected_by_rgn <- bind_rows(s_yr, marineEEZ_protected_by_rgn)
}

```


# Results

```{r marine_protected_prop_by_rgn}

ggplot(marineEEZ_protected_by_rgn, aes(x = year, y = prop_area, color = rgn_name)) +
  geom_line() +
  theme_bw() +
  labs(y = "Proportion of EEZ waters protected")

```

# Save Layers

```{r save_to_layers}

#save marine
write.csv(marineEEZ_protected_by_rgn,"data/marineEEZ_protected_by_rgn")


```

#Calculate Scores

```{r}

#Load in State protected data
inshore_protected <- read_csv("~/github/ne-scores/region/layers/lsp_protected_marine.csv") %>% 
  select(-X1)

offshore_protected <- marineEEZ_protected_by_rgn %>% 
  select(rgn_id, year, prop_area)

protected_score <- inshore_protected %>% 
  rbind(offshore_protected) %>% 
  mutate(target = 0.3) %>% 
  mutate(score = prop_area/target,
         score = if_else(score > 1, 1, score)) %>% 
  mutate(rgn_id = as.character(rgn_id))

#write.csv(protected_score, file = "data/protected_score")

```

#Visualize

```{r}

protected_score_graph <- ggplot(protected_score) +
  geom_line(aes(x=year, y= score, color = rgn_id))+
  ggtitle("North East Protected Area Score") +
  ylab("Score") +
  xlab("Year") +
  theme_classic() 

protected_score_graph
#ggsave("figs/protected_score_graph.jpg", width=7, height=5, dpi=300)

```






























