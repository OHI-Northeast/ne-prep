---
title: "OHIEC: Resilience - Habitat Destruction prep"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
toc: true
---

# Summary

This script calculates habitat resilience values by OHINE region. 

NOAA layers for habitat and fishing rules
USGS layers

surfrider state of the beach report 2017

# Data

**Reference**: 

**Downloaded**: 

**Description**:  

**Time range**: 

**Format**: 


reference for noaa shapefiles:
NOAA Fisheries Service. NMFS Regulated Areas in Northeast and Mid-Atlantic Waters.  {SHAPEFILE TITLE} [Shapefile]. Gloucester, MA: National Oceanic and Atmospheric Administration (NOAA), National Marine Fisheries Service (NMFS), Greater Atlantic Regional Fisheries Office (GARFO) [producer] {SHAPEFILE PUBLICATION DATE}. http://www.nero.noaa.gov/gis.

##Protected Areas Benefical to Habitat

Used a lot of the code from the lsp.Rmd
``` {r setup, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/', message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R')  ### an OHINE specific version of common.R

library(tidyverse)
library(sf)
library(mapview)
#install.packages("lubridate")
library(lubridate)

```


Let's look at the available layers in the USGS PADUS database

```{r look_at_gdb_layers}

st_layers(file.path(dir_anx, "_raw_data/USGS/PADUS2_0_GDB_Arc10x/PADUS2_0.gdb"))

```


For the marine layer, we are going to remove all areas that are designated as fishery/shellfish management areas as well as the Special Area Management Plans. 

```{r load_and_clean_marine_layer}

marine_hab <- read_sf(dsn = file.path(dir_anx, "_raw_data/USGS/PADUS2_0_Shapefiles/PADUS2_0Marine.shp")) %>%
  st_transform(us_alb) %>%
  st_crop(rgns)  %>%
  st_intersection(rgns) %>%
  filter(!is.na(Loc_Ds),
         d_GAP_Sts == "2 - managed for biodiversity - disturbance events suppressed" | Loc_Ds == "Closed Area" ,
         Constancy == "Year-round",
         Date_Est <= "2017") %>% 
  select(Loc_Ds, Loc_Nm, Date_Est, rgn_name, rgn_id, area_km2) 

```


```{r}
marine_all <- read_sf(dsn = file.path(dir_anx, "_raw_data/USGS/PADUS2_0_Shapefiles/PADUS2_0Marine.shp")) %>%
  st_transform(us_alb) %>%
  st_crop(rgns)  %>%
  st_intersection(rgns) %>%
  filter(!is.na(Loc_Ds)) 
```



Removed this filter !Loc_Ds %in% c("Fishery Management Area", "Fishery Management Areas", "Shellfish Management Area", "Conservation Area","Gear Restricted Area", "Essential Fish Habitat Conservation Area", "Special Area Management Plan", "Closure Area"), #the Conservation Areas are for Mussel Seed


```{r interactive_map, eval = F}

 #mapview(proc, col.regions = "red") + 
usgs_data_habitat <-mapview(marine_hab, col.regions = "blue") 

usgs_data_habitat 

```

NOAA Habitat Management Area Data

data from habitat tab on https://www.greateratlantic.fisheries.noaa.gov/educational_resources/gis/data/index.html
1) Habitat Management Area
  - Cashes ledge and Fippennies ledge habitat management areas,
  - Ammen rock habitat management area
  - Eastern Maine HMA and Jeffrey’s Bank HMA
  - Closed Area II Habitat Closure
  - Great South Channel Habitat Management Area
2) Habitat Research Area
  - George’s Bank DHRA
3) Frank R. Lautenberg Deep-Sea Coral Protection Area
4) Groundfish Closures
  - Closed Area II 
  - Western gulf of maine habitat closure
5) MSB Bottom Trawling Restricted Areas
  - Oceanographer Canyon
  - Lydonia Canyon

```{r}
#1
hab_manage <- read_sf(dsn = file.path(dir_anx, "_raw_data/NOAA_HAB/Habitat_Management_Areas/Habitat_Management_Areas.shp")) %>% 
  filter(DESCRIBE != "Exemption area") %>% 
  mutate(start_year= 2018)

#2
hab_research <- read_sf(dsn = file.path(dir_anx, "_raw_data/NOAA_HAB/Dedicated_Habitat_Research_Area/Dedicated_Habitat_Research_Area.shp")) %>% 
  filter(AREANAME == "Georges Bank Dedicated Habitat Research Area") %>% # Stellwagen allows surf clam. quahog dredge gear
  mutate(start_year= 2018)
  
#3
hab_frl <- read_sf(dsn = file.path(dir_anx, "_raw_data/NOAA_HAB/Frank_R_Lautenberg_Deep_Sea_Coral_Protection_Areas/Frank_R_Lautenberg_Deep_Sea_Coral_Protection_Areas.shp"))%>% 
  mutate(start_year= 2018)

#4
hab_msb_trawl <- read_sf(dsn = file.path(dir_anx, "_raw_data/NOAA_HAB/MSB_Bottom_Trawling_Restricted_Areas/MSB_Bottom_Trawling_Restricted_Areas.shp"))%>% 
  mutate(start_year= 2008)

#combine all together
hab_protect <- rbind(hab_manage, hab_research, hab_frl, hab_msb_trawl) %>%
  st_transform(us_alb) %>%
  st_crop(rgns)  %>%
  st_intersection(rgns)
#%>% 
 # filter(EFFECTDATE < "2018-01-01") # this includes ammednments, not the OG date, so unsure how to deal with that

hab <- mapview(hab_protect) 
hab

```


sea scallops don't have any dredging prohibited areas, just dreding allowed areas, figure out if they are allowed to dredge in non predetermined areas
compare to sasi map

### Combining Polygons

First let's combine polygons so we don't double count areas

```{r}

hab_simple <- hab_protect %>% 
  select(AREAGROUP, rgn_name, rgn_id, area_km2, geometry) %>% 
  rename(Loc_Nm = AREAGROUP)

hab_combined <- marine_hab %>% 
  select(Loc_Nm, rgn_name, rgn_id, area_km2, geometry) %>% 
  rbind(hab_simple) 

hab_combined_view <- mapview(hab_combined) 
hab_combined_view

```




All areas included in the Marine layer were established before our time period (or have NA for Date_Est) so we don't need to do this by year. 
```{r}

hab_protected_by_rgn <- hab_combined %>%
  select(rgn_id, rgn_name, Loc_Nm) %>%
  group_by(rgn_id, rgn_name) %>%
  summarise() %>%
  ungroup() %>%
  mutate(area = st_area(geometry)/1000000) %>% #calculate total protected area
  left_join(rgn_data) %>%
  mutate(prop_area = as.numeric(area)/area_km2, 
         type = "marine",
         year = 2005) %>%
    st_set_geometry(NULL) %>% 
  uncount(13, .id = "n", .remove = F) %>%
  mutate(year = ifelse(n == 1, 2005, n + 2004)) %>%
  select(-n) %>% 
  select(rgn_id, rgn_name, prop_area, year) %>% 
  mutate(target = 0.3,
         score = prop_area/target,
         score = if_else(score >1, 1, score)) 
         
```

Percent of Habitat Protected
```{r}

hab_protected_by_rgn_graph <- ggplot(hab_protected_by_rgn, aes(x = year, y = prop_area, color = rgn_name)) +
  geom_line() +
  theme_classic() +
  geom_hline(yintercept=0.3)+
  labs(y = "Percentage", x = "Year") +
  ggtitle("Percentage of habitat protected")
hab_protected_by_rgn_graph

```


Scores Habitat Protected
```{r}
score_hab_protected_by_rgn_graph <- ggplot(hab_protected_by_rgn, aes(x = year, y = score, color = rgn_name)) +
  geom_line() +
  theme_classic() +
  labs(y = "Score", x = "Year") +
  ggtitle("Score of habitat protected")
score_hab_protected_by_rgn_graph
```

Looking at only groundfish and the coral protected areas

```{r}
#2
hab_ground <- read_sf(dsn = file.path(dir_anx, "_raw_data/NOAA_HAB/Groundfish_Closure_Areas/Groundfish_Closure_Areas.shp"))

look <-mapview(hab_ground, col.regions = "blue") 

look
```



















#State of the Beach Scorecard

```{r}

raw_sob <- read_xlsx(file.path(dir_anx, "_raw_data/Surfrider/state_of_the_beach_2017.xlsx"))

```

Scores
```{r}

sob_scores <- raw_sob %>% 
  mutate(target = 12,
         score = over_all/target)%>% 
  uncount(13, .id = "n", .remove = F) %>%
  mutate(year = ifelse(n == 1, 2005, n + 2004)) %>%
  select(-n)
  
write.csv(sob_scores, file = "data/sob_scores.csv")

```

Graph
```{r}

sob_score_graph <- ggplot(sob_scores, aes(x = year, y = score, color = state)) +
  geom_line() +
  theme_classic() +
  labs(y = "Score", x = "Year") +
  ggtitle("State of the Beach Score")
sob_score_graph 

ggsave("figs/sob_score_graph.jpg", width=7, height=5, dpi=300)
```











