---
title: "OHIEC: Resilience - Habitat Destruction prep"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
toc: true
---

# Summary

This script calculates habitat resilience values by OHINE region. 

NOAA layers for habitat and fishing rules
USGS layers

surfrider state of the beach report 2017

# Data

**Reference**: 

**Downloaded**: 

**Description**:  

**Time range**: 

**Format**: 


reference for noaa shapefiles:
NOAA Fisheries Service. NMFS Regulated Areas in Northeast and Mid-Atlantic Waters.  {SHAPEFILE TITLE} [Shapefile]. Gloucester, MA: National Oceanic and Atmospheric Administration (NOAA), National Marine Fisheries Service (NMFS), Greater Atlantic Regional Fisheries Office (GARFO) [producer] {SHAPEFILE PUBLICATION DATE}. http://www.nero.noaa.gov/gis.

##Protected Areas Benefical to Habitat

Used a lot of the code from the lsp.Rmd
``` {r setup, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/', message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R')  ### an OHINE specific version of common.R

library(tidyverse)
library(sf)
library(mapview)
#install.packages("lubridate")
library(lubridate)

```

NOAA Habitat Management Area Data
Currently waiting/working on getting this info over time, for now/if that never happens we will apply the scores to all years

data from habitat tab on https://www.greateratlantic.fisheries.noaa.gov/educational_resources/gis/data/index.html 
1) Habitat Management Area
  - Cashes ledge and Fippennies ledge habitat management areas,
  - Ammen rock habitat management area
  - Eastern Maine HMA and Jeffrey’s Bank HMA
  - Closed Area II Habitat Closure
  - Great South Channel Habitat Management Area
2) Habitat Research Area
  - George’s Bank DHRA
3) Frank R. Lautenberg Deep-Sea Coral Protection Area
4) Groundfish Closures
  - Closed Area II 
  - Western gulf of maine habitat closure
5) MSB Bottom Trawling Restricted Areas
  - Oceanographer Canyon
  - Lydonia Canyon

```{r}
#1
hab_manage <- read_sf(dsn = file.path(dir_anx, "_raw_data/NOAA_HAB/Habitat_Management_Areas/Habitat_Management_Areas.shp")) %>% 
  filter(DESCRIBE != "Exemption area") %>% 
  mutate(start_year= 2018)

#2
hab_research <- read_sf(dsn = file.path(dir_anx, "_raw_data/NOAA_HAB/Dedicated_Habitat_Research_Area/Dedicated_Habitat_Research_Area.shp")) %>% 
  filter(AREANAME == "Georges Bank Dedicated Habitat Research Area") %>% # Stellwagen allows surf clam. quahog dredge gear
  mutate(start_year= 2018)
  
#3
hab_frl <- read_sf(dsn = file.path(dir_anx, "_raw_data/NOAA_HAB/Frank_R_Lautenberg_Deep_Sea_Coral_Protection_Areas/Frank_R_Lautenberg_Deep_Sea_Coral_Protection_Areas.shp"))%>% 
  mutate(start_year= 2018)

#4
hab_msb_trawl <- read_sf(dsn = file.path(dir_anx, "_raw_data/NOAA_HAB/MSB_Bottom_Trawling_Restricted_Areas/MSB_Bottom_Trawling_Restricted_Areas.shp"))%>% 
  mutate(start_year= 2008)

#combine all together
hab_noaa <- rbind(hab_manage, hab_research, hab_frl, hab_msb_trawl) %>%
  st_transform(us_alb) %>%
  st_crop(rgns)  %>%
  st_intersection(rgns)

hab_protect <- mapview(hab_noaa) 
hab_protect
```


### Calculate Scores
Here we are using a 30% protected area target 

```{r}
hab_protect_rgn <- hab_noaa %>%
  select(rgn_id, rgn_name, AREANAME)%>%
  group_by(rgn_id, rgn_name) %>%
  summarise() %>%
  ungroup() %>%
  mutate(area = st_area(geometry)/1000000) %>% #calculate total protected area
  left_join(rgn_data) %>%
  mutate(prop_area = as.numeric(area)/area_km2, 
         type = "marine",
         year = 2005) %>%
    st_set_geometry(NULL) %>% 
  uncount(13, .id = "n", .remove = F) %>%
  mutate(year = ifelse(n == 1, 2005, n + 2004)) %>%
  select(-n) %>% 
  select(rgn_id, rgn_name, prop_area, year) %>% 
  mutate(target = 0.3,
         score = prop_area/target,
         score = if_else(score >1, 1, score)) 
```

Percent of Habitat Protected graph
```{r}
hab_protected_by_rgn_graph <- ggplot(hab_protect_rgn, aes(x = year, y = prop_area, color = rgn_name)) +
  geom_line() +
  theme_classic() +
  geom_hline(yintercept=0.3)+
  labs(y = "Percentage", x = "Year") +
  ggtitle("Percentage of habitat protected")
hab_protected_by_rgn_graph
```

Scores Habitat Protected graph
```{r}
score_hab_protected_by_rgn_graph <- ggplot(hab_protected_by_rgn, aes(x = year, y = score, color = rgn_name)) +
  geom_line() +
  theme_classic() +
  labs(y = "Score", x = "Year") +
  ggtitle("Score of habitat protected")
score_hab_protected_by_rgn_graph
```


Creating a df to add to have the missing regions there 
```{r missing_rgns_df}
miss_rgns <- tribble(
  ~rgn_id, ~rgn_name,
  9, "New Hampshire",
  7, "Massachusetts-North",
  8, "Massachusetts-South",
  11, "Rhode Island",
  5, "Connecticut",
  10, "New York") 

miss_rgns <- miss_rgns %>% 
  uncount(13, .id = "n", .remove = F) %>%
  mutate(year = ifelse(n == 1, 2005, n + 2004)) %>%
  select(-n) %>% 
  mutate(score = 0) %>%  #score is 0 because no protected area in that region
  unique()
```


Create a table with only the necessary info for calcualting the score
```{r}
area_protect <- hab_protect_rgn %>% 
  select(year, rgn_id, rgn_name,score) %>% 
  rbind(miss_rgns) %>% 
  rename(score_1 = score)
```


#State of the Beach Scorecard
```{r}
raw_sob <- read_xlsx(file.path(dir_anx, "_raw_data/Surfrider/state_of_the_beach_2017.xlsx"))
```

Scores
```{r}
sob_scores <- raw_sob %>% 
  mutate(target = 12,
         score = over_all/target)%>% 
  uncount(13, .id = "n", .remove = F) %>%
  mutate(year = ifelse(n == 1, 2005, n + 2004)) %>%
  select(-n)
  
write.csv(sob_scores, file = "data/sob_scores.csv")
```

Graph
```{r}
sob_score_graph <- ggplot(sob_scores, aes(x = year, y = score, color = state)) +
  geom_line() +
  theme_classic() +
  labs(y = "Score", x = "Year") +
  ggtitle("State of the Beach Score")
sob_score_graph 

ggsave("figs/sob_score_graph.jpg", width=7, height=5, dpi=300)
```


Creating a df to add to have the missing regions there 
```{r missing_rgns_df}
miss_rgns <- tribble(
  ~rgn_id, ~rgn_name,
  3, "Gulf of Maine",
  2, "Georges Bank",
  4, "Mid-Atlantic Bight",
  1, "Offshore") 

miss_rgns <- miss_rgns %>% 
  uncount(13, .id = "n", .remove = F) %>%
  mutate(year = ifelse(n == 1, 2005, n + 2004)) %>%
  select(-n) %>% 
  mutate(score = NA) %>% 
  unique()
```


Create a table with only the necessary info for calcualting the score
```{r}
sob <- sob_scores %>% 
  select(state, score, year) %>% 
   mutate(rgn_id1 = case_when(
    state == "Maine" ~ "6", 
    state == "New Hampshire" ~ "9", 
    state == "Massachusetts" ~ "7",
    state == "Rhode Island" ~ "11",
    state == "Connecticut" ~ "5",
    state == "New York" ~ "10"),
    rgn_id2 = case_when(
    state == "Massachusetts" ~ "8"
    )) %>% 
  replace(., is.na(.), "0") %>% 
  gather(rgn_id1, rgn_id2, key= "filler", value = "rgn_id") %>% 
  filter(rgn_id != "0") %>% 
  rename(rgn_name = state) %>% 
  select(year, rgn_name, rgn_id, score) %>% 
  mutate(rgn_name = ifelse(rgn_name == "Massachusetts" & rgn_id== 7, "Massachusetts-North",
                ifelse(rgn_name == "Massachusetts" & rgn_id== 8, "Massachusetts-South", 
                       rgn_name))) %>% 
  rbind(miss_rgns) %>% 
  rename(score_2 = score) %>% 
  mutate(rgn_id = as.numeric(rgn_id)) 
```

Combine both layers
```{r}
res_hab_des <- left_join(sob, area_protect, by = c("year", "rgn_id", "rgn_name")) %>% 
  rowwise() %>% 
  mutate(score = mean(c(score_1,score_2), na.rm=T))
```




##Save layer to toolbox

```{r save_to_layers}
#write.csv(res_habitat_desctruction,  file = "~/github/ne-scores/region/layers/lsp_protected_land.csv")
```



























