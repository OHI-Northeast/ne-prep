---
title: "OHIEC: Resilience - Climate Change Pressure prep"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
toc: true
---

# Summary

This script calculates fishing pressure resilience values by OHINE region. 

# Data

**Reference**: 

**Downloaded**: 

**Description**:  

**Time range**: 

**Format**: 

Regulations:
1) extract info from America's Pledge Report
2) American Council for Energy Efficiency:
Rankings: https://database.aceee.org/state/

Effectiveness:
US. energy information administration:
1) Total CO2 emissions https://www.epa.gov/statelocalenergy/state-co2-emissions-fossil-fuel-combustion
2) Total power generation:https://www.eia.gov/electricity/data/state/

Targets for effectiveness from Beyond Carbon https://www.beyondcarbon.org/look-up-your-state/


``` {r setup,  message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R')  ### an OHINE specific version of common.R

dir_git <- '~/github/ne-prep'
dir_anx <- file.path(dir_M, 'git-annex/neprep')

library(csv)
library(tidyverse)
library(dplyr)
library(Hmisc)
library(stringi)
library(readxl)

```


Data
```{r}

eee <- read_excel(file.path(dir_anx, "_raw_data/EEE/eee_scores.xlsx"))
raw_gen <- read_excel(file.path(dir_anx, "_raw_data/EIA/eia_annual_generation_state.xls"))

```


I am pretty sure we're going to use the pdf file from EPA of EIA emmisisons data from 1990 so if thats the case delete this file from the server "_raw_data/EIA/eia_co2_emmisions.xlsx" 

**Regualtions**
Energy Efficiency Scores
```{r}

#calculate
eee_score <- eee %>% 
  mutate(score = eee_score/eee_target) %>% 
  uncount(13, .id = "n", .remove = F) %>%
  mutate(year = ifelse(n == 1, 2005, n + 2004)) %>%
  select(-n)

#save
write.csv(eee_score, file = "data/eee_score")

```

Visualize
```{r}

eee_score_graph <-ggplot(eee_score)+
  geom_line(aes(x=year, y = score, color=state))+
  ggtitle("Energy Efficiency Score") +
  ylab("Score") +
  xlab("State") +
  theme_classic() 
eee_score_graph

ggsave("figs/eee_score_graph.jpg", width=7, height=5, dpi=300)

```


**Effectivness**

##Clean Power Generation

Issue: Lots of Pumped storage production is negative. What to do about that? Is it when the water gets pumped back up? 

Types of energy source:
Coal
Natural Gas
Other
Other Biomass
Other Gases
Petroleum
Wood and Wood Derived Fuels
Nuclear
[below I considered clean energy; need to look into the pumped storage because most of it is negative]
Pumped Storage
Hydroelectric Conventional
Wind
Solar Thermal and Photovoltaic

Renewable/Clean Power Targets (Beyond Carbon):
Maine = 40% by 2017
New Hampshire = 25.2% by 2025
Connecticut = 44% by 2030
Massachusetts = 35% 2030
New York = 50% by 2030
Rhode Island = 38.5% by 2035


Calculate total energy production in each state each year
```{r}
gen_total <- raw_gen %>% 
  filter(year >= 2004 & year <=2017) %>% 
  filter(state == "ME" | state == "NH" | state == "MA" | state == "RI" | state == "CT" | state == "NY") %>% 
  filter(energy_source != "Total") %>%
  select(year, state, gen_mwh) %>% 
  group_by(year, state) %>% 
  dplyr::summarise(total_power = sum(gen_mwh)) %>% 
  ungroup()
```

Calculate total clean/renewable energy production in each state each year
```{r}
gen_clean <- raw_gen %>% 
  filter(year >= 2004 & year <=2017) %>% 
  filter(state == "ME" | state == "NH" | state == "MA" | state == "RI" | state == "CT" | state == "NY") %>% 
  filter(energy_source == "Hydroelectric Conventional"| energy_source == "Wind" | energy_source == "Solar Thermal and Photovoltaic" | energy_source == "Pumped Storage") %>%
  select(year, state, gen_mwh) %>% 
  group_by(year, state) %>% 
  dplyr::summarise(total_power_clean = sum(gen_mwh))%>% 
  ungroup()
```

Combine data sets 
```{r}
power_gen <- left_join(gen_total, gen_clean, by= c("year", "state")) %>% 
  mutate(per_clean = total_power_clean/total_power)
```

Visualize percent of clean energy production
```{r}
graph_clean_pro <-ggplot(power_gen)+
  geom_line(aes(x=year, y = per_clean, color=state))+
  ggtitle("Percent of Clean/Renewable Energy Production") +
  ylab("Percent") +
  xlab("State") +
  theme_classic() 
graph_clean_pro

ggsave("figs/graph_clean_pro_nuclear.jpg", width=7, height=5, dpi=300)
```


Add trend targets using simple regression

Maine
```{r}

#MA 40% clean by 2017
me <- power_gen %>% 
  filter(state == "ME") %>% 
  mutate(year_n = seq(0:13))

#create tibble with the start (value in 2005) and end (goal in whichever year) to do a linear regression 
me_target <- tribble(
  ~year, ~per_clean,
  0, 0.180,
  13, 0.4
)

#super simple regression for equation to calculate the necessary percent clean emmisions each year to reach target
lm_me <- lm(per_clean ~ year, data = me_target)
#intercept = 0.1800 ; coef =0.0169 
summary(lm_me)

plot(per_clean ~ year, data = me_target)
abline(lm_me)

###trying to use equation no loop
me_clean_target <- me %>% 
  rowwise() %>% 
  mutate(target = (0.0169*year_n + 0.1800 ),
         per_clean = round(per_clean, digits= 2),
         target = round(target, digits= 2)) %>% 
  filter( year != "2004") %>% 
  select(year, state, per_clean, target) 


```

Massachusets
```{r}

#MA 35% clean by 2030
ma <- power_gen %>% 
  filter(state == "MA")  %>% 
  mutate(year_n = seq(0:13),
         per_clean = if_else(per_clean <0, 0, per_clean)) 

#create tibble with the start (value in 2005) and end (goal in whichever year) to do a linear regression 
ma_target <- tribble(
  ~year, ~per_clean,
  0, 0.0105	,
  26, .35)

#super simple regression for equation to calculate the necessary percent clean emmisions each year to reach target
lm_ma <- lm(per_clean ~ year, data = ma_target)
#coef = 0.0131  ; int = 0.0105

ma_clean_target <- ma %>% 
  rowwise() %>% 
  mutate(target = (0.0131 *year_n+0.0105 ),
         per_clean = round(per_clean, digits= 2),
         target = round(target, digits= 2)) %>% 
  filter( year != "2004") %>% 
  select(year, state, per_clean, target)

```

New Hampshire
```{r}

#NH 25.2% clean by 2025
nh <- power_gen %>% 
  filter(state == "NH") %>% 
  mutate(year_n = seq(0:13))

#create tibble with the start (value in 2005) and end (goal in whichever year) to do a linear regression 
nh_target <- tribble(
  ~year, ~per_clean,
  0, 0.0551,
  21, .252
)

#super simple regression for equation to calculate the necessary percent clean emmisions each year to reach target
lm_nh <- lm(per_clean ~ year, data = nh_target)
#coef=  0.00938 int= 0.05510

nh_clean_target <- nh %>% 
  mutate(target = ( 0.00938*year_n +0.05510),
         per_clean = round(per_clean, digits= 2),
         target = round(target, digits= 2)) %>% 
   filter( year != "2004") %>% 
  select(year, state, per_clean, target)

```


Rhode Island
```{r}

#RI 38.5% clean by 2035
ri <- power_gen %>% 
  filter(state == "RI") %>% 
  mutate(year_n = seq(0:13))

#create tibble with the start (value in 2005) and end (goal in whichever year) to do a linear regression 
ri_target <- tribble(
  ~year, ~per_clean,
  0, 0.001106	,
  31, .385)

#super simple regression for equation to calculate the necessary percent clean emmisions each year to reach target
lm_ri <- lm(per_clean ~ year, data = ri_target)
#coef=0.01238  , int = 0.00111

ri_clean_target <- ri %>% 
   mutate(target = ( 0.01238*year_n+0.00111),
         per_clean = round(per_clean, digits= 2),
         target = round(target, digits= 2)) %>% 
  filter(year != "2004") %>% 
  select(year, state, per_clean, target)

```


New York
```{r}

#NY 50% clean by 2030
ny <- power_gen %>% 
  filter(state == "NY") %>% 
  mutate(year_n = seq(0:13))

#create tibble with the start (value in 2005) and end (goal in whichever year) to do a linear regression 
ny_target <- tribble(
  ~year, ~per_clean,
  0, 	0.169	,
  26, .50)

#super simple regression for equation to calculate the necessary percent clean emmisions each year to reach target
lm_ny <- lm(per_clean ~ year, data = ny_target)
#coef=0.0127   , int =  0.1690 

ny_clean_target <- ny %>% 
  mutate(target = (0.0127*year_n +0.1690 ),
         per_clean = round(per_clean, digits= 2),
         target = round(target, digits= 2)) %>% 
  filter(year != "2004") %>% 
  select(year, state, per_clean, target)

```


Connecticut
```{r}

#CT 44% clean by 2030
ct <- power_gen %>% 
  filter(state == "CT")  %>% 
  mutate(year_n = seq(0:13))

#create tibble with the start (value in 2005) and end (goal in whichever year) to do a linear regression 
ct_target <- tribble(
  ~year, ~per_clean,
  0, 0.01441,
  26, .44
)

#super simple regression for equation to calculate the necessary percent clean emmisions each year to reach target
lm_ct <- lm(per_clean ~ year, data = ct_target)
#coef= 0.0164, int=0.0144

ct_clean_target <- ct %>% 
  mutate(target = (0.0164*year_n +0.0144),
         per_clean = round(per_clean, digits= 2),
         target = round(target, digits= 2)) %>% 
  filter(year != "2004") %>% 
  select(year, state, per_clean, target)

```



Combine all states df with target
```{r}
energy_target <- rbind(me_clean_target, nh_clean_target, ma_clean_target, ri_clean_target, ct_clean_target, ny_clean_target)

```


Calculate scores
```{r}
power_gen_scores <- energy_target %>% 
  mutate(score = per_clean/target,
         score = if_else(score >1, 1, score)) 
#save
write.csv(power_gen_scores, file = "data/power_gen_scores_nuc")

```

Visualize scores
```{r}  

graph_clean_energy_score_nuc <-ggplot(power_gen_scores)+
  geom_line(aes(x=year, y = score, color=state))+
  ggtitle("Clean Energy Score") +
  ylab("Score") +
  xlab("Year") +
  theme_classic() 
graph_clean_energy_score_nuc
ggsave("figs/graph_clean_energy_score.jpg", width=7, height=5, dpi=300)

```

##Carbon Emmissions

Carbon Emmission Targets (Beyond Carbon):
Maine= 80% reduction below 2003 levels
New Hampshire= 80% reduction below 1990 levels by 2050
Connecticut= 80% reduction below 2001 levels by 2050
Massachusetts= 80% reduction below 1990 levels by 2050
New York= 80% reduction below 1990 levels by 2050
Rhode Island= 80% reduction below 1990 levels by 2050

Converting table from a pdf from EPA website to a df
```{r}

library(tabulizer)
library(dplyr)

location <- 'https://www.epa.gov/sites/production/files/2017-09/documents/co2ffc_2015.pdf'
out <- extract_tables(location)

#page 1
out1 <- out[[1]] %>%  
  as.data.frame() %>% 
  rename(state = V1, blank = V2, "1990" = V3, "1991"= V4, "1992"= V5, "1993"=V6, "1994"=V7, "1995"=V8, "1996"=V9, "1997"=V10, "1998"=V11, "1999"=V12, "2000"=V13, "2001"=V14, "2002"=V15, "2003"=V16, "2004"=V17, "2005"=V18, "2006"=V19, "2007"=V20, "2008"=V21, "2009"=V22, "2010"=V23, "2011"=V24, "2012"=V25, "2013"=V26, "2014"=V27, "2015"=V28, "2016"=V29) %>% 
  filter(state != "State Sector",
         state != "Commercial",
         state != "Industrial", 
         state != "Residential",
         state != "Transportation",
         state != "Electric Power") %>% 
  select(-blank)
  
#page 2  
out2 <- out[[2]] %>% 
  as.data.frame() %>% 
  rename(state = V1, blank = V2, "1990" = V3, "1991"= V4, "1992"= V5, "1993"=V6, "1994"=V7, "1995"=V8, "1996"=V9, "1997"=V10, "1998"=V11, "1999"=V12, "2000"=V13, "2001"=V14, "2002"=V15, "2003"=V16, "2004"=V17, "2005"=V18, "2006"=V19, "2007"=V20, "2008"=V21, "2009"=V22, "2010"=V23, "2011"=V24, "2012"=V25, "2013"=V26, "2014"=V27, "2015"=V28, "2016"=V29) %>% 
  filter(blank != "Commercial",
         blank != "Industrial", 
         blank != "Residential",
         blank != "Transportation",
         blank != "Electric Power")%>% 
  select(-blank)

#page 3
out3 <- out[[3]] %>% 
   as.data.frame() %>% 
  rename(state = V1, "1990" = V2, "1991"= V3, "1992"= V4, "1993"=V5, "1994"=V6, "1995"=V7, "1996"=V8, "1997"=V9, "1998"=V10, "1999"=V11, "2000"=V12, "2001"=V13, "2002"=V14, "2003"=V15, "2004"=V16, "2005"=V17, "2006"=V18, "2007"=V19, "2008"=V20, "2009"=V21, "2010"=V22, "2011"=V23, "2012"=V24, "2013"=V25, "2014"=V26, "2015"=V27, "2016"=V28) %>% 
  filter(state != "Commercial",
         state != "Industrial", 
         state != "Residential",
         state != "Transportation",
         state != "Electric Power")

#page 4
out4 <- out[[4]] %>%  
   as.data.frame() %>% 
  rename(state = V1, "1990" = V2, "1991"= V3, "1992"= V4, "1993"=V5, "1994"=V6, "1995"=V7, "1996"=V8, "1997"=V9, "1998"=V10, "1999"=V11, "2000"=V12, "2001"=V13, "2002"=V14, "2003"=V15, "2004"=V16, "2005"=V17, "2006"=V18, "2007"=V19, "2008"=V20, "2009"=V21, "2010"=V22, "2011"=V23, "2012"=V24, "2013"=V25, "2014"=V26, "2015"=V27, "2016"=V28) %>% 
  filter(state != "Commercial",
         state != "Industrial", 
         state != "Residential",
         state != "Transportation",
         state != "Electric Power")

#page 5
out5 <- out[[5]] %>%  
     as.data.frame() %>% 
  rename(state = V1, "1990" = V2, "1991"= V3, "1992"= V4, "1993"=V5, "1994"=V6, "1995"=V7, "1996"=V8, "1997"=V9, "1998"=V10, "1999"=V11, "2000"=V12, "2001"=V13, "2002"=V14, "2003"=V15, "2004"=V16, "2005"=V17, "2006"=V18, "2007"=V19, "2008"=V20, "2009"=V21, "2010"=V22, "2011"=V23, "2012"=V24, "2013"=V25, "2014"=V26, "2015"=V27, "2016"=V28) %>% 
  filter(state != "Commercial",
         state != "Industrial", 
         state != "Residential",
         state != "Transportation",
         state != "Electric Power")
```


Combining and Tidying
```{r}

emissions <- rbind(out1, out2, out3, out4, out5) %>% 
  gather(year, emission, 2:28) %>% 
   filter(state == "Maine" | state == "New Hampshire" | state == "Massachusetts" | state == "New Hampshire" | state == "Rhode Island" | state == "Connecticut" | state == "New York") %>% 
  mutate(year = as.numeric(year),
         emission = as.numeric(emission)) %>% 
  mutate(end_target = case_when(state == "Maine" ~ (23.64 - 0.8*(23.64)), #targets for clean energy from Beyond Carbon
                            state == "New Hampshire" ~ (14.59 - 0.8*(14.59)),
                            state == "Connecticut" ~ (41.53 - 0.8*(41.53)),
                            state == "Massachusetts" ~ (83.09 - 0.8*(83.09)),
                            state == "New York" ~ (207.82 - 0.8*(207.82)),
                            state == "Rhode Island" ~ (8.91 - 0.8*(8.91))))

#save
write.csv(emissions, file = "data/emissions")

```

Visualize emmissions
```{r}

graph_em <-ggplot(emissions)+
  geom_line(aes(x=year, y = emission, color=state))+
  ggtitle("Total Carbon Emissions") +
  ylab("Emissions (million metric tons)") +
  xlab("Year") +
  theme_classic() 

graph_em 
ggsave("figs/graph_em .jpg", width=7, height=5, dpi=300)

```

Regressions for trend targets


New Hampshire
```{r}

#NH 80% reduction below 1990 levels by 2050
nh_em <- emissions %>% 
  filter(state == "New Hampshire") %>% 
  filter(year >= 2004 & year <= 2017) %>% 
  mutate(year_n = seq(0:12))

#create tibble with the start (value in 2005) and end (goal in whichever year) to do a linear regression 
nh_em_target <- tribble(
  ~year, ~emission,
  0, 	21.8	,
  46, 2.92)

#super simple regression for equation to calculate the necessary percent clean emmisions each year to reach target
lm_nh_em <- lm(emission~ year, data = nh_em_target)
#coe =  -0.41   ; int= 21.80

nh_em_target <- nh_em %>% 
  mutate(target = ( -0.41  *year_n +21.80),
         emission = round(emission, digits= 2),
         target = round(target, digits= 2)) %>% 
  filter(year != "2004") %>% 
  select(year, state, emission, target)


```

Massachusetts
```{r}

#MA 80% reduction below 1990 levels by 2050
ma_em <- emissions %>% 
  filter(state == "Massachusetts") %>% 
  filter(year >= 2004 & year <= 2017)%>% 
  mutate(year_n = seq(0:12))

#create tibble with the start (value in 2005) and end (goal in whichever year) to do a linear regression 
ma_em_target <- tribble(
  ~year, ~emission,
  0, 82.6	,
  46, 16.6)

#super simple regression for equation to calculate the necessary percent clean emmisions each year to reach target
lm_ma_em <- lm(emission~ year, data = ma_em_target)
#coe=-1.43   ; int =82.60

ma_em_target <- ma_em %>% 
  mutate(target = (-1.43  *year_n +82.60 ),
         emission = round(emission, digits= 2),
         target = round(target, digits= 2)) %>% 
  filter(year != "2004") %>% 
  select(year, state, emission, target)

```

Rhode Island
```{r}

#RI 80% reduction below 1990 levels by 2050
ri_em <- emissions %>% 
  filter(state == "Rhode Island") %>% 
  filter(year >= 2004 & year <= 2017)%>% 
  mutate(year_n = seq(0:12))

#create tibble with the start (value in 2005) and end (goal in whichever year) to do a linear regression 
ri_em_target <- tribble(
  ~year, ~emission,
  0, 10.97,
  46, 1.78
)

#super simple regression for equation to calculate the necessary percent clean emmisions each year to reach target
lm_ri_em <- lm(emission~ year, data = ri_em_target)
#coe= -0.2 ; int = 11.0 

ri_em_target<- ri_em %>% 
    mutate(target = (-0.2*year_n+11.0 ),
         emission = round(emission, digits= 2),
         target = round(target, digits= 2)) %>% 
  filter(year != "2004") %>% 
  select(year, state, emission, target)

```


Connecticut
```{r}

#CT 80% reduction below 2001 levels by 2050
ct_em <- emissions %>% 
  filter(state == "Connecticut") %>% 
  filter(year >= 2004 & year <= 2017)%>% 
  mutate(year_n = seq(0:12))

#create tibble with the start (value in 2005) and end (goal in whichever year) to do a linear regression 
ct_em_target <- tribble(
  ~year, ~emission,
  0, 44.5	,
  46, 8.31)

#super simple regression for equation to calculate the necessary percent clean emmisions each year to reach target
lm_ct_em <- lm(emission~ year, data = ct_em_target)
#coef=-0.787; int = 44.500 

ct_em_target <- ct_em %>% 
  mutate(target = (-0.787 *year_n+44.500),
         emission = round(emission, digits= 2),
         target = round(target, digits= 2)) %>% 
  filter(year != "2004") %>% 
  select(year, state, emission, target)

```


New York
```{r}

#NY 80% reduction below 1990 levels by 2050
ny_em <- emissions %>% 
  filter(state == "New York") %>% 
  filter(year >= 2004 & year <= 2017) %>% 
  mutate(year_n = seq(0:12))

#create tibble with the start (value in 2005) and end (goal in whichever year) to do a linear regression 
ny_em_target <- tribble(
  ~year, ~emission,
  0, 215,
  46, 41.6)

#super simple regression for equation to calculate the necessary percent clean emmisions each year to reach target
lm_ny_em <- lm(emission~ year, data = ny_em_target)
#coe= -3.77 ; int = 215.00  

ny_em_target <- ny_em %>% 
  mutate(target = (-3.77 *year_n+215.00   ),
         emission = round(emission, digits= 2),
         target = round(target, digits= 2)) %>% 
  filter(year != "2004") %>% 
  select(year, state, emission, target)

```

Maine
  NO GOAL YEAR FOR EMISSION REDUCION 
```{r}

#MA 80% reduction below 2003 levels
me_em_target <- emissions %>% 
  filter(state == "Maine") %>% 
  filter(year >= 2005 & year <= 2017) %>% 
  rename(target = end_target)

```


Combine all states df with target
```{r}
emissions_target <- rbind(nh_em_target, ma_em_target, ri_em_target, ct_em_target, ny_em_target, me_em_target)

```


Calculate scores
```{r}
emissions_scores <- emissions_target %>% 
  mutate(score = target/emission,
         score = if_else(score >1, 1, score)) 
#save
write.csv(emissions_scores, file = "data/emissions_scores")

```

Visualize scores
```{r}  

graph_emissions_scores <-ggplot(emissions_scores)+
  geom_line(aes(x=year, y = score, color=state))+
  ggtitle("Carbon emission scores") +
  ylab("Score") +
  xlab("Year") +
  theme_classic() 
graph_emissions_scores
ggsave("figs/graph_emissions_scores.jpg", width=7, height=5, dpi=300)

```






