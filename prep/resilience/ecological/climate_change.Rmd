---
title: "OHIEC: Resilience - Climate Change Pressure prep"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
toc: true
---

# Summary

This script calculates fishing pressure resilience values by OHINE region. 

# Data

**Reference**: 

**Downloaded**: 

**Description**:  

**Time range**: 

**Format**: 

Regulations:
1) extract info from America's Pledge Report
2) American Council for Energy Efficiency:
Rankings: https://database.aceee.org/state/maine

Effectiveness:
US. energy information administration:
1) Total CO2 emissions https://www.epa.gov/statelocalenergy/state-co2-emissions-fossil-fuel-combustion
2) Total power generation:https://www.eia.gov/electricity/data/state/

Targets for effectiveness from Beyond Carbon https://www.beyondcarbon.org/look-up-your-state/maine


``` {r setup,  message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R')  ### an OHINE specific version of common.R

dir_git <- '~/github/ne-prep'
dir_anx <- file.path(dir_M, 'git-annex/neprep')

library(csv)
library(tidyverse)
library(dplyr)
library(Hmisc)
library(stringi)
library(readxl)

```


Data
```{r}

eee <- read_excel(file.path(dir_anx, "_raw_data/EEE/eee_scores.xlsx"))
raw_gen <- read_excel(file.path(dir_anx, "_raw_data/EIA/eia_annual_generation_state.xls"))

```


I am pretty sure we're going to use the pdf file from EPA of EIA emmisisons data from 1990 so if thats the case delete this file from the server "_raw_data/EIA/eia_co2_emmisions.xlsx" 

**Regualtions**
Energy Efficiency Scores
```{r}

#calculate
eee_score <- eee %>% 
  mutate(score = eee_score/eee_target)

#save
#write.csv(eee_score, file = "data/eee_score")

```

Visualize
```{r}

eee_score_graph <-ggplot(eee_score)+
  geom_point(aes(x=state, y = score), color="green4", size=2)+
  ggtitle("Energy Efficiency Score") +
  ylab("Score") +
  xlab("State") +
  theme_classic() 
eee_score_graph

```


**Effectivness**
Clean Power Generation

Issue: Lots of Pumped storage production is negative. What to do about that? Is it when the water gets pumped back up? 

Types of energy source:
Coal
Natural Gas
Nuclear
Other
Other Biomass
Other Gases
Petroleum
Wood and Wood Derived Fuels
[below I considered clean energy; need to look into the pumped storage because most of it is negative]
Pumped Storage
Hydroelectric Conventional
Wind
Solar Thermal and Photovoltaic

Renewable/Clean Power Targets (Beyond Carbon):
Maine = 40% by 2017
New Hampshire = 25.2% by 2025
Connecticut = 44% by 2030
Massachusetts = 35% 2030
New York = 50% by 2030
Rhode Island = 38.5% by 2035


Calculate total energy production in each state each year
```{r}
gen_total <- raw_gen %>% 
  filter(year >= 2005 & year <=2017) %>% 
  filter(state == "ME" | state == "NH" | state == "MA" | state == "RI" | state == "CT" | state == "NY") %>% 
  filter(energy_source != "Total") %>%
  select(year, state, gen_mwh) %>% 
  group_by(year, state) %>% 
  dplyr::summarise(total_power = sum(gen_mwh))
```

Calculate total clean/renewable energy production in each state each year
```{r}
gen_clean <- raw_gen %>% 
  filter(year >= 2005 & year <=2017) %>% 
  filter(state == "ME" | state == "NH" | state == "MA" | state == "RI" | state == "CT" | state == "NY") %>% 
  filter(energy_source == "Hydroelectric Conventional"| energy_source == "Wind" | energy_source == "Solar Thermal and Photovoltaic" | energy_source == "Pumped Storage") %>%
  select(year, state, gen_mwh) %>% 
  group_by(year, state) %>% 
  dplyr::summarise(total_power = sum(gen_mwh)) %>% 
  rename(total_power_clean = total_power )
```

Combine data sets and visualize percent of clean energy production
```{r}
power_gen <- left_join(gen_total, gen_clean, by= c("year", "state")) %>% 
  mutate(per_clean = total_power_clean/total_power)

graph_clean_pro <-ggplot(power_gen)+
  geom_line(aes(x=year, y = per_clean, color=state))+
  ggtitle("Percent of Clean/Renewable Energy Production") +
  ylab("Percent") +
  xlab("State") +
  theme_classic() 
graph_clean_pro

#ggsave("figs/graph_clean_pro.jpg", width=7, height=5, dpi=300)

```

Calculate scores
```{r}
power_gen_scores <- left_join(gen_total, gen_clean, by= c("year", "state")) %>% 
  mutate(per_clean = total_power_clean/total_power,
         target = case_when(state == "ME" ~ 0.4, #targets for clean energy from Beyond Carbon
                            state == "NH" ~ 0.252,
                            state == "CT" ~ 0.44,
                            state == "MA" ~ 0.35,
                            state == "NY" ~ 0.5,
                            state == "RI" ~ 0.385),
         score = per_clean/target,
         score = if_else(score >1, 1, score)) 

#save
#write.csv(power_gen_scores, file = "data/power_gen_scores")

```

Visualize scores
```{r}  

graph_clean_energy_score <-ggplot(power_gen_scores)+
  geom_line(aes(x=year, y = score, color=state))+
  ggtitle("Clean Energy Score") +
  ylab("Score") +
  xlab("Year") +
  theme_classic() 
graph_clean_energy_score  
#ggsave("figs/graph_clean_energy_score.jpg", width=7, height=5, dpi=300)

```



Carbon Emmissions

Carbon Emmission Targets (Beyond Carbon):
Maine= 80% reduction below 2003 levels
New Hampshire= 80% reduction below 1990 levels by 2050
Connecticut= 80% reduction below 2001 levels by 2050
Massachusetts= 80% reduction below 1990 levels by 2050
New York= 80% reduction below 1990 levels by 2050
Rhode Island= 80% reduction below 1990 levels by 2050

Converting table from a pdf from EPA website to a df
```{r}

library(tabulizer)
library(dplyr)

location <- 'https://www.epa.gov/sites/production/files/2017-09/documents/co2ffc_2015.pdf'
out <- extract_tables(location)

#page 1
out1 <- out[[1]] %>%  
  as.data.frame() %>% 
  rename(state = V1, blank = V2, "1990" = V3, "1991"= V4, "1992"= V5, "1993"=V6, "1994"=V7, "1995"=V8, "1996"=V9, "1997"=V10, "1998"=V11, "1999"=V12, "2000"=V13, "2001"=V14, "2002"=V15, "2003"=V16, "2004"=V17, "2005"=V18, "2006"=V19, "2007"=V20, "2008"=V21, "2009"=V22, "2010"=V23, "2011"=V24, "2012"=V25, "2013"=V26, "2014"=V27, "2015"=V28, "2016"=V29) %>% 
  filter(state != "State Sector",
         state != "Commercial",
         state != "Industrial", 
         state != "Residential",
         state != "Transportation",
         state != "Electric Power") %>% 
  select(-blank)
  
#page 2  
out2 <- out[[2]] %>% 
  as.data.frame() %>% 
  rename(state = V1, blank = V2, "1990" = V3, "1991"= V4, "1992"= V5, "1993"=V6, "1994"=V7, "1995"=V8, "1996"=V9, "1997"=V10, "1998"=V11, "1999"=V12, "2000"=V13, "2001"=V14, "2002"=V15, "2003"=V16, "2004"=V17, "2005"=V18, "2006"=V19, "2007"=V20, "2008"=V21, "2009"=V22, "2010"=V23, "2011"=V24, "2012"=V25, "2013"=V26, "2014"=V27, "2015"=V28, "2016"=V29) %>% 
  filter(blank != "Commercial",
         blank != "Industrial", 
         blank != "Residential",
         blank != "Transportation",
         blank != "Electric Power")%>% 
  select(-blank)

#page 3
out3 <- out[[3]] %>% 
   as.data.frame() %>% 
  rename(state = V1, "1990" = V2, "1991"= V3, "1992"= V4, "1993"=V5, "1994"=V6, "1995"=V7, "1996"=V8, "1997"=V9, "1998"=V10, "1999"=V11, "2000"=V12, "2001"=V13, "2002"=V14, "2003"=V15, "2004"=V16, "2005"=V17, "2006"=V18, "2007"=V19, "2008"=V20, "2009"=V21, "2010"=V22, "2011"=V23, "2012"=V24, "2013"=V25, "2014"=V26, "2015"=V27, "2016"=V28) %>% 
  filter(state != "Commercial",
         state != "Industrial", 
         state != "Residential",
         state != "Transportation",
         state != "Electric Power")

#page 4
out4 <- out[[4]] %>%  
   as.data.frame() %>% 
  rename(state = V1, "1990" = V2, "1991"= V3, "1992"= V4, "1993"=V5, "1994"=V6, "1995"=V7, "1996"=V8, "1997"=V9, "1998"=V10, "1999"=V11, "2000"=V12, "2001"=V13, "2002"=V14, "2003"=V15, "2004"=V16, "2005"=V17, "2006"=V18, "2007"=V19, "2008"=V20, "2009"=V21, "2010"=V22, "2011"=V23, "2012"=V24, "2013"=V25, "2014"=V26, "2015"=V27, "2016"=V28) %>% 
  filter(state != "Commercial",
         state != "Industrial", 
         state != "Residential",
         state != "Transportation",
         state != "Electric Power")

#page 5
out5 <- out[[5]] %>%  
     as.data.frame() %>% 
  rename(state = V1, "1990" = V2, "1991"= V3, "1992"= V4, "1993"=V5, "1994"=V6, "1995"=V7, "1996"=V8, "1997"=V9, "1998"=V10, "1999"=V11, "2000"=V12, "2001"=V13, "2002"=V14, "2003"=V15, "2004"=V16, "2005"=V17, "2006"=V18, "2007"=V19, "2008"=V20, "2009"=V21, "2010"=V22, "2011"=V23, "2012"=V24, "2013"=V25, "2014"=V26, "2015"=V27, "2016"=V28) %>% 
  filter(state != "Commercial",
         state != "Industrial", 
         state != "Residential",
         state != "Transportation",
         state != "Electric Power")
```


Combining and Tidying
```{r}

emissions <- rbind(out1, out2, out3, out4, out5) %>% 
  gather(year, emission, 2:28) %>% 
   filter(state == "Maine" | state == "New Hampshire" | state == "Massachusetts" | state == "New Hampshire" | state == "Rhode Island" | state == "Connecticut" | state == "New York") %>% 
  mutate(year = as.numeric(year),
         emission = as.numeric(emission))

#save
#write.csv(emissions, file = "data/emissions")

```

Visualize emmissions
```{r}

graph_em <-ggplot(emissions)+
  geom_line(aes(x=year, y = emission, color=state))+
  ggtitle("Total Carbon Emissions") +
  ylab("Emissions (million metric tons") +
  xlab("Year") +
  theme_classic() 

graph_em 
#ggsave("figs/graph_em .jpg", width=7, height=5, dpi=300)

```

Calculate Emmisions Scores
```{r}

em_scores <- emissions %>% 
  mutate(target = case_when(state == "Maine" ~ (23.64 - 0.8*(23.64)), #targets for clean energy from Beyond Carbon
                            state == "New Hampshire" ~ (14.59 - 0.8*(14.59)),
                            state == "Connecticut" ~ (41.53 - 0.8*(41.53)),
                            state == "Massachusetts" ~ (83.09 - 0.8*(83.09)),
                            state == "New York" ~ (207.82 - 0.8*(207.82)),
                            state == "Rhode Island" ~ (8.91 - 0.8*(8.91))),
         score = target/emission,
         score = if_else(score >1, 1, score)) %>% 
  filter(year >= 2005 & year <= 2017)

#write.csv(em_scores, file = "data/em_scores")

```

Visualize scores
```{r}

graph_em_scores <-ggplot(em_scores)+
  geom_line(aes(x=year, y = score, color=state))+
  ggtitle("Emission Scores") +
  ylab("Score") +
  xlab("Year") +
  theme_classic() 

graph_em_scores
#ggsave("figs/graph_em_scores .jpg", width=7, height=5, dpi=300)

```








