---
title: "OHIEC: Resilience - EPA ECHO prep"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(csv)
library(dplyr)
library(tidyverse)
```

# need to link the raw data on the server

# Summary

This layer calculates the resilience of each region to water pollution

**Data** EPA ECHO https://echo.epa.gov/tools/data-downloads 

ICIS-NPDES National Data Set 
Permit Limit and DMR Data by Jurisdiction

**Target** EPA established ‘National Goals’: 
1. 50% for inspector coverage (can't find the inspector coverage)
2. 95% for monitoring report submission
3. 0% for compliance violations.


**Regulation:** 
Every state will get a score of 1 since there are permits issued in all states

**Monitoring:**
1. Percentage of facilities that were inspected by state
Used NPDES_INSPECTIONS.csvcsv

2. Percentage of expected reports submitted
Used the data from-> "Permit Limit and DMR Data by Jurisdiction
An NA value for DAYS_LATE column means that it was never submitted. Code in NODI column explains why

**Compliance:**
Percentage of facilities with violations
used NPDES_QNCR_HISTORY.csv


```{r}

#data needed, will need to add and link to server

NPDES_INSPECTIONS.csv <- read_csv("Desktop/notebook_data/NPDES_INSPECTIONS.csv")
NPDES_QNCR_HISTORY <- read_csv("Desktop/npdes_downloads/NPDES_QNCR_HISTORY.csv")
ICIS_FACILITIES <- read_csv("Desktop/npdes_downloads/ICIS_FACILITIES.csv")
ME_FY2009_NPDES_DMRS
#the rest of the report data. all 54 of them!


```

#**Monitoring**
##Inspections

```{r}

fac <- ICIS_FACILITIES

inspec <- NPDES_INSPECTIONS

inspec <- inspec %>% 
  select(NPDES_ID, ACTUAL_END_DATE) %>%
  separate(ACTUAL_END_DATE, c("month", "day", "year"), sep = "/") %>% 
  select(NPDES_ID, year)%>%
  filter(year >=2005 & year <=2017) %>% 
  mutate(ID = NPDES_ID) %>% 
  mutate(year2 = year) %>% 
  unite(key, c("ID", "year2"), sep = "-") %>% 
  mutate(inspec = "1") %>% 
  select(key, inspec)

fac <- fac %>% 
  select(NPDES_ID) %>% 
  mutate("2005" = "2005") %>% 
  mutate("2006" = "2006") %>% 
  mutate("2007" = "2007") %>% 
  mutate("2008" = "2008") %>% 
  mutate("2009" = "2009") %>% 
  mutate("2010" = "2010") %>% 
  mutate("2011" = "2011") %>% 
  mutate("2012" = "2012") %>% 
  mutate("2013" = "2013") %>% 
  mutate("2014" = "2014") %>% 
  mutate("2015" = "2015") %>% 
  mutate("2016" = "2016") %>% 
  mutate("2017" = "2017") %>% 
  gather(year, year2, 2:14) %>% 
  mutate(ID = NPDES_ID) %>% 
  unite(key, c("ID", "year2"), sep = "-")

all_inspec <- left_join(fac, inspec, by = "key") 

all_inspec$inspec[is.na(all_inspec$inspec)] <- 0
all_inspec$state <- substr(all_inspec$NPDES_ID, 0, 2)

inspections_simple <- all_inspec %>% 
  select(NPDES_ID, year, state, inspec) %>% 
  filter(state == "ME" | state == "NH" | state == "MA" | state =="RI" | state == "CT" | state == "NY")
  
###inspections stats
#total number of facilities in each state

num_fac <- inspections_simple %>% 
  select(state, year, NPDES_ID) %>% 
  group_by(year, state) %>% 
  count() %>% 
  ungroup() %>% 
  rename(fac_total = n) %>% 
  unite(year_state, c("year", "state"))

#total num inspections
num_fac_inspec <- inspections_simple %>% 
  filter(inspec == 1) %>% 
  select(state, year, NPDES_ID) %>% 
  group_by(year, state) %>% 
  count() %>% 
  ungroup() %>% 
  rename(fac_inspection = n)%>% 
  unite(year_state, c("year", "state"))

percen_fac_insp <- left_join(num_fac, num_fac_inspec, by = "year_state") %>% 
  separate(year_state, c("year", "state"), sep = "_") %>% 
  mutate(percent_w_inspections = fac_inspection/fac_total)

percen_fac_insp$year <- as.numeric(percen_fac_insp$year)

#save data
#write_csv(percen_fac_insp, file = "facility_inspections")

graph <- ggplot(percen_fac_insp) +
  geom_line(aes(x= year, y = percent_w_inspections, color= state))+
 ggtitle("Percentage of Facilities Inspected in NE") +
  ylab("Percent") +
  xlab("Year") +
  theme_classic()+
  geom_hline(yintercept=0.5)
graph
  
```

Potential Issue:
potential correlation with number of inspections and the number of violations

##Report Submissions

2009 Maine
**ask about looping? wierd because all in seperate csvs

```{r}

maine_2009 <- ME_FY2009_NPDES_DMRS

maine_2009$DAYS_LATE[is.na(maine_2009$DAYS_LATE)] <- 0

test <- maine_2009 %>% 
  select(EXTERNAL_PERMIT_NMBR, DAYS_LATE) %>% 
  filter(DAYS_LATE == 0)

#expected 85510 reports
# did not receive 53585

#percentage reports submitted in main 2009
53585/85510 #62.67%

```



#**Compliance**
##Violations
percentage of facilities with compliance regualtions

```{r}

violations <- NPDES_QNCR_HISTORY

violations$state <- substr(violations$NPDES_ID, 0, 2)
violations$year <- substr(violations$YEARQTR, 0, 4)

##total violations by state
vios_total <- violations %>% 
  filter(year >=2005 & year <=2017) %>% 
  filter(state == "ME" | state == "NH" | state == "MA" | state =="RI" | state == "CT" | state == "NY") %>% 
  select(year, state, NUME90Q, NUMCVDT, NUMSVCD, NUMPSCH) %>% 
  group_by(year, state) %>% 
  count()

#every state has had a violation in the given time frame

## percent of facilities with violations by state
fac <- ICIS_FACILITIES

fac <- fac %>% 
  select(NPDES_ID) %>% 
  mutate("2005" = "2005") %>% 
  mutate("2006" = "2006") %>% 
  mutate("2007" = "2007") %>% 
  mutate("2008" = "2008") %>% 
  mutate("2009" = "2009") %>% 
  mutate("2010" = "2010") %>% 
  mutate("2011" = "2011") %>% 
  mutate("2012" = "2012") %>% 
  mutate("2013" = "2013") %>% 
  mutate("2014" = "2014") %>% 
  mutate("2015" = "2015") %>% 
  mutate("2016" = "2016") %>% 
  mutate("2017" = "2017") %>% 
  gather(year, year2, 2:14) %>% 
  mutate(ID = NPDES_ID) %>% 
  unite(key, c("ID", "year2"), sep = "-")

vios <- violations %>% 
  filter(year >=2005 & year <=2017) %>% 
  filter(state == "ME" | state == "NH" | state == "MA" | state =="RI" | state == "CT" | state == "NY") %>% 
  select(NPDES_ID, year, state, NUME90Q, NUMCVDT, NUMSVCD, NUMPSCH) %>% 
  group_by(NPDES_ID, year) %>% 
  count() %>% 
  unite(key, c("NPDES_ID", "year"), sep = "-") 

all_vio <- left_join(fac, vios, by = "key") 
all_vio$n[is.na(all_vio$n)] <- 0
all_vio$state <- substr(all_vio$NPDES_ID, 0, 2)

violations_fac <- all_vio %>% 
  mutate(violation = case_when(
    n > 0 ~ "1", 
    n == 0 ~ "0")) %>% 
  select(NPDES_ID, year, state, violation) %>% 
  filter(year >=2005 & year <=2017) %>% 
  filter(state == "ME" | state == "NH" | state == "MA" | state =="RI" | state == "CT" | state == "NY") 

#total number of facilities in each state

num_fac <- violations_fac %>% 
  select(state, year, NPDES_ID) %>% 
  group_by(year, state) %>% 
  count() %>% 
  ungroup() %>% 
  rename(fac_total = n) %>% 
  unite(year_state, c("year", "state"))

#total num violations
num_fac_vio <- violations_fac %>% 
  filter(violation == 1) %>% 
  select(state, year, NPDES_ID) %>% 
  group_by(year, state) %>% 
  count() %>% 
  ungroup() %>% 
  rename(fac_violations = n)%>% 
  unite(year_state, c("year", "state"))

percen_fac_vio <- left_join(num_fac, num_fac_vio, by = "year_state") %>% 
  separate(year_state, c("year", "state"), sep = "_") %>% 
  mutate(percent_w_violations = fac_violations/fac_total)

#save data
#write_csv(percen_fac_vio, file = "facility_violations")
percen_fac_vio$year <- as.numeric(percen_fac_vio$year)

graph <- ggplot(percen_fac_vio) +
  geom_line(aes(x= year, y = percent_w_violations, color= state)) +
  ggtitle("Percentage of Facilities with Violations in NE") +
  ylab("Percent") +
  xlab("Year") +
  theme_classic()
graph


```

Need to talk through the violations that we consider "bad" right now I am aggregated all of them, but there are multiple kinds




