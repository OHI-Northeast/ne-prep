---
title: "OHINE: Fishing Resilience - Fish Landed with Stock Assessments Data Prep"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
toc: true
---

# Summary

This script calculates the percent of species with stock assessments that are adequately assessed.This data is used to measure fishing resilience regulations.

# Data

**1.RAM**
**Downloaded**: February 28, 2018 from ramlegacy.org

**Description**:  RAM Legacy Stock Assessment Database provides information on global fish stocks including catch, B/Bmsy and F/Fmsy among other metrics.

**Time range**: pre-1900 to 2016

**Format**:  Tabular


**2. NOAA fisheries**
**Downloaded**: December 14, 2018 (emailed to us by Jeffrey Vieser at NMFS)

**Description**:  Records of Bmsy and Fmsy estimates from stock assessments conducted in the greater Northeast region

**Time range**: 2004 - 2018

**Format**:  Tabular

# About
This script calculates the percent of species with stock assessment that are adequately assessed. The target is a formal stock assessment completed at least once in the past 5 years. This target was informed by Jeffery Vieser, and is the same metric used in FSSI.

# Methods

## Set up, libraries, load data
``` {r setup,  message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R')  ### an OHINE specific version of common.R

dir_git <- '~/github/ne-prep'
dir_anx <- file.path(dir_M, 'git-annex/neprep')

library(csv)
library(tidyverse)
library(dplyr)
library(readxl)
```


Only have SA data back to 2004 for nmfs, will be harder to determine adequately assessed in 2005-2008

Load Data
```{r load_data}
nmfs_stock_ass <- read_csv("~/github/ne-prep/prep/fis/data/nmfs_stock_assessment_data.csv")%>% select(-X1)
ram_stock_ass  <- read_csv("~/github/ne-prep/prep/fis/data/ram_stock_assessment_data.csv")%>% select(-X1)
nmfs_catch_raw <- read.csv("~/github/ne-prep/prep/fis/data/nmfs_spatial_catch_by_ohi_rgn.csv")
```

## Tidy data
**code below the same as in 5_assessed_species_lookuptable, except that the year is getting kept throughout**
```{r catch_tidy}
nmfs_catch <- nmfs_catch_raw %>%
  mutate(nmfs_original_species = as.character(species),
         species_low = tolower(species)) %>%
  select(nmfs_original_species, species_low, year) %>%
  distinct()
```

Grab all species from NMFS catch data and get them, as well as their alternative names, cleaned up
```{r grab_species_caught_tidy}
nmfs_catch_sp <- nmfs_catch %>%
  separate(species_low, into = c("species1", "species2", "species3"), sep = ",", remove = FALSE) %>%
  mutate(species2 = trimws(gsub("\\/.*","", species2))) %>%
  separate(species_low, into = c("alt_name1", "alt_name2", "alt_name3"), sep = "/", remove = FALSE) %>%
  mutate(nmfs_catch = str_replace_all(paste0(species3, " ", species2, " ", species1), "NA ", ""),
         nmfs_catch = trimws(gsub("\\/.*","", nmfs_catch)),
         nmfs_catch_alternate = case_when(
          !is.na(alt_name2) ~ alt_name2,
          TRUE ~ NA_character_),
         nmfs_catch_alternate_2 = case_when(
          !is.na(alt_name3) ~ alt_name3,
          TRUE ~ NA_character_)) %>%
  select(species_low, nmfs_catch, nmfs_catch_alternate, nmfs_catch_alternate_2, year) %>%
  mutate(nmfs_catch2              = ifelse(str_detect(nmfs_catch_alternate, "mixed"), 
                                         paste0(nmfs_catch, " ", nmfs_catch_alternate), NA),
         nmfs_species             = ifelse(!is.na(nmfs_catch2), tolower(nmfs_catch2), tolower(nmfs_catch)),
         nmfs_species_alternate   = trimws(ifelse(str_detect(nmfs_catch_alternate, "mixed"), NA, 
                                                tolower(nmfs_catch_alternate)), "both"),
         nmfs_species_alternate_2 = trimws(tolower(nmfs_catch_alternate_2)), "both") %>% 
  select(year, species_low, nmfs_species, nmfs_species_alternate, nmfs_species_alternate_2) %>%
  mutate(species = nmfs_species)
```

Get NMFS stock assessment data species
```{r stock_assesments_NMFS}
nmfs_stock_years <- nmfs_stock_ass %>%
  select(year, stock) %>%
  distinct() %>%
  separate(stock, into = c("species", "location"), sep = " - ") %>%
  mutate(species = tolower(species),
         source = "NMFS",
         stockid = NA)
```

Get RAM stock species
```{r stock_assesments_RAM}
ram_years <- ram_stock_ass %>%
  select(year, commonname, areaname, stockid) %>%
  distinct() %>%
  mutate(species = tolower(commonname),
         source      = "RAM",
         location = as.character(areaname)) %>%
  select(-commonname, -areaname) #create a duplicate column "species" to match with noaa
```

First I want to combine the RAM and NMFS Stock assessment data since they have location data too
```{r combine_stock_ass}
stock_matching <- nmfs_stock_years %>%
  bind_rows(ram_years)
```

Now combine catch species with stocks. Lots of data wrangling here to get these species to matchup correctly
I added this part in case we wanted to do the percentage of species landed with stock assessments each year instead of ever. But this is not necessary for finding out if stocks are properly assessed
```{r exploring_over_time}
comb <- stock_matching %>%
  left_join(nmfs_catch_sp) %>%
  select(species_low, species, location, source, nmfs_species, stockid, year) %>%
  left_join(nmfs_catch_sp, by = c("species" = "nmfs_species_alternate", "year")) %>%
  mutate(nmfs_species = ifelse(is.na(nmfs_species.x), nmfs_species.y, nmfs_species.x)) %>%
  select(species_low = species_low.x, species, location, source, nmfs_species, stockid, year) %>%
  left_join(nmfs_catch_sp, by = c("nmfs_species", "year")) %>%
  mutate(species_low = ifelse(is.na(species_low.x), species_low.y, species_low.x)) %>%
  select(-species.y, -species_low.y, -species_low.x) %>%
  rename(species = species.x) %>%
  mutate(nmfs_species_fix = case_when(  #manually making some fixes for species that are found in both but aren't matching
    species == "atlantic bluefin tuna" ~ "bluefin tuna",
    species == "bigeye tuna" ~ "big eye tuna",
    species == "atlantic surfclam" ~ "surf clam",
    species == "atlantic cod" ~ "cod",
    species == "red deepsea crab" ~ "red crab",
    species == "american plaice" ~ "american plaice flounder",
    species == "atlantic menhaden" ~ "menhaden",
    species == "goosefish" ~ "monkfish",
    species == "acadian redfish" ~ "redfish",
    species == "little skate" ~ "little (summer) skate",
    species == "winter skate" ~ "winter (big) skate", #we still see winter and little skate wings reported in catch...fixed below
    species == "atlantic wolffish" ~ "wolffish",
    species == "longfin inshore squid" ~ "squid", #the NMFS catch data has longfin and shortfin (loligo and illex). but stock assessment data just has longfin
    TRUE ~ NA_character_
  ),
  nmfs_species = ifelse(is.na(nmfs_species), nmfs_species_fix, nmfs_species),
  nmfs_species_alternate = ifelse(nmfs_species == 'squid', "loligo", nmfs_species_alternate)) %>%
  select(species_low, 
         stockid,
         stock_assessment_species_name = species, 
         stock_assessment_species_location = location,
         source,
         nmfs_catch_species_name = nmfs_species, 
         nmfs_catch_species_name2 = nmfs_species_alternate_2,
         year) %>%
  mutate(species_low = case_when(
    nmfs_catch_species_name == "cod" ~ "cod",
    nmfs_catch_species_name == "big eye tuna" ~ "tuna, big eye",
    nmfs_catch_species_name == "bluefin tuna" ~ "tuna, bluefin",
    nmfs_catch_species_name == "american plaice flounder" ~ "flounder, american plaice /dab",
    nmfs_catch_species_name == "surf clam" ~ "clam, surf",
    nmfs_catch_species_name == "red crab" ~ "crab, red",
    nmfs_catch_species_name == "menhaden" ~ "menhaden",
    nmfs_catch_species_name == "monkfish" ~ "monkfish / anglerfish / goosefish",
    nmfs_catch_species_name == "redfish" ~ "redfish / ocean perch",
    nmfs_catch_species_name == "little (summer) skate" ~ "skate, little (summer)",
    nmfs_catch_species_name == "winter (big) skate" ~ "skate, winter (big)",
    nmfs_catch_species_name == "wolffish" ~ "wolffish / ocean catfish",
    nmfs_catch_species_name == "squid" ~ "squid / loligo",
    TRUE ~ as.character(species_low)
  )) %>%
  left_join(nmfs_catch) %>% #add in the original catch (uppercase)
select(year, nmfs_original_species, stock_assessment_species_name, stock_assessment_species_location, stockid, source)
```

Fixing the skate wings and monk fish pieces matching. Skates and Monkfish are reported in NMFS catch as full fish as well as pieces (wings, livers, heads). I'm sure there is a nice way to incorporate these species names into the data above but I'm doing it manually here...
```{r tidy_weird_names}
add_species <- data.frame(stock_assessment_species_name = c("little skate", "winter skate", "smooth skate", "goosefish", "goosefish", "goosefish", "goosefish", "goosefish", "goosefish", "tilefish", "tilefish"),
                          stock_assessment_species_location = c("Georges Bank / Southern New England", 
                                                                "Georges Bank / Southern New England",
                                                                "Gulf of Maine",
                                                                "Gulf of Maine / Northern Georges Bank",
                                                                "Gulf of Maine / Northern Georges Bank",
                                                                "Gulf of Maine / Northern Georges Bank",
                                                                "Southern Georges Bank / Mid-Atlantic",
                                                                "Southern Georges Bank / Mid-Atlantic",
                                                                "Southern Georges Bank / Mid-Atlantic",
                                                                "Mid-Atlantic Coast",
                                                                "Mid-Atlantic Coast"),
                          source = "NMFS",
                          nmfs_original_species = c("SKATE WINGS, LITTLE (SUMMER)", "SKATE WINGS, WINTER (BIG)", "SKATE, SMOOTH", 
                                                    "MONK HEADS", "MONK LIVERS", "MONK TAILS", "MONK HEADS", "MONK LIVERS", "MONK TAILS", "TILEFISH, BLUELINE", "TILEFISH, GOLDEN"),
                          stockid = NA)
```

Combine the two datasets to get the full lookup table
```{r create_full_table}
full_df <- comb %>%
  bind_rows(add_species)
```

```{r stocks_to_rgns}
#list of stocks and their rgn_ids
match_areas_to_stocks <- read.csv("~/github/ne-prep/prep/fis/data/nmfs_spatial_catch_by_ohi_rgn.csv", stringsAsFactors = F) %>%
  select(species, stock_id, stock, rgn_id, rgn_name) %>%
  filter(!is.na(stock_id)) %>%
  distinct() %>%
  mutate(stock_assessment_species_location = case_when(
    stock_id == "CODGBE" ~ "Eastern Georges Bank",
    stock_id == "CODGBW" ~ "Georges Bank",
    stock_id == "CODGMSS" ~ "Gulf of Maine",
    stock_id == "PLAGMMA" ~ "Gulf of Maine / Georges Bank",
    stock_id == "FLDSNEMA" ~ "Southern New England / Mid-Atlantic",
    stock_id == "FLGMGBSS" ~ "Gulf of Maine / Georges Bank",
    stock_id == "FLWGB" ~ "Georges Bank",
    stock_id == "FLWGMSS" ~ "Gulf of Maine",
    stock_id == "FLWSNEMA" ~ "Southern New England / Mid-Atlantic",
    stock_id == "WITGMMA" ~ "Northwestern Atlantic Coast",
    stock_id == "YELCCGM" ~ "Cape Cod / Gulf of Maine",
    stock_id == "YELGB" ~ "Georges Bank",
    stock_id == "YELSNE" ~ "Southern New England / Mid-Atlantic",
    stock_id == "HADGBE" ~ "Eastern Georges Bank",
    stock_id == "HADGBW" ~ "Georges Bank",
    stock_id == "HADGM" ~ "Gulf of Maine",
    stock_id == "HKRGMNGB" ~ "Gulf of Maine / Northern Georges Bank",
    stock_id == "HKRSGBMA" ~ "Southern Georges Bank / Mid-Atlantic",
    stock_id == "HKSGMNGB" ~ "Gulf of Maine / Northern Georges Bank",
    stock_id == "HKSSGBMA" ~ "Southern Georges Bank / Mid-Atlantic", 
    stock_id == "HKWGMMA" ~ "Gulf of Maine / Georges Bank",
    stock_id == "HALGMMA" ~ "Northwestern Atlantic Coast",
    stock_id == "OPTGMMA" ~ "Northwestern Atlantic Coast",
    stock_id == "POKGMASS" ~ "Gulf of Maine / Georges Bank",
    stock_id == "REDGMGBSS" ~ "Gulf of Maine / Georges Bank",
    stock_id == "WOLGMMA" ~ "Gulf of Maine / Georges Bank"
  ))
```

Match
```{r match_areas_to_stocks}
m <- full_df %>%
  left_join(match_areas_to_stocks, by = c("nmfs_original_species" = "species", "stock_assessment_species_location")) %>%
  mutate(stockid = ifelse(is.na(stock_id), stockid, stock_id)) %>%
  select(-stock_id)
```

There are still species with stock assessments that do not have `stockid` in the NMFS catch dataset.
```{r filter_no_ids}
filter(m, is.na(stockid)) %>% .$stock_assessment_species_name %>% unique()
```

These species do not have multiple stocks within our region, so we can use the OHI regions where they are caught to identify where they are. The one issue is Goosefish/Monkfish. There are two stocks (Southern Georges Bank / Mid-Atlantic and Gulf of Maine / Northern Georges Bank). Let's look at these two areas, which are used for other stocks, and see what OHI areas this includes.

Regions in Southern New England/Mid Atlantic include
```{r filter_southern_location}
sgb <- filter(m, stock_assessment_species_location == "Southern Georges Bank / Mid-Atlantic") %>%
  select(rgn_id, rgn_name, stock_assessment_species_location) %>%
  distinct()
sgb
```

```{r filter_gom_locations}
gom <- filter(m, stock_assessment_species_location == "Gulf of Maine / Northern Georges Bank") %>%
  select(rgn_id, rgn_name, stock_assessment_species_location) %>%
  distinct() 
gom
```

Regions 2 and 8 are in both (MA-Virginian and Georges Bank). I think we can use these distinctions to assign regions to the Goosefish/Monkfish scores.
```{r assign_monkfish_scores}
goosefish <- gom %>%
  bind_rows(sgb) %>%
  filter(!is.na(rgn_id)) %>%
  mutate(stock_assessment_species_name = "goosefish")

m2 <- m %>%
  left_join(goosefish, by = c("stock_assessment_species_name", "stock_assessment_species_location")) %>%
  mutate(rgn_id = ifelse(is.na(rgn_id.y), rgn_id.x, rgn_id.y),
         rgn_name = ifelse(is.na(rgn_name.y), rgn_name.x, rgn_name.y)) %>%
  select(-rgn_id.y, -rgn_id.x, -rgn_name.y, -rgn_name.x)
```

Now lets just get all OHI regions where the remaining stocks are caught. The easier alternative to this would be to assign all OHI regions to all of these stocks, but if this data is used outside of scores that would possibly indicate stocks existing where they do not.
```{r left_overs}
leftovers <- m2 %>%
  filter(is.na(rgn_id))

#filter catch for these leftover species
leftovers_catch <- read.csv("~/github/ne-prep/prep/fis/data/nmfs_spatial_catch_by_ohi_rgn.csv", stringsAsFactors = F) %>%
  filter(species %in% leftovers$nmfs_original_species) %>%
  select(species, rgn_id, rgn_name) %>%
  distinct()
```

```{r create_complete_data}
comp_dataset <- m2 %>%
  left_join(leftovers_catch, by = c("nmfs_original_species" = "species")) %>%
  mutate(rgn_id = ifelse(is.na(rgn_id.y), rgn_id.x, rgn_id.y),
         rgn_name = ifelse(is.na(rgn_name.y), rgn_name.x, rgn_name.y)) %>%
  select(-rgn_id.y, -rgn_id.x, -rgn_name.y, -rgn_name.x)
```

```{r time_series_assessed}
time_series_assessed <- m2 %>%
  left_join(comp_dataset, by =  c("year", "nmfs_original_species", "stock_assessment_species_name", "stock_assessment_species_location", "stockid", "source", "stock")) %>%
  mutate(rgn_id = ifelse(is.na(rgn_id.y), rgn_id.x, rgn_id.y),
         rgn_name = ifelse(is.na(rgn_name.y), rgn_name.x, rgn_name.y)) %>%
  select(-rgn_id.y, -rgn_id.x, -rgn_name.y, -rgn_name.x) %>% 
  filter(!is.na(year)) %>%   #peices of skates andmonk fish, and both golden and bluelined tilefish
  unite(stock_long, stock_assessment_species_name, stock_assessment_species_location, sep = "-") %>% 
  select(year, stock_long, rgn_id, rgn_name) %>%
  filter(year >=2001 & year <= 2017) %>% 
  mutate(ass= 1) 
 # group_by(stock_long)
  #ungroup() 
```

Some species have a stock assessments done but not landed so the region shows up as NA. This is because the joining column is based NNMFS original species name which comes from the species caught each year. I want to give those states credit for doing stock assessments, so I manually added the missing species below
```{r remove_no_locs}
#id the species with no region associated with it
noloc <- time_series_assessed %>% 
  filter(is.na(rgn_name))

unique(noloc$stock_long)

#create df of just the regions
regions <- time_series_assessed %>% 
  select(rgn_name, rgn_id) %>% 
  distinct() %>% 
  filter(!is.na(rgn_name))
```

sea scallop-Northwestern Atlantic Coast
```{r fix_reg_scallops}
regions_scal <- regions %>% 
  rbind(regions)

scallop <- time_series_assessed %>% 
  filter(is.na(rgn_name),
         stock_long == "sea scallop-Northwestern Atlantic Coast") %>% 
  slice(rep(1:n(), each = 11)) %>% 
  select(year, stock_long, ass) %>% 
  cbind(regions_scal)
```

tilefish-Mid-Atlantic Coast
```{r fix_reg_tile}
regions_tile <- regions %>% 
  rbind(regions)

tile <- time_series_assessed %>% 
  filter(is.na(rgn_name),
         stock_long == "tilefish-Mid-Atlantic Coast") %>% 
  slice(rep(1:n(), each = 11)) %>% 
  select(year, stock_long, ass) %>% 
  cbind(regions_tile)
```

rosette skate-Southern New England / Mid-Atlantic
```{r fix_reg_ros_skate}
regions_ros <- regions %>% 
  slice(rep(row_number(), 10)) # 10 is the number years

ros <- time_series_assessed %>% 
  filter(is.na(rgn_name),
         stock_long == "rosette skate-Southern New England / Mid-Atlantic") %>% 
  slice(rep(1:n(), each = 11)) %>% # 11 is the number of regions that this fish is 
  select(year, stock_long, ass) %>% 
  cbind(regions_ros)
```

thorny skate-Gulf of Maine
```{r fix_reg_thorn_skate}
regions_th_sk <- regions %>% 
  slice(rep(row_number(), 3)) %>% 
  filter(rgn_id == 2 | rgn_id == 3 | rgn_id == 6 | rgn_id == 7 | rgn_id == 8 | rgn_id == 9)

th_sk <- time_series_assessed %>% 
  filter(is.na(rgn_name),
         stock_long == "thorny skate-Gulf of Maine"  ) %>% 
  slice(rep(1:n(), each = 6)) %>% 
  select(year, stock_long, ass) %>% 
  cbind(regions_th_sk)
```

blue marlin-Atlantic Ocean
```{r fix_reg_blue_mar}
regions_blue_marlin <- regions %>% 
  slice(rep(row_number(), 10)) 

blue_marlin <- time_series_assessed %>% 
  filter(is.na(rgn_name),
         stock_long == "blue marlin-Atlantic Ocean" ) %>% 
  slice(rep(1:n(), each = 11)) %>% 
  select(year, stock_long, ass) %>% 
  cbind(regions_blue_marlin)
```

skipjack tuna-Western Atlantic
```{r fix_reg_skip_tuna}
regions_skip_tuna <- regions %>% 
  slice(rep(row_number(), 8)) %>% 
  filter(rgn_id == 1 | rgn_id == 2 |rgn_id == 4 | rgn_id == 5 |rgn_id == 8 | rgn_id == 10 | rgn_id == 11)

skip_tuna <- time_series_assessed %>% 
  filter(is.na(rgn_name),
         stock_long == "skipjack tuna-Western Atlantic" ) %>% 
  slice(rep(1:n(), each = 7)) %>% 
  select(year, stock_long, ass) %>% 
  cbind(regions_skip_tuna)
```

white marlin-Atlantic Ocean
```{r fix_reg_white_mar}
regions_white_marlin <- regions %>% 
  slice(rep(row_number(), 10))

white_marlin <- time_series_assessed %>% 
  filter(is.na(rgn_name),
         stock_long == "white marlin-Atlantic Ocean" ) %>% 
  slice(rep(1:n(), each = 11)) %>% 
  select(year, stock_long, ass) %>% 
  cbind(regions_white_marlin)
```

atlantic salmon-Gulf of Maine
```{r fix_reg_atl_sal}
regions_salmon <- regions %>% 
  slice(rep(row_number(), 2)) %>% 
  filter(rgn_name == "Gulf of Maine")

salmon <- time_series_assessed %>% 
  filter(is.na(rgn_name),
         stock_long == "atlantic salmon-Gulf of Maine") %>%   # assuming only caught in the GOM because don't have more info
  select(year, stock_long, ass) %>% 
  cbind(regions_salmon)
```

clearnose skate-Southern New England / Mid-Atlantic
```{r fix_reg_clear_skate}
regions_clear_sk <- regions %>% 
  slice(rep(row_number(), 7))%>% 
  filter(rgn_id == 2 | rgn_id == 4 |rgn_id == 5 | rgn_id == 8 |rgn_id == 10 | rgn_id == 11 )

clear_sk <- time_series_assessed %>% 
  filter(is.na(rgn_name),
         stock_long == "clearnose skate-Southern New England / Mid-Atlantic" ) %>% 
  slice(rep(1:n(), each = 6)) %>% 
  select(year, stock_long, ass) %>% 
  cbind(regions_clear_sk)
```

smooth skate-Gulf of Maine
```{r fix_reg_smooth_skate}
regions_smooth_sk <- regions %>% 
  slice(rep(row_number(), 5))%>% 
  filter(rgn_id == 3 | rgn_id == 4 |rgn_id == 7 | rgn_id == 10)

smooth_sk <- time_series_assessed %>% 
  filter(is.na(rgn_name),
         stock_long == "smooth skate-Gulf of Maine" ) %>% 
  slice(rep(1:n(), each = 4)) %>% 
  select(year, stock_long, ass) %>% 
  cbind(regions_smooth_sk )
```

bigeye tuna-Atlantic Ocean
```{r fix_reg_bigeye_tuna}
regions_big_tuna <- regions %>% 
  slice(rep(row_number(), 6))%>% 
  filter(rgn_id == 1 | rgn_id == 2 |rgn_id == 4 | rgn_id == 10 | rgn_id == 8)

big_tuna <- time_series_assessed %>% 
  filter(is.na(rgn_name),
         stock_long == "bigeye tuna-Atlantic Ocean" ) %>% 
  slice(rep(1:n(), each = 5)) %>% 
  select(year, stock_long, ass) %>% 
  cbind(regions_big_tuna )
```

sailfish-Western Atlantic
```{r fix_reg_sail}
regions_sail <- regions %>% 
  slice(rep(row_number(), 8))

sail <- time_series_assessed %>% 
  filter(is.na(rgn_name),
         stock_long == "sailfish-Western Atlantic" ) %>% 
  slice(rep(1:n(), each = 11)) %>% 
  select(year, stock_long, ass) %>% 
  cbind(regions_sail)
```

swordfish-Northern Atlantic
```{r fix_reg_sword}
regions_sword <- regions %>% 
  slice(rep(row_number(), 4))%>% 
  filter(rgn_id == 1 | rgn_id == 2 |rgn_id == 4 | rgn_id == 8)

sword <- time_series_assessed %>% 
  filter(is.na(rgn_name),
         stock_long == "swordfish-Northern Atlantic" ) %>% 
  slice(rep(1:n(), each = 4)) %>% 
  select(year, stock_long, ass) %>% 
  cbind(regions_sword)
```

combine all together!
```{r combine_missing_locs}
missing_locations <- rbind(scallop, tile, ros, th_sk, blue_marlin, skip_tuna, white_marlin, salmon, clear_sk, smooth_sk, big_tuna, sail, sword)
```


take all the unknown locations out and bind the new df that has that info
```{r time_series_assessed_2}
time_series_assessed_2 <- time_series_assessed %>% 
  filter(stock_long != "sea scallop-Northwestern Atlantic Coast" & !is.na(rgn_id),
         stock_long != "tilefish-Mid-Atlantic Coast" & !is.na(rgn_id),
         stock_long != "rosette skate-Southern New England / Mid-Atlantic" & !is.na(rgn_id),
         stock_long != "thorny skate-Gulf of Maine" & !is.na(rgn_id),
         stock_long != "blue marlin-Atlantic Ocean" & !is.na(rgn_id),
         stock_long != "skipjack tuna-Western Atlantic" & !is.na(rgn_id),
         stock_long != "white marlin-Atlantic Ocean" & !is.na(rgn_id),
         stock_long != "atlantic salmon-Gulf of Maine" & !is.na(rgn_id),
         stock_long != "clearnose skate-Southern New England / Mid-Atlantic" & !is.na(rgn_id),
         stock_long != "smooth skate-Gulf of Maine" & !is.na(rgn_id),
         stock_long != "bigeye tuna-Atlantic Ocean" & !is.na(rgn_id),
         stock_long != "sailfish-Western Atlantic" & !is.na(rgn_id),
         stock_long != "swordfish-Northern Atlantic" & !is.na(rgn_id)) %>% 
  rbind(missing_locations)
```

Create df for all areas and all years to fill in for years with no assessments later
```{r all_fish}
all_fish<- time_series_assessed_2 %>% 
  select(stock_long, rgn_id, rgn_name) %>% 
  distinct() %>% 
  uncount(13, .id = "n", .remove = F) %>%
  mutate(year = ifelse(n == 1, 2005, n + 2004)) %>%
  select(-n)
```

Combining
```{r all_fish_with_assessments}
assessment_frq  <- all_fish %>% 
  left_join(time_series_assessed_2, by = c("year", "rgn_name", "rgn_id", "stock_long")) %>% 
  distinct() %>% 
  replace(., is.na(.), "0") %>% 
  mutate(ass = as.numeric(ass)) %>% 
  group_by(stock_long) %>% 
  mutate(assesment_sum_5yr = zoo::rollapply(ass, 5, FUN = sum, na.rm = F, partial = T, align = "right"), 
         adeq_assessed = if_else(assesment_sum_5yr >= 1, 1, 0)) %>% 
  ungroup() 
```

## Calculate scores and graph
```{r calculate_ assessed}
number_assessed <- assessment_frq %>% 
  select(stock_long, rgn_id, rgn_name, year) %>% 
  group_by(year, rgn_id, rgn_name) %>% 
  count() %>% 
  rename(number_stocks=n)
  
adeq_ass <- assessment_frq %>% 
  select(stock_long, rgn_id, rgn_name, year, adeq_assessed) %>% 
  group_by(year, rgn_id, rgn_name) %>% 
  dplyr::summarise(adeq_assessed = sum(adeq_assessed))
  
adeq_assessed <- left_join(number_assessed, adeq_ass, by = c("year", "rgn_id", "rgn_name") ) %>% 
  mutate(percent_adeq_ass = adeq_assessed/number_stocks)

write.csv(adeq_assessed, file = "data/adeq_assessed.csv")
```

Visualize
```{r graph}
adq_graph <- ggplot(adeq_assessed)+
  geom_line(aes(x=year, y= percent_adeq_ass, color= rgn_name))

adq_graph
```