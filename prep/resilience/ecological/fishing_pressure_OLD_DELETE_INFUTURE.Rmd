---
title: "OHIEC: Resilience - Fishing Pressure prep"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
toc: true
---

# Summary

This script calculates fishing pressure resilience values by OHINE region. 

# Data

**Reference**: 


**Downloaded**: July, 2019 insert jamie month/year here

**Description**:  


**Time range**: 

**Format**:  Excel spreadsheet


``` {r setup,  message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R')  ### an OHINE specific version of common.R

dir_git <- '~/github/ne-prep'
dir_anx <- file.path(dir_M, 'git-annex/neprep')

library(csv)
library(tidyverse)
library(dplyr)
library(Hmisc)
library(stringi)

```


Data
```{r}

nmfs_stock_assessment_data <- read_csv("Desktop/fp/data/nmfs_stock_assessment_data.csv")
ram_stock_assessment_data <- read_csv("Desktop/fp/data/ram_stock_assessment_data.csv")
nmfs_spatial_catch_by_ohi_rgn <- read_csv("Desktop/fp/data/nmfs_spatial_catch_by_ohi_rgn.csv")
species_lookup_table_catch_stock_assessments <- read_csv("Desktop/fp/data/species_lookup_table_catch_stock_assessments.csv")

nmfs <- nmfs_stock_assessment_data
ram <- ram_stock_assessment_data
nmfs_catch <- nmfs_spatial_catch_by_ohi_rgn 
ass_locations <- species_lookup_table_catch_stock_assessments 

```

Stock Assesment data and years
```{r}
nmfs_clean <- nmfs %>% 
  separate(stock, into = c("species", "location"), sep = " - ") %>%
  select(year, species, location) %>%
  mutate(species = tolower(species),
         location = str_replace(location, " \\| Asmt & Status", ""),
         location = str_replace(location, " \\| Asmt", "")) %>%
  mutate(species = case_when(
    species == "goosefish" ~ "monkfish",
    TRUE ~ as.character(species)
  ))

```


```{r}
ram_clean <- ram %>%
  rename(location = areaname) %>%
  mutate(species = tolower(commonname),
         location = str_replace(as.character(location), "/Mid Atlantic", "/ Mid-Atlantic")) %>%
  select(year, species, location) %>%
  filter(year > 2000)

```

```{r}

both <- nmfs_clean %>%
  full_join(ram_clean, by = c("species", "year", "location")) %>% 
  mutate(species1 = species) %>% 
  unite(stock, c("location", "species1"), sep = " - ")
  

```

Locations and region IDs
```{r}

# Grabbing region IDs for locations

rgnID_loc <- species_lookup_table_catch_stock_assessments

rgnID_loc <- rgnID_loc %>% 
  select(stock_assessment_species_name, stock_assessment_species_location, source, rgn_id, rgn_name) %>% 
  unite(stock, c("stock_assessment_species_location", "stock_assessment_species_name"), sep = " - ")
  
```

Merging stock assesment year data to stock stock assesment location data
```{r}

ass_year <- left_join(both, rgnID_loc, by = "stock") %>% 
  mutate(stock_ass = 1)

##4 stocks without rgn_names or IDs: Guld of Maine - atlantic salmon; Southern New England / Mid-Atlantic - rosette skate; Atlantic Ocean - blue marlin; Western Atlantic - sailfish
```


Tiddying Catch Data
List of all the species caught each year and where
```{r}

# Wrangling catch data into a form that can be compared to the stock assesment data
catch <- nmfs_catch %>% 
  select(year, species, rgn_name) %>% 
  filter(year >= "2005" & year <= "2017") %>% 
  filter(species != "CONFIDENTIAL SPECIES" | species != "UNCLASSIFIED SKATE") %>% 
      ### removed species that are unidentifiable
      ### all below tiddying is to get species name right ex: Surf clam; not CLAM, SURF
  separate(species, c("last", "first"), sep = ", ") %>% 
  filter(first != "SPECIES NOT SPECIFIED") %>% 
  replace(., is.na(.), "") %>% 
  unite(species, c("first", "last"), sep = " ") %>%
  ### looked at the stock assesment data and chose the common name used there
      ## DOUBLE CHECK
  mutate(species = str_trim(species, side = c("left")),
         species = str_replace(species, "WINTER / BLACKBACK FLOUNDER", "WINTER FLOUNDER"),
         species = str_replace(species, "SUMMER / FLUKE FLOUNDER", "SUMMER FLOUNDER"),
         species = str_replace(species, "WITCH / GRAY SOLE FLOUNDER", "WITCH FLOUNDER"),
         species = str_replace(species, "AMERICAN PLAICE /DAB FLOUNDER", "AMERICAN PLAICE"),
         species = str_replace(species, "SAND-DAB / WINDOWPANE / BRILL FLOUNDER", "WINDOWPANE"),
         species = str_replace(species, "SILVER / WHITING HAKE", "SILVER HAKE"),
         species = str_replace(species, "RED / LING HAKE", "RED HAKE"),
         species = str_replace(species, "SPOTTED / SPOTTED SEA TROUT WEAKFISH", "WEAKFISH"),
         species = str_replace(species, "KING / KINGFISH WHITING", "KING WHITING"),
         species = str_replace(species, "LITTLE \\(SUMMER\\) SKATE WINGS" , "LITTLE SKATE"),
         species = str_replace(species, "WINTER \\(BIG\\) SKATE WINGS", "WINTER SKATE"),
         species = str_replace(species, "LITTLE \\(SUMMER\\) SKATE" , "LITTLE SKATE"),
         species = str_replace(species, "WINTER \\(BIG\\) SKATE", "WINTER SKATE"),
         species = tolower(species)) %>% 
   distinct() # this is necesary because some species were under multiple names and they were all changed ot the common name in the NE
 

```

Merging the stock assesment year data with the catch data
```{r}

off <- c("Offshore", "1")

regions <- ass_year %>% 
  select(rgn_name, rgn_id) %>% 
  distinct() %>% 
  filter(rgn_id > 1) %>% 
  rbind(off)


caught_assessed <- left_join(catch, ass_year, by = c("year", "species", "rgn_name")) %>% 
  select(year, species, stock, rgn_name, rgn_id, stock_ass) %>% 
  rename(rgn_id_1 = rgn_id) %>% 
  left_join(regions, by = c("rgn_name")) %>% 
  select(-rgn_id_1) %>% 
  distinct() %>%  ### why are there multiples?? look at species siny dogfish for example
  replace(., is.na(.), "0") # only nas are in the stock assment column from merged

```


Stats
Percent assessed
```{r}

num_spec_caught <- caught_assessed %>% 
  group_by(year, rgn_name, rgn_id) %>% 
  count() %>% 
  rename(spec_caught = n)
num_spec_caught

num_spec_ass <- caught_assessed %>% 
  filter(stock_ass == 0) %>% 
  group_by(year, rgn_name, rgn_id) %>% 
  count() %>% 
  rename(spec_ass = n)
num_spec_ass

percent_ass <- left_join(num_spec_caught, num_spec_ass, by = c("year", "rgn_name", "rgn_id")) %>% 
  mutate(spec_caught = as.numeric(spec_caught),
         spec_ass = as.numeric(spec_ass),
         percent_ass = spec_ass/spec_caught)
percent_ass

```

Frequency Assessed

```{r}
library(plotly)

freq_13years <- caught_assessed %>% 
  filter(stock_ass == 1) %>% 
  group_by(rgn_name, rgn_id, species) %>%
  mutate(stock_ass = as.numeric(stock_ass)) %>% 
  count() %>% 
  mutate(freq_13years = 13/n)  %>% 
  rename(freq_13yr = n) %>% 
  ungroup() %>% 
  mutate(rgn_name = as.factor(rgn_name))

freq_13years  

freq_7years <- caught_assessed %>% 
  filter(year >= 2011) %>% 
  filter(stock_ass == 1) %>% 
  group_by(rgn_name, rgn_id, species) %>%
  mutate(stock_ass = as.numeric(stock_ass)) %>% 
  count() %>% 
  mutate(freq_7years = 7/n)  %>% 
  rename(freq_7yr = n)

freq_7years  

fre13 <- ggplot(freq_13years)+
  geom_point(aes(color= rgn_name, y= freq_13years, x=species))
fre13

fre7 <- ggplot(freq_7years)+
  geom_point(aes(color= rgn_name, y= freq_7years, x=species))
fre7

```




Visualizing
```{r}

percent_ass_gr <- ggplot(percent_ass)+
  geom_line(aes(y= percent_ass, x= year, color=rgn_name))

percent_ass_gr

```



Simplifying catch data for filling in with regs
```{r}

nmfs_spatial_catch_by_ohi_rgn <- read_csv("prep/fis/data/nmfs_spatial_catch_by_ohi_rgn.csv")

species_caught <-nmfs_spatial_catch_by_ohi_rgn %>% 
  filter(year >= 2005 & year <= 2017) %>% 
  select(species, rgn_id, rgn_name) %>% 
  mutate(species = tolower(species)) %>% 
  distinct()

write.csv(species_caught,"data/species_caught.csv")
```





