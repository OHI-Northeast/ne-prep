---
title: 'Preparing stock status data layer derived from the RAM database'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohi-northeast/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      echo = FALSE, message = FALSE, warning = FALSE)

source('~/github/ne-prep/src/R/common.R')  ### an OHINE specific version of common.R

dir_git <- '~/github/ne-prep'
#dir_rgn <- file.path(dir_git, 'prep/regions')  ### github: general buffer region shapefiles
dir_anx <- file.path(dir_M, 'git-annex/neprep')

library(sf)
```

This script filters the RAM database v4.41 for all stocks in the Northeast region and summarizes the available information for each stock.

***
#Data Source

**Downloaded**: August, 2018 (emailed to us)

**Description**:  RAM Legacy Stock Assessment Database provides information on global fish stocks including catch, B/Bmsy and F/Fmsy among other metrics.

**Time range**: pre-1900 to 2015

**Format**:  Tabular

***
  
#Analysis

What assessment information do we have for these stocks?

```{r, fig.height = 10, fig.width = 8}

#RAM data
assessment_data_file <- file.path(dir_M, 'git-annex/globalprep/_raw_data/RAM/d2018/RAM v4.41 (8-20-18)/DB Files With Assessment Data/DBdata (assessment data only).RData')
load(assessment_data_file)

metadata <- as.data.frame(metadata, stringsAsFactors = FALSE)

#filter metadata from RAM to select only those stocks in the Northeast
ne_stocks <- metadata %>%
  filter(region %in% c("US East Coast", "Atlantic Ocean"),
         areaname != "South Atlantic",
         areaname != "Eastern Atlantic")

## get the `tsid` for each of the three metrics we are interested in (B/Bmsy, F/Fmsy and Catch)
params <- as.data.frame(timeseries_ids_views, stringsAsFactors=FALSE) %>%
  filter(stockid %in% ne_stocks$stockid) %>%
  select(stockid, BdivBmsypref, UdivUmsypref, TCbest)

## now join the params table to the ne_stocks table
ne_stocks_metrics <- ne_stocks %>%
  left_join(params) %>%
  gather(key = metric, value = tsid, BdivBmsypref, UdivUmsypref, TCbest) 

### get time series from .Rdata
ts <- as.data.frame(timeseries, stringsAsFactors = FALSE) %>%
  mutate(tsyear  = as.integer(tsyear),
         tsvalue = as.numeric(tsvalue)) %>%
  filter(stockid %in% ne_stocks$stockid) %>%
  inner_join(ne_stocks_metrics, by = c("stockid", "stocklong", "tsid", "assessid")) %>%
  filter(!is.na(tsvalue))

span_df <- ts %>%
  group_by(stocklong, tsid) %>%
  summarize(yr_min = min(tsyear), yr_max = max(tsyear)) %>%
  ungroup() %>%
  mutate(yr_min = ifelse(yr_min < 1980, 1980, yr_min)) %>% ## some stocks have a really long history (e.g. Atlantic Halibut goes back to pre-1900) so I'm reducing the years to only 1980 for plotting purposes
  mutate(metric = case_when(
    tsid %in% c("FdivFmsy-calc-dimensionless", "FdivFmsy - dimensionless", "FdivFmsy-dimensionless", "FdivFmgt-calc-dimensionless", "ERdivERmsy-calc-dimensionless") ~ "F/Fmsy",
    tsid %in% c("SSBdivSSBmsy-calc-dimensionless", "SSBdivSSBmsy-dimensionless", "TBdivTBmsy-dimensionless", "SSBdivSSBmgt-calc-dimensionless", "TBdivTBmsy-calc-dimensionless") ~ "B/Bmsy",
    tsid %in% c("TL-MT", "TC-MT") ~ "Catch"
  ))

stock_ids <- span_df$stocklong %>% unique()

span_plot <- ggplot(span_df, aes(x = stocklong)) +
  #ggtheme_basic +
  theme(panel.border     = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(colour = 'grey90'),
        panel.background = element_blank()) +
  annotate('rect', ymin = 2000, ymax = 2016,
           xmin = first(stock_ids), xmax = last(stock_ids),
           fill = 'red', alpha = .1) +
  geom_linerange(aes(ymin = yr_min, ymax = yr_max, 
                     color = metric),
                 position = position_dodge(width = .5), alpha = .8) +
  scale_color_manual(values = c('red', 'darkgreen', 'blue'),
                       labels=c("B/Bmsy", "Catch", "F/Fmsy")) +
  coord_flip() +
  labs(x = 'RAM Stock',
       y = 'Year',
       color = 'Parameter')

span_plot

```

# Create layer

```{r}

stock_ass_data <- ts %>%
  mutate(metric = 
           case_when(
    tsid %in% c("FdivFmsy-calc-dimensionless", "FdivFmsy - dimensionless", "FdivFmsy-dimensionless", "FdivFmgt-calc-dimensionless", "ERdivERmsy-calc-dimensionless") ~ "F/Fmsy",
    tsid %in% c("SSBdivSSBmsy-calc-dimensionless", "SSBdivSSBmsy-dimensionless", "TBdivTBmsy-dimensionless", "SSBdivSSBmgt-calc-dimensionless", "TBdivTBmsy-calc-dimensionless") ~ "B/Bmsy",
    tsid %in% c("TL-MT", "TC-MT") ~ "Catch")) %>%
  select(stockid, stocklong, year = tsyear, value = tsvalue, scientificname, commonname, areaname, region, metric) %>%
  filter(metric != "Catch")

write.csv(stock_ass_data, file = file.path(dir_calc, "layers/fis_ram_stock_assessment_data.csv"))
```

















