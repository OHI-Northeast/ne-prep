---
title: 'OHI-Northeast: Eelgrass habitat layer'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ne-prep/src/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---

# Summary
This script creates the Eelgrass habitat data layer for the Habitats goal (a sub-goal of Biodiversity). 

# Data

There is not great eelgrass data. For now, we are going to use our pressures data as proxy for eelgrass health.

# Setup

```{r setup, message = F, warning = F}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)
source('~/github/ne-prep/src/R/common.R')
```

# Grab data layers

```{r cw_layers}

#load site info for 05/06 time period
site_info_1 <- readxl::read_excel(file.path(dir_anx, "_raw_data/EPA/nca_siteinformationdata_narschallenge.xlsx")) %>% 
  filter(PSTL_CODE %in% c("MA", "ME", "RI", "NY", "NH", "CT")) %>%
  select(siteID = SITE_ID, WGT_NCA_56)

#load site info for 2010 time period
site_info_2 <- read_csv(file.path(dir_anx, "_raw_data/EPA/assessed_ncca2010_siteinfo.revised.06212016.csv")) %>%
  filter(STATE %in% c("MA", "ME", "RI", "NY", "NH", "CT"),
         NCA_REGION == "East Coast") %>%
  select(siteID = SITE_ID, WGT_NCCA10)

#load WQI data for 05/06
water_old <- readxl::read_excel(file.path(dir_anx, "_raw_data/EPA/nca_waterchemdata_narschallenge.xlsx")) %>% 
  filter(PSTL_CODE %in% c("MA", "ME", "RI", "NY", "NH", "CT")) %>%
  select(siteID = SITE_ID, nitrogen = `DIN Cond`, clarity = `Trans Cond`, LON_DD, LAT_DD, PSTL_CODE, Year = SAMPYEAR) %>%
  left_join(site_info_1)

#load WQI data for 2010
water_new <- read_csv(file.path(dir_anx, "_raw_data/EPA/ncca2010_water_quality_indicator_status.csv")) %>%
  filter(PSTL_CODE %in% c("MA", "ME", "RI", "NY", "NH", "CT"),
         NCCA_REG == "Northeast") %>%
  select(siteID = SITE_ID, nitrogen = DIN_COND, clarity = TRANS_COND, LON_DD, LAT_DD, PSTL_CODE) %>%
  mutate(Year = 2010) %>%
  left_join(site_info_2)
```


Combining both datasets and assigning the time periods for each. If the year is 2000 or 2001, that's time period 1. 2005-2006 is time period 2 and 2010 is time period 3.

```{r combine_data}
wqi <- water_old %>%
  bind_rows(water_new) %>%
  mutate(time_period = 
           case_when(
             Year %in% c(2000, 2001) ~ 1,
             Year %in% c(2005, 2006) ~ 2,
             Year == 2010 ~ 3
           )) %>%
  filter(time_period != 1) #remove earlier time period
```

Now assign OHI region names or ids to each of the sites. For the most part, the State in the WQI data is the region, but for Massachusetts we need to be specific about what region the sites belong to. The best way to do this is manually so I use `mapview::mapview()` to identify sites in MA and assign to either Massachusetts-Gulf of Maine or Massachusetts-Virginian.

Look first just at sites identified by the `MA` postal code.

```{r ma_sites}
#filter wqi for sites only in MA
ma <- wqi %>%
  filter(PSTL_CODE == "MA")

#create a simple features (sf) object from the coordinates contained in the dataset
ma_points = st_as_sf(ma, coords = c("LON_DD", "LAT_DD"), 
                 crs = 4326)
#plot
ggplot() +
  geom_sf(data = rgns %>% filter(rgn_id %in% c(7,8)), aes(fill = rgn_id)) +
  geom_sf(data = ma_points, color = 'darkgreen') +
  theme_bw()
```
```{r}
int <- ma_points %>%
  st_transform('+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=37.5 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs') %>%
  st_intersection(rgns)


#find sites that are not in the intersection
s <- setdiff(ma_points$siteID, int$siteID)

#limit to just the missing sites
miss <- ma_points %>%
  filter(siteID %in% s)

miss_gf <- miss %>%
  data.frame() %>%
  mutate(rgn_id = 
           case_when(
             siteID == "NCCA10-1023" ~ 7,
             siteID == "MA05-0006" ~ 7,
             siteID == "MA06-0048" ~ 7,
             siteID == "MA06-0026" ~ 8,
             siteID == "NCCA10-1009" ~ 8,
             siteID == "MA06-0042" ~ 8,
             siteID == "NCCA10-1011" ~ 8,
             siteID == "MA05-0009" ~ 8,
             siteID == "NCCA10-1001" ~ 8,
             siteID == "NCCA10-1058" ~ 8,
             siteID == "NCCA10-1008" ~ 8,
             siteID == "NCCA10-2001" ~ 8,
             siteID == "RI05-0025" ~ 8
           )) %>%
  select(-geometry)
```

Take the info from `int` that we want and combine with these missing sites

```{r}
ma_df <- int %>%
  data.frame() %>%
  select(-area_km2, -geometry, -rgn_name) %>%
  bind_rows(miss_gf)
```

Additional data cleaning that adds the Massachusetts sites back in and removes the few sites that are actually in the George's Bank area.

```{r clean_wqi_data}
wqi_clean <- wqi %>%
  mutate(rgn_name = 
           case_when(
             PSTL_CODE == "ME" ~ "Maine",
             PSTL_CODE == "RI" ~ "Rhode Island",
             PSTL_CODE == "NY" ~ "New York",
             PSTL_CODE == "CT" ~ "Connecticut",
             PSTL_CODE == "NH" ~ "New Hampshire",
             PSTL_CODE == "MA" ~ "NA"
           )) %>%
  left_join(rgn_data) %>%
  left_join(ma_df, by = c("siteID", "time_period", "Year", "nitrogen", "clarity", "PSTL_CODE")) %>%
  mutate(rgn_id = ifelse(is.na(rgn_id.x), rgn_id.y, rgn_id.x)) %>%
  select(-rgn_id.x, -rgn_id.y, -rgn_name, -state.x, -state.y, -area_km2, -WGT_NCA_56.y, -WGT_NCCA10.y) %>%
  left_join(rgn_data) %>%
  select(-area_km2) %>%
  filter(rgn_name != "Georges Bank") %>%
  rename(WGT_NCA_56 = WGT_NCA_56.x,
         WGT_NCCA10 = WGT_NCCA10.x) %>%
  filter(Year > 2004) %>% #remove the early years
  as.data.frame()
  # mutate(rgn_name = ifelse(rgn_id == 2, "Massachusetts-Virginian", rgn_name),  ### added this in if we want to turn GB sites to MA
  #        state = ifelse(rgn_id == 2, NA, state),
  #        rgn_id = ifelse(rgn_id == 2, 8, rgn_id))
```

Use the [`spsurvey`](https://www.rdocumentation.org/packages/spsurvey/versions/3.4) package to run `cat.analysis` and produce a sub-population estimate that incorporates site weights. 

We also are going to split out the nitrogen and water clarity data.

We remove all sites that have `MISSING` as a status. In this data, New York has 5%, New Hampshire has 3.5% and Maine has 2% missing.

In 2010 only New York has missing sites, a total of 3.35% of area.

**For now I will ignore the MISSING sites**

```{r cat_analysis_0506}
library(spsurvey)
```

```{r}
#select just 0506 data
wqi_0506_din <- wqi_clean %>% 
  select(-clarity) %>%
  filter(Year < 2007, nitrogen != "MISSING")

# Create the required data frames
sites <- wqi_0506_din %>%
          select(siteID) %>%
          mutate(use = rep(TRUE, nrow(.)))
subpop <- wqi_0506_din %>%
          select(siteID, rgn_name)
design <- wqi_0506_din %>%
          select(siteID,
                 wgt = WGT_NCA_56,
                 xcoord = LON_DD,
                 ycoord = LAT_DD)
data <- wqi_0506_din %>%
        select(siteID, nitrogen)

## from this output we only want to grab. Estimate.P is the percent of area (e.g. 98%) for the coastal waters of a subpopulation (e.g. Maine) in a particular category of condition (e.g. Good)
Water_Column_Status_Estimates_0506_din <- cat.analysis(sites, subpop, design, data) %>%
  select(rgn_name = Subpopulation, Category, perc = Estimate.P) %>%
  mutate(cat_score = 
      case_when(
        Category == "POOR" ~ 0,
        Category == "FAIR" ~ 50,
        Category == "GOOD" ~ 100),
      year = 2006)
```

Do the same for water clarity

```{r}
#select just 0506 data
wqi_0506_wc <- wqi_clean %>% 
  select(-nitrogen) %>%
  filter(Year < 2007, clarity != "MISSING")

# Create the required data frames
sites <- wqi_0506_wc %>%
          select(siteID) %>%
          mutate(use = rep(TRUE, nrow(.)))
subpop <- wqi_0506_wc %>%
          select(siteID, rgn_name)
design <- wqi_0506_wc %>%
          select(siteID,
                 wgt = WGT_NCA_56,
                 xcoord = LON_DD,
                 ycoord = LAT_DD)
data <- wqi_0506_wc %>%
        select(siteID, clarity)

## from this output we only want to grab. Estimate.P is the percent of area (e.g. 98%) for the coastal waters of a subpopulation (e.g. Maine) in a particular category of condition (e.g. Good)
Water_Column_Status_Estimates_0506_wc <- cat.analysis(sites, subpop, design, data) %>%
  select(rgn_name = Subpopulation, Category, perc = Estimate.P) %>%
  mutate(cat_score = 
      case_when(
        Category == "POOR" ~ 0,
        Category == "FAIR" ~ 50,
        Category == "GOOD" ~ 100),
      year = 2006)
```


Do the same `cat.analysis` but for 2010 data. First for nitrogen.

```{r cat_analysis_2010}
# Create the required data frames
wqi_2010_din <- wqi_clean %>% 
  filter(Year == 2010, nitrogen != "MISSING")

sites <- wqi_2010_din %>%
          select(siteID) %>%
          mutate(use = rep(TRUE, nrow(.)))
subpop <- wqi_2010_din %>%
          select(siteID, rgn_name)
design <- wqi_2010_din %>%
          select(siteID,
                 wgt = WGT_NCCA10,
                 xcoord = LON_DD,
                 ycoord = LAT_DD)
data <- wqi_2010_din %>%
        select(siteID, nitrogen)

## from this output we only want to grab. Estimate.P is the percent of area (e.g. 98%) for the coastal waters of a subpopulation (e.g. Maine) in a particular category of condition (e.g. Good)
Water_Column_Status_Estimates_2010_din <- cat.analysis(sites, subpop, design, data) %>%
  select(rgn_name = Subpopulation, Category, perc = Estimate.P) %>%
  mutate(cat_score = 
      case_when(
        Category == "POOR" ~ 0,
        Category == "FAIR" ~ 50,
        Category == "GOOD" ~ 100),
      year = 2010) 
```

Then for water clarity.

```{r cat_analysis_2010}
# Create the required data frames
wqi_2010_wc <- wqi_clean %>% 
  filter(Year == 2010, clarity != "MISSING")

sites <- wqi_2010_wc %>%
          select(siteID) %>%
          mutate(use = rep(TRUE, nrow(.)))
subpop <- wqi_2010_wc %>%
          select(siteID, rgn_name)
design <- wqi_2010_wc %>%
          select(siteID,
                 wgt = WGT_NCCA10,
                 xcoord = LON_DD,
                 ycoord = LAT_DD)
data <- wqi_2010_wc %>%
        select(siteID, clarity)

## from this output we only want to grab. Estimate.P is the percent of area (e.g. 98%) for the coastal waters of a subpopulation (e.g. Maine) in a particular category of condition (e.g. Good)
Water_Column_Status_Estimates_2010_wc <- cat.analysis(sites, subpop, design, data) %>%
  select(rgn_name = Subpopulation, Category, perc = Estimate.P) %>%
  mutate(cat_score = 
      case_when(
        Category == "POOR" ~ 0,
        Category == "FAIR" ~ 50,
        Category == "GOOD" ~ 100),
      year = 2010) 
```

## Create layer

Aggregate by region and get WQI scores

```{r wqi_layer_rgn_scores}
#nitrogen
wqi_rgns_din <- Water_Column_Status_Estimates_0506_din %>%
  rbind(Water_Column_Status_Estimates_2010_din) %>%
  mutate(score = cat_score * (perc/100)) %>%
  filter(Category != "Total") %>%
  group_by(rgn_name, year) %>%
  summarize(wqi_score = sum(score))

#water clarity
wqi_rgns_wc <- Water_Column_Status_Estimates_0506_wc %>%
  rbind(Water_Column_Status_Estimates_2010_wc) %>%
  mutate(score = cat_score * (perc/100)) %>%
  filter(Category != "Total") %>%
  group_by(rgn_name, year) %>%
  summarize(wqi_score = sum(score))

write_csv(wqi_rgns_din, "data/wqi_din_score_rgns.csv")
write_csv(wqi_rgns_wc, "data/wqi_clarity_score_rgns.csv")

ggplot(wqi_rgns_din, aes(x = year, y = wqi_score, color = rgn_name)) +
  geom_line() +
  theme_bw() +
  labs(x = "Year",
       y = "Score",
       color = "Region",
       title = "Dissolved Inorganic Nitrogen")

ggplot(wqi_rgns_wc, aes(x = year, y = wqi_score, color = rgn_name)) +
  geom_line() +
  theme_bw() +
  labs(x = "Year",
       y = "Score",
       color = "Region",
       title = "Water Clarity")
```

## Gap-filling

The plot has guessed the values between 2006 and 2010 but we need to actually assign these before saving this layer. We will assume a simple linear interpolation between years.

```{r gapfill, eval = F}
df_gf_din <- wqi_rgns_din %>%
  complete(year = 2006:2010) %>%
  group_by(rgn_name) %>%
  mutate(score = zoo::na.approx(wqi_score),
         gapfilled = ifelse(is.na(wqi_score), 1, 0),
         metric = "nitrogen")

write_csv(df_gf_din, "data/wqi_din_score_rgn_gf.csv")

df_gf_wc <- wqi_rgns_wc %>%
  complete(year = 2006:2010) %>%
  group_by(rgn_name) %>%
  mutate(score = zoo::na.approx(wqi_score),
         gapfilled = ifelse(is.na(wqi_score), 1, 0),
         metric = "clarity")

write_csv(df_gf_wc, "data/wqi_wc_score_rgn_gf.csv")
```

## Save layer for toolbox

I need to attach region ID's to each row. I also add the offshore regions 1:4 with NA values for the toolbox to run. 

```{r save_layer, eval = F}
other_rgns <- data.frame(year     = rep(2006:2010, each = 4),
                         rgn_id   = c(1,2,3,4),
                         rgn_name = c("Offshore", "Georges Bank", "Gulf of Maine", "Mid-Atlantic Bight"),
                         score = NA,
                         metric = NA)

out <- df_gf_din %>%
  bind_rows(df_gf_wc) %>%
  left_join(rgn_data) %>%
  select(year, rgn_id, rgn_name, score, metric) %>%
  bind_rows(other_rgns) %>%
  write_csv(file.path(dir_calc, "layers/hab_eelgrass.csv"))
```



